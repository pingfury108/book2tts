{% extends "base.html" %}
{% load static custom_filters %}

{% block title %}{{ segment.title }} - 音频详情 - Book2TTS{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="mb-4 sm:mb-6">
    <a href="{% url 'home' %}" class="btn btn-ghost btn-sm gap-2">
      <i class="fas fa-arrow-left"></i>
      返回列表
    </a>
  </div>

  <!-- 顶部区域: 标题、书名和播放按钮 -->
  <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start bg-base-100 p-4 sm:p-6 rounded-lg shadow-md mb-6 sm:mb-8 gap-4">
    <div class="flex-grow">
      <span class="font-medium text-sm sm:text-base text-base-content/80 break-words break-all">{{ segment.book.name }}</span>
      <h1 class="text-2xl sm:text-3xl font-bold text-base-content mb-2 leading-tight break-words break-all">{{ segment.title }}</h1>
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 text-xs sm:text-sm text-base-content/70">
        <div class="flex items-center">
          <i class="fas fa-calendar-alt mr-1"></i>
          {{ segment.updated_at|date:"Y-m-d H:i" }}
        </div>
        {% if segment.book.user.profile.rss_token %}
        <a href="{% url 'token_audio_rss_feed' token=segment.book.user.profile.rss_token|stringformat:'s' %}" class="flex items-center cursor-pointer text-purple-700 hover:text-purple-800" title="作者 RSS 订阅">
          <i class="fas fa-rss mr-1"></i>
          <span>全部RSS</span>
        </a>
        {% endif %}
        {% if segment.book.user.profile.rss_token %}
        <a href="{% url 'token_book_audio_rss_feed' token=segment.book.user.profile.rss_token|stringformat:'s' book_id=segment.book.id %}" class="flex items-center cursor-pointer text-purple-700 hover:text-purple-800" title="此书的 RSS 订阅">
          <i class="fas fa-rss mr-1"></i>
          <span>此书RSS</span>
        </a>
        {% endif %}
      </div>
    </div>
    <div class="flex flex-wrap gap-2 justify-center lg:justify-end">
      <button 
        class="btn btn-circle btn-primary btn-lg play-audio-btn hover:scale-105 transition-transform" 
        data-audio-url="{{ segment.file.url }}"
        data-audio-title="{{ segment.title }}"
        data-subtitle-url="{% if segment.subtitle_file and segment.subtitle_file.name %}{{ segment.subtitle_file.url }}{% endif %}"
        data-chapters-url="{% if segment.chapters_file and segment.chapters_file.name %}{{ segment.chapters_file.url }}{% endif %}"
      >
        <i class="fas fa-play text-white text-2xl"></i>
      </button>
      
      <!-- 音频下载按钮 -->
      <a href="{% url 'download_audio' segment_type=segment_type segment_id=segment.id %}" class="btn btn-primary btn-lg" download>
        <i class="fas fa-download"></i>
        <span class="hidden sm:inline ml-2">下载音频</span>
      </a>

      <!-- 字幕下载和查看按钮 -->
      {% if segment.subtitle_file and segment.subtitle_file.name %}
      <div class="flex gap-2">
        <a href="{% url 'download_subtitle' segment_type=segment_type segment_id=segment.id %}" class="btn btn-secondary btn-lg" download>
          <i class="fas fa-download"></i>
          <span class="hidden sm:inline ml-2">下载字幕</span>
        </a>
        <button id="toggle-subtitles-btn" class="btn btn-outline btn-lg">
          <i class="fas fa-closed-captioning"></i>
          <span class="hidden sm:inline ml-2">查看字幕</span>
        </button>
      </div>
      {% endif %}
    </div>
  </div>

  {% if segment.chapters %}
  <div class="bg-base-100 p-4 sm:p-6 rounded-lg shadow-md mb-6 sm:mb-8">
    <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center">
      <i class="fas fa-list mr-2"></i>
      章节导航
    </h2>
    <div class="space-y-3">
      {% for chapter in segment.chapters %}
      <button
        class="w-full text-left p-3 rounded-lg border border-base-200 hover:border-primary hover:bg-primary/10 transition chapter-jump-btn"
        data-chapter-start="{{ chapter.start_seconds }}"
      >
        <div class="flex items-center justify-between gap-3">
          <span class="badge badge-primary badge-outline text-xs sm:text-sm">{{ chapter.start_seconds|format_seconds }}</span>
          <span class="font-semibold text-base-content flex-1">{{ chapter.title }}</span>
          <i class="fas fa-play text-primary"></i>
        </div>
        {% if chapter.summary %}
        <p class="mt-2 text-sm text-base-content/70 leading-relaxed">{{ chapter.summary }}</p>
        {% endif %}
      </button>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- 字幕显示区域 -->
  {% if segment.subtitle_file and segment.subtitle_file.name %}
  <div id="subtitles-container" class="bg-base-100 p-4 sm:p-6 rounded-lg shadow-md mb-6 sm:mb-8 hidden">
    <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center">
      <i class="fas fa-closed-captioning mr-2"></i>
      字幕内容
    </h2>
    <div id="subtitles-content" class="prose max-w-none">
      <div class="text-center text-gray-500">
        <i class="fas fa-spinner fa-spin mr-2"></i>
        加载字幕中...
      </div>
    </div>
  </div>
  {% endif %}

  <!-- 文本内容区域 -->
  <div class="bg-base-100 p-4 sm:p-6 rounded-lg shadow-md mb-6 sm:mb-8">
    <h2 class="text-lg sm:text-xl font-bold mb-4">
      {% if segment_type == 'dialogue_script' %}
        原始文本内容
      {% else %}
        音频文本内容
      {% endif %}
    </h2>
    <div class="prose max-w-none">
      <p class="whitespace-pre-line text-sm sm:text-base leading-relaxed text-base-content/80">
        {% if segment_type == 'dialogue_script' %}
          {{ segment.original_text }}
        {% else %}
          {{ segment.text }}
        {% endif %}
      </p>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
{% if segment.chapters %}
{{ segment.chapters|json_script:"segment-chapters-data" }}
{% endif %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const playerContainer = document.getElementById('audio-player-container');
    const audioPlayerMobile = document.getElementById('audio-player-mobile');
    const audioPlayerDesktop = document.getElementById('audio-player-desktop');
    const audioTitleMobile = document.getElementById('audio-title-mobile');
    const audioTitleDesktop = document.getElementById('audio-title-desktop');
    const closePlayerMobile = document.getElementById('close-player-mobile');
    const closePlayerDesktop = document.getElementById('close-player-desktop');
    const playButtons = document.querySelectorAll('.play-audio-btn');
    const toggleSubtitlesBtn = document.getElementById('toggle-subtitles-btn');
    const subtitlesContainer = document.getElementById('subtitles-container');
    const subtitlesContent = document.getElementById('subtitles-content');
    const chapterButtons = document.querySelectorAll('.chapter-jump-btn');
    const primaryPlayBtn = document.querySelector('.play-audio-btn');
    const defaultAudioUrl = primaryPlayBtn ? primaryPlayBtn.dataset.audioUrl : null;
    const chaptersDataElement = document.getElementById('segment-chapters-data');
    const defaultChapters = chaptersDataElement ? JSON.parse(chaptersDataElement.textContent) : [];
    const defaultChaptersUrl = primaryPlayBtn ? (primaryPlayBtn.dataset.chaptersUrl || '') : '';
    
    // 字幕功能
    let subtitlesLoaded = false;
    
    if (toggleSubtitlesBtn && subtitlesContainer) {
      toggleSubtitlesBtn.addEventListener('click', function() {
        if (subtitlesContainer.classList.contains('hidden')) {
          // 显示字幕
          subtitlesContainer.classList.remove('hidden');
          this.classList.add('btn-active');
          this.querySelector('span').textContent = '隐藏字幕';
          
          // 如果还没加载过字幕，则加载
          if (!subtitlesLoaded) {
            loadSubtitles();
          }
        } else {
          // 隐藏字幕
          subtitlesContainer.classList.add('hidden');
          this.classList.remove('btn-active');
          this.querySelector('span').textContent = '查看字幕';
        }
      });
    }
    
    // 加载字幕内容
    function loadSubtitles() {
      const subtitleUrl = '{% if segment.subtitle_file and segment.subtitle_file.name %}{{ segment.subtitle_file.url }}{% endif %}';
      if (!subtitleUrl) return;
      
      fetch(subtitleUrl)
        .then(response => response.text())
        .then(subtitleText => {
          subtitlesContent.innerHTML = formatSubtitles(subtitleText);
          subtitlesLoaded = true;
        })
        .catch(error => {
          subtitlesContent.innerHTML = `
            <div class="text-center text-red-500">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              加载字幕失败
            </div>
          `;
        });
    }
    
    // 格式化字幕内容
    function formatSubtitles(srtText) {
      if (!srtText.trim()) {
        return '<div class="text-center text-gray-500">暂无字幕内容</div>';
      }
      
      // 解析SRT格式字幕
      const entries = srtText.trim().split('\n\n');
      let html = '<div class="space-y-3">';
      
      entries.forEach(entry => {
        const lines = entry.trim().split('\n');
        if (lines.length >= 3) {
          const number = lines[0];
          const timestamp = lines[1];
          let text = lines.slice(2).join('\n');
          
          // 清理多余空格
          text = cleanSubtitleText(text);
          
          html += `
            <div class="border-l-4 border-primary pl-4 py-2">
              <div class="text-xs text-gray-500 mb-1">${timestamp}</div>
              <div class="text-sm leading-relaxed">${text}</div>
            </div>
          `;
        }
      });
      
      html += '</div>';
      return html;
    }
    
    // 清理字幕文本中的多余空格
    function cleanSubtitleText(text) {
      // 去除所有空格
      text = text.replace(/\s+/g, '');
      
      return text;
    }

    function jumpToChapter(startSeconds) {
      if (!window.globalAudioPlayer || !primaryPlayBtn || !defaultAudioUrl) {
        return;
      }

      const player = window.globalAudioPlayer;
      const seekToChapter = () => {
        player.player.currentTime = Math.max(0, startSeconds);
        player.lastChapterUpdateTs = 0;
        player.updateChapterHighlight({ scrollIntoView: true, force: true });
        player.saveState();
        if (player.player.paused) {
          player.player.play().catch((err) => player.handlePlayError(err));
        }
      };

      if (!player.currentAudio || player.currentAudio.url !== defaultAudioUrl) {
        player.player.addEventListener('loadedmetadata', () => {
          seekToChapter();
        }, { once: true });
        primaryPlayBtn.click();
      } else if (player.player.readyState >= 1) {
        seekToChapter();
      } else {
        player.player.addEventListener('loadedmetadata', () => {
          seekToChapter();
        }, { once: true });
      }
    }

    if (chapterButtons.length) {
      chapterButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const start = parseFloat(btn.dataset.chapterStart || '0');
          if (!isNaN(start)) {
            jumpToChapter(start);
          }
        });
      });
    }
    
    // 使用全局播放器播放音频
    playButtons.forEach(button => {
      button.addEventListener('click', function() {
        const audioUrl = this.getAttribute('data-audio-url');
        const title = this.getAttribute('data-audio-title');
        const subtitleUrl = this.getAttribute('data-subtitle-url');
        const chapterUrl = this.getAttribute('data-chapters-url') || defaultChaptersUrl;
        const chapterOptions = {
          chapters: defaultChapters,
          chaptersUrl: chapterUrl || null
        };
        
        if (window.globalAudioPlayer) {
          // 如果有字幕文件，加载字幕
          if (subtitleUrl) {
            fetch(subtitleUrl)
              .then(response => response.text())
              .then(srtContent => {
                const subtitles = window.globalAudioPlayer.parseSRTSubtitles(srtContent);
                window.globalAudioPlayer.playAudio(audioUrl, title, subtitles, chapterOptions);
              })
              .catch(() => {
                // 如果字幕加载失败，仍然播放音频
                window.globalAudioPlayer.playAudio(audioUrl, title, null, chapterOptions);
              });
          } else {
            // 无字幕文件，直接播放
            window.globalAudioPlayer.playAudio(audioUrl, title, null, chapterOptions);
          }
        } else {
          console.error('全局播放器未初始化');
        }
      });
    });
  });
</script>
{% endblock %} 
