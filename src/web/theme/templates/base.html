{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <title>{% block title %}Book2TTS - 文本转语音和有声书制作平台{% endblock %}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Book2TTS - 专业的在线文本转语音工具，支持EPUB、PDF、扫描PDF等多种格式转换，提供高质量有声书制作、多音色对话生成、SRT字幕支持和音频内容管理服务">
    <meta name="keywords" content="文本转语音,TTS,有声书制作,EPUB转音频,PDF转语音,扫描PDF转语音,SRT字幕,音频字幕,音频生成,对话脚本,音色角色,音频队列,RSS订阅,MP3,WAV,音频格式">
    <meta name="format-detection" content="telephone=no">
    <meta name="robots" content="index, follow">
    <meta name="language" content="zh-CN">
    <meta name="revisit-after" content="7 days">
    {% if CSS_VERSION %}
    {% tailwind_css v=CSS_VERSION %}
    {% else %}
    {% tailwind_css %}
    {% endif %}
    {% load static %}
    <script>
      (function() {
        try {
          const storedTheme = localStorage.getItem('theme');
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme = storedTheme || (prefersDark ? 'dark' : 'light');
          document.documentElement.setAttribute('data-theme', theme);
        } catch (err) {
          console.warn('Theme initialization failed', err);
        }
      })();
    </script>
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <!-- Font Awesome Local -->
    <link rel="stylesheet" href="{% static 'fontawesome-free-6.7.2-web/css/all.min.css' %}">
    <script src="{% static 'htmx.min.js' %}"></script>
    <script src="{% static 'jquery.min.js' %}"></script>

    <!-- RSS 订阅链接 -->
    {% if user.is_authenticated and user.profile.rss_token %}
    <link rel="alternate" type="application/rss+xml" title="{{ user.username }}的Book2TTS音频"
        href="{% url 'token_audio_rss_feed' token=user.profile.rss_token|stringformat:'s' %}" />
    {% endif %}
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7326790660929371" crossorigin="anonymous"></script>
</head>

<body class="flex flex-col min-h-screen">
    <div class="navbar bg-base-100">
        <div class="navbar-start">
            <div class="dropdown">
                <div tabindex="0" role="button" class="btn btn-ghost lg:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h8m-8 6h16" />
                    </svg>
                </div>
                <ul tabindex="0"
                    class="menu menu-sm dropdown-content bg-base-100 rounded-box z-50 mt-3 w-52 p-2 shadow">
                    <li><a href="{% url 'index' %}">制作</a></li>
                    <li>
                        <a>有声书</a>
                        <ul class="p-2">
                            <li><a href="{% url 'aggregated_audio_segments' %}">成品</a></li>
                            <li><a href="{% url 'task_queue' %}">队列</a></li> 
                            <li><a href="{% url 'dialogue_list' %}">对话脚本</a></li>
                        </ul>
                    </li>
                    <li><a href="{% url 'my_upload' %}">我的上传</a></li>
                    <li><a href="{% url 'about' %}">关于</a></li>
                </ul>
            </div>
            <a class="btn btn-ghost text-xl" href="/">Book2TTS</a>
        </div>
        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><a href="{% url 'index' %}">制作</a></li>
                <li>
                    <details data-nav-details="audiobook">
                        <summary>有声书</summary>
                        <ul class="p-2 z-50 relative">
                            <li><a href="{% url 'aggregated_audio_segments' %}">成品</a></li>
                            <li><a href="{% url 'task_queue' %}">队列</a></li> 
                            <li><a href="{% url 'dialogue_list' %}">对话脚本</a></li>
                        </ul>
                    </details>
                </li>
                <li><a href="{% url 'my_upload' %}">我的上传</a></li>
                <li><a href="{% url 'about' %}">关于</a></li>
            </ul>
        </div>
        <div class="navbar-end gap-2">
            <button id="theme-toggle"
                    class="btn btn-ghost btn-circle"
                    aria-label="切换主题"
                    title="切换主题">
                <i class="fas fa-sun" id="theme-toggle-icon"></i>
            </button>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div class="w-10 rounded-full">
                        {% if user.is_authenticated %}
                        <div class="bg-primary text-primary-content flex items-center justify-center h-full w-full">
                            <span class="text-lg font-bold">{{ user.username|slice:":2"|upper }}</span>
                        </div>
                        {% else %}
                        <div class="bg-gray-300 text-gray-600 flex items-center justify-center h-full w-full">
                            <span class="text-lg font-bold">?</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <ul tabindex="0"
                    class="menu menu-sm dropdown-content bg-base-100 rounded-box z-50 mt-3 w-52 p-2 shadow">
                    {% if user.is_authenticated %}
                    <li>
                        <a href="{% url 'profile' %}" class="justify-between">
                            个人资料
                            <span class="badge">{{ user.username }}</span>
                        </a>
                    </li>
                    <li><a>设置</a></li>
                    <li><a href="{% url 'logout' %}">登出</a></li>
                    {% else %}
                    <li><a href="{% url 'login' %}">登录</a></li>
                    <li><a href="{% url 'register' %}">注册</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <main class="flex-grow mb-2">
        {% block content %}
        {% endblock %}
    </main>

    <!-- 全局音频播放器 - 固定在页面底部 -->
    <div id="global-audio-player"
        class="fixed bottom-0 left-0 right-0 bg-base-100 shadow-2xl border-t border-base-300 z-50 transform translate-y-full transition-transform duration-300"
        style="display: none;">
        <!-- 关闭按钮 - 整个播放组件的右上角 -->
        <button id="close-player-btn"
            class="absolute top-2 right-2 btn btn-ghost btn-circle btn-xs z-20 hover:bg-base-200">
            <i class="fas fa-times text-xs opacity-60 hover:opacity-100"></i>
        </button>

        <div class="container mx-auto px-2 sm:px-4 py-3 pr-10 relative">
            <!-- 字幕显示区域 -->
            <div id="subtitle-container" class="mb-3 h-12 flex items-center justify-center">
                <div id="subtitle-text"
                    class="text-center text-sm sm:text-base font-medium text-base-content bg-base-200 rounded-lg px-4 py-2 min-h-[2rem] flex items-center justify-center opacity-60 transition-opacity duration-300">
                    <span class="italic text-base-content/60">暂无字幕</span>
                </div>
            </div>

            <!-- 播放器控制区域 -->
            <div class="flex items-center gap-2 sm:gap-3">
                <!-- 播放/暂停按钮 -->
                <button id="global-play-btn" class="btn btn-circle btn-sm sm:btn-md btn-primary flex-shrink-0">
                    <i class="fas fa-play text-sm"></i>
                </button>

                <!-- 章节按钮 -->
                <div class="relative flex-shrink-0">
                    <button id="global-chapter-btn"
                        class="btn btn-circle btn-sm sm:btn-md btn-ghost text-base-content/70 hover:text-base-content hidden relative"
                        title="章节列表">
                        <i class="fas fa-list-ul text-sm"></i>
                        <span id="global-chapter-availability"
                            class="hidden absolute top-1 right-1 w-2.5 h-2.5 rounded-full bg-primary shadow-md"></span>
                    </button>

                    <!-- 章节列表面板 -->
                    <div id="global-chapter-panel"
                        class="hidden absolute bottom-full mb-3 left-1/2 -translate-x-1/2 w-56 sm:w-72 max-h-72 sm:max-h-80 overflow-hidden border border-base-300 bg-base-200 rounded-xl shadow-xl">
                        <div class="px-3 py-2 border-b border-base-300">
                            <div class="text-[11px] uppercase tracking-wide font-semibold text-base-content/60">章节导航</div>
                            <div class="flex items-center gap-3 mt-1 text-xs text-base-content/70">
                                <span id="global-chapter-active-title" class="flex-1 font-medium text-base-content truncate">未选择章节</span>
                                <span id="global-chapter-active-time" class="font-mono text-[11px] text-base-content/60">0:00</span>
                            </div>
                        </div>
                        <ul id="global-chapter-list" class="max-h-60 sm:max-h-64 overflow-y-auto divide-y divide-base-300">
                            <li class="px-3 py-2 text-sm text-base-content/60">暂无章节</li>
                        </ul>
                    </div>
                </div>

                <!-- 音频信息 - 紧凑布局 -->
                <div class="flex-shrink-0 min-w-0 max-w-xs">
                    <div id="global-audio-title" class="text-sm sm:text-base font-medium truncate">未选择音频</div>
                    <div class="flex items-center gap-1 text-xs text-base-content/60">
                        <span id="current-time">0:00</span>
                        <span>/</span>
                        <span id="total-time">0:00</span>
                    </div>
                </div>

                <!-- 进度条 - 扩展到左侧占用更多空间 -->
                <div class="flex-1 mx-3 sm:mx-4">
                    <input type="range" id="progress-slider" class="range range-primary range-xs sm:range-sm w-full"
                        min="0" max="100" value="0" step="0.1">
                </div>

                <!-- 音量控制 - 移动到右侧紧凑排列 -->
                <div class="hidden sm:flex items-center gap-1 flex-shrink-0">
                    <i class="fas fa-volume-up text-base-content/60 text-xs"></i>
                    <input type="range" id="volume-slider" class="range range-primary range-xs w-12" min="0" max="100"
                        value="80">
                </div>
            </div>

            <!-- 隐藏的实际audio元素 -->
            <audio id="global-audio" preload="metadata"></audio>
        </div>
    </div>

    <footer class="footer footer-center text-base-content">
        <aside>
            <p>Copyright © {% now "Y" %} pingfury - All rights reserved</p>
        </aside>
    </footer>

    {% block script %}
    {% endblock %}

    <!-- 主题切换脚本 -->
    <script>
      (function() {
        const toggleBtn = document.getElementById('theme-toggle');
        const icon = document.getElementById('theme-toggle-icon');
        const themes = ['light', 'dark'];

        function updateIcon(theme) {
          if (!icon) return;
          icon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function setTheme(theme, persist = true) {
          document.documentElement.setAttribute('data-theme', theme);
          updateIcon(theme);
          if (persist) {
            try {
              localStorage.setItem('theme', theme);
            } catch (err) {
              console.warn('Failed to persist theme', err);
            }
          }
        }

        function getStoredTheme() {
          try {
            return localStorage.getItem('theme');
          } catch (err) {
            return null;
          }
        }

        const storedTheme = getStoredTheme();
        if (storedTheme) {
          setTheme(storedTheme, false);
        } else {
          updateIcon(document.documentElement.getAttribute('data-theme') || 'light');
        }

        if (toggleBtn) {
          toggleBtn.addEventListener('click', function() {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const next = current === themes[0] ? themes[1] : themes[0];
            setTheme(next);
          });
        }

        if (window.matchMedia) {
          const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          mediaQuery.addEventListener('change', (event) => {
            const stored = getStoredTheme();
            if (stored) {
              updateIcon(stored);
              return;
            }
            setTheme(event.matches ? 'dark' : 'light', false);
          });
        }
      })();
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const details = document.querySelector('[data-nav-details="audiobook"]');
        if (!details) {
          return;
        }

        document.addEventListener('click', function(event) {
          if (!details.open) {
            return;
          }
          if (details.contains(event.target)) {
            return;
          }
          details.open = false;
        });

        details.addEventListener('keydown', function(event) {
          if (event.key === 'Escape' && details.open) {
            details.open = false;
            event.preventDefault();
          }
        });
      });
    </script>

    <!-- 全局音频播放器JavaScript -->
    <script>
        class GlobalAudioPlayer {
            constructor() {
                this.player = document.getElementById('global-audio');
                this.playerContainer = document.getElementById('global-audio-player');
                this.playBtn = document.getElementById('global-play-btn');
                this.progressSlider = document.getElementById('progress-slider');
                this.volumeSlider = document.getElementById('volume-slider');
                this.currentTimeElement = document.getElementById('current-time');
                this.totalTimeElement = document.getElementById('total-time');
                this.titleElement = document.getElementById('global-audio-title');
                this.closeBtn = document.getElementById('close-player-btn');
                this.subtitleContainer = document.getElementById('subtitle-container');
                this.subtitleText = document.getElementById('subtitle-text');
                this.chapterBtn = document.getElementById('global-chapter-btn');
                this.chapterPanel = document.getElementById('global-chapter-panel');
                this.chapterList = document.getElementById('global-chapter-list');
                this.chapterActiveTitle = document.getElementById('global-chapter-active-title');
                this.chapterActiveTime = document.getElementById('global-chapter-active-time');
                this.chapterAvailability = document.getElementById('global-chapter-availability');

                this.currentSubtitles = [];
                this.isUpdatingProgress = false;
                this.currentAudio = null;
                this.chapterSourceUrl = null;
                this.lastChapterUpdateTs = 0;
                this.chapterUpdateThrottleMs = 250;
                this.store = {
                    chapters: [],
                    activeChapterIndex: -1,
                    isChapterPanelOpen: false
                };

                this.initializeEventListeners();
                this.loadSavedState();
            }

            initializeEventListeners() {
                // 播放/暂停按钮
                this.playBtn.addEventListener('click', () => this.togglePlay());

                // 进度条
                this.progressSlider.addEventListener('input', () => this.onProgressChange());
                this.progressSlider.addEventListener('mousedown', () => this.isUpdatingProgress = true);
                this.progressSlider.addEventListener('mouseup', () => this.isUpdatingProgress = false);

                // 音量控制
                this.volumeSlider.addEventListener('input', () => this.onVolumeChange());

                // 关闭播放器
                this.closeBtn.addEventListener('click', () => this.closePlayer());

                // 章节按钮和列表
                if (this.chapterBtn) {
                    this.chapterBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        this.toggleChapterPanel();
                    });
                }

                if (this.chapterPanel) {
                    this.chapterPanel.addEventListener('click', (event) => event.stopPropagation());
                }

                if (this.chapterList) {
                    this.chapterList.addEventListener('click', (event) => this.handleChapterListClick(event));
                }

                // 音频事件监听
                this.player.addEventListener('loadedmetadata', () => this.onLoadedMetadata());
                this.player.addEventListener('timeupdate', () => this.onTimeUpdate());
                this.player.addEventListener('ended', () => this.onEnded());
                this.player.addEventListener('play', () => this.onPlay());
                this.player.addEventListener('pause', () => this.onPause());
                this.player.addEventListener('error', (e) => this.onError(e));

                // 键盘控制
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
                document.addEventListener('click', (e) => this.handleGlobalClick(e));
            }

            // 播放音频
            playAudio(audioUrl, title, subtitles = null, options = {}) {
                if (!audioUrl) return;

                console.log('[播放器] 播放音频:', {
                    audioUrl,
                    title,
                    subtitles: subtitles ? subtitles.length + '条字幕' : '无字幕',
                    options
                });

                const { chapters = null, chaptersUrl = null } = options || {};

                this.currentSubtitles = subtitles || [];
                this.currentAudio = {
                    url: audioUrl,
                    title,
                    subtitles: this.currentSubtitles,
                    chapters: [],
                    chaptersUrl: null
                };

                this.prepareChapters(chapters, chaptersUrl);

                this.player.src = audioUrl;
                this.titleElement.textContent = title || '未知音频';
                this.showPlayer();

                // 初始化字幕状态
                if (this.currentSubtitles && this.currentSubtitles.length > 0) {
                    console.log('[播放器] 初始化字幕，共', this.currentSubtitles.length, '条');
                    this.updateSubtitle(''); // 这会显示 ♪ ♪ ♪
                } else {
                    console.log('[播放器] 无字幕文件');
                    this.updateSubtitle(''); // 这会显示 "暂无字幕"
                }

                this.player.load();
                this.saveState();
            }

            togglePlay() {
                if (this.player.paused) {
                    this.player.play().catch(e => this.handlePlayError(e));
                } else {
                    this.player.pause();
                }
            }

            onProgressChange() {
                const time = (this.progressSlider.value / 100) * this.player.duration;
                this.player.currentTime = time;
                this.lastChapterUpdateTs = 0;
                this.updateChapterHighlight({ force: true });
            }

            onVolumeChange() {
                this.player.volume = this.volumeSlider.value / 100;
                this.saveState();
            }

            onLoadedMetadata() {
                this.totalTimeElement.textContent = this.formatTime(this.player.duration);
                this.progressSlider.value = 0;
            }

            onTimeUpdate() {
                if (!this.isUpdatingProgress) {
                    const progress = (this.player.currentTime / this.player.duration) * 100;
                    this.progressSlider.value = progress || 0;
                }

                this.currentTimeElement.textContent = this.formatTime(this.player.currentTime);
                this.updateSubtitleDisplay();

                const now = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
                if (
                    this.store.chapters &&
                    this.store.chapters.length > 0 &&
                    (now - this.lastChapterUpdateTs >= this.chapterUpdateThrottleMs)
                ) {
                    this.lastChapterUpdateTs = now;
                    this.updateChapterHighlight();
                }
            }

            onPlay() {
                this.playBtn.innerHTML = '<i class="fas fa-pause text-sm"></i>';
            }

            onPause() {
                this.playBtn.innerHTML = '<i class="fas fa-play text-sm"></i>';
            }

            onEnded() {
                this.playBtn.innerHTML = '<i class="fas fa-play text-sm"></i>';
                this.progressSlider.value = 0;
                this.updateSubtitle('播放完成');
            }

            onError(e) {
                console.error('音频播放错误:', e);
                this.updateSubtitle('播放出错，请重试');
            }

            handlePlayError(e) {
                console.error('播放启动错误:', e);
                this.updateSubtitle('无法播放音频，请检查网络连接');
            }

            // 字幕相关功能
            updateSubtitleDisplay() {
                if (!this.currentSubtitles || this.currentSubtitles.length === 0) {
                    return;
                }

                const currentTime = this.player.currentTime;
                let currentSubtitle = '';

                // 查找当前时间对应的字幕
                for (const subtitle of this.currentSubtitles) {
                    if (currentTime >= subtitle.start && currentTime <= subtitle.end) {
                        currentSubtitle = subtitle.text;
                        break;
                    }
                }

                this.updateSubtitle(currentSubtitle);
            }

            updateSubtitle(text) {
                const subtitleSpan = this.subtitleText.querySelector('span') || this.subtitleText;

                if (text && text.trim()) {
                    subtitleSpan.textContent = text;
                    subtitleSpan.className = '';
                    this.subtitleText.style.opacity = '1';
                } else if (this.currentSubtitles && this.currentSubtitles.length > 0) {
                    // 有字幕文件但当前时间没有对应字幕
                    subtitleSpan.textContent = '♪ ♪ ♪';
                    subtitleSpan.className = 'italic text-base-content/40';
                    this.subtitleText.style.opacity = '0.5';
                } else {
                    // 没有字幕文件
                    subtitleSpan.textContent = '暂无字幕';
                    subtitleSpan.className = 'italic text-base-content/60';
                    this.subtitleText.style.opacity = '0.6';
                }
            }

            // 章节相关逻辑
            prepareChapters(chapters, chaptersUrl) {
                this.closeChapterPanel();
                this.store.chapters = [];
                this.store.activeChapterIndex = -1;
                this.store.isChapterPanelOpen = false;
                this.lastChapterUpdateTs = 0;
                this.chapterSourceUrl = chaptersUrl || null;
                this.updateChapterPanelHeader(-1);

                if (this.currentAudio) {
                    this.currentAudio.chapters = [];
                    this.currentAudio.chaptersUrl = this.chapterSourceUrl;
                }

                if (Array.isArray(chapters) && chapters.length > 0) {
                    this.setChapters(chapters);
                } else {
                    this.updateChapterButtonVisibility();
                    this.renderChapterList();
                    this.saveState();
                    if (this.chapterSourceUrl) {
                        this.fetchChapters(this.chapterSourceUrl);
                    }
                }
            }

            setChapters(items) {
                const normalized = this.normalizeChapters(items);
                this.store.chapters = normalized;
                this.store.activeChapterIndex = -1;
                this.lastChapterUpdateTs = 0;
                this.updateChapterPanelHeader(-1);
                this.updateChapterButtonVisibility();
                this.renderChapterList();
                this.updateChapterHighlight({ force: true });
                if (this.currentAudio) {
                    this.currentAudio.chapters = this.store.chapters;
                    this.currentAudio.chaptersUrl = this.chapterSourceUrl;
                }
                this.saveState();
            }

            async fetchChapters(chaptersUrl) {
                try {
                    const response = await fetch(chaptersUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const list = Array.isArray(data) ? data : (data && Array.isArray(data.chapters) ? data.chapters : []);

                    if (list && list.length > 0) {
                        this.setChapters(list);
                    } else {
                        this.store.chapters = [];
                        this.store.activeChapterIndex = -1;
                        this.updateChapterPanelHeader(-1);
                        this.updateChapterButtonVisibility();
                        this.renderChapterList();
                        this.saveState();
                    }
                } catch (error) {
                    console.warn('[播放器] 章节加载失败:', error);
                    this.store.chapters = [];
                    this.store.activeChapterIndex = -1;
                    this.updateChapterPanelHeader(-1);
                    this.updateChapterButtonVisibility();
                    this.renderChapterList();
                    this.saveState();
                }
            }

            normalizeChapters(items) {
                if (!Array.isArray(items)) {
                    return [];
                }

                const normalized = items
                    .map((item, index) => this.normalizeChapterItem(item, index, items))
                    .filter(Boolean)
                    .sort((a, b) => a.start - b.start);

                return normalized;
            }

            normalizeChapterItem(item, index, allItems) {
                if (!item) return null;

                const start = this.parseChapterTime(
                    item.startTime ?? item.start_seconds ?? item.startSeconds ?? item.start ?? item.start_srt ?? item.startSrt
                );

                if (!isFinite(start)) {
                    return null;
                }

                const endValue = this.parseChapterTime(
                    item.endTime ?? item.end_seconds ?? item.endSeconds ?? item.end ?? item.end_srt ?? item.endSrt
                );

                const title = (item.title || `章节 ${index + 1}`).trim();
                const description = (item.summary || item.description || '').trim();

                return {
                    start: Math.max(0, start),
                    end: isFinite(endValue) ? Math.max(start, endValue) : null,
                    title,
                    description,
                    index
                };
            }

            parseChapterTime(value) {
                if (value === null || value === undefined) {
                    return NaN;
                }

                if (typeof value === 'number') {
                    return value;
                }

                const text = String(value).trim();
                if (!text) {
                    return NaN;
                }

                if (/^-?\d+(\.\d+)?$/.test(text)) {
                    return parseFloat(text);
                }

                const normalized = text.replace(',', '.');
                const parts = normalized.split(':');
                if (parts.length === 0) {
                    return NaN;
                }

                let seconds = 0;
                try {
                    if (parts.length === 3) {
                        const hours = parseInt(parts[0], 10);
                        const minutes = parseInt(parts[1], 10);
                        const secs = parseFloat(parts[2]);
                        seconds = hours * 3600 + minutes * 60 + secs;
                    } else if (parts.length === 2) {
                        const minutes = parseInt(parts[0], 10);
                        const secs = parseFloat(parts[1]);
                        seconds = minutes * 60 + secs;
                    } else {
                        seconds = parseFloat(parts[0]);
                    }
                } catch (err) {
                    return NaN;
                }

                return seconds;
            }

            renderChapterList() {
                if (!this.chapterList) return;

                this.chapterList.innerHTML = '';

                const chapters = this.store.chapters || [];

                if (chapters.length === 0) {
                    const emptyItem = document.createElement('li');
                    emptyItem.className = 'px-3 py-2 text-sm text-base-content/60';
                    emptyItem.textContent = '暂无章节';
                    this.chapterList.appendChild(emptyItem);
                    return;
                }

                chapters.forEach((chapter, index) => {
                    const item = document.createElement('li');
                    item.className = 'px-3 py-2 text-sm text-base-content/80 hover:bg-base-300/40 cursor-pointer transition-colors';
                    item.dataset.index = String(index);
                    item.dataset.start = String(chapter.start);

                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'flex items-center justify-between text-xs text-base-content/60';
                    timeLabel.innerHTML = `<span class="font-mono">${this.formatTime(chapter.start)}</span>`;

                    const title = document.createElement('div');
                    title.className = 'mt-1 font-medium text-base-content';
                    title.textContent = chapter.title;

                    item.appendChild(timeLabel);
                    item.appendChild(title);

                    if (chapter.description) {
                        const desc = document.createElement('div');
                        desc.className = 'mt-1 text-xs text-base-content/50 line-clamp-2';
                        desc.textContent = chapter.description;
                        item.appendChild(desc);
                    }

                    this.chapterList.appendChild(item);
                });
            }

            toggleChapterPanel() {
                if (!this.chapterPanel) return;
                if (this.store.isChapterPanelOpen) {
                    this.closeChapterPanel();
                } else {
                    if (!this.store.chapters || this.store.chapters.length === 0) {
                        return;
                    }
                    this.openChapterPanel();
                }
            }

            openChapterPanel() {
                if (!this.chapterPanel) return;
                this.chapterPanel.classList.remove('hidden');
                this.store.isChapterPanelOpen = true;
                this.updateChapterHighlight({ scrollIntoView: true, force: true });
            }

            closeChapterPanel() {
                if (!this.chapterPanel) return;
                this.chapterPanel.classList.add('hidden');
                this.store.isChapterPanelOpen = false;
            }

            handleChapterListClick(event) {
                const target = event.target.closest('li[data-start]');
                if (!target) return;

                const start = parseFloat(target.dataset.start || '0');
                if (isFinite(start)) {
                    const seekToChapter = () => {
                        this.player.currentTime = Math.max(0, start);
                        this.lastChapterUpdateTs = 0;
                        this.updateChapterHighlight({ scrollIntoView: true, force: true });
                        this.saveState();
                        if (this.player.paused) {
                            this.player.play().catch((err) => this.handlePlayError(err));
                        }
                    };

                    if (this.player.readyState < 1 || !isFinite(this.player.duration)) {
                        const onMetadata = () => {
                            seekToChapter();
                        };
                        this.player.addEventListener('loadedmetadata', onMetadata, { once: true });
                        if (this.player.readyState === 0) {
                            this.player.load();
                        }
                    } else {
                        seekToChapter();
                    }
                }
            }

            handleGlobalClick(event) {
                if (!this.store.isChapterPanelOpen) return;
                if (!this.chapterPanel || !this.chapterBtn) return;
                const target = event.target;
                if (this.chapterPanel.contains(target) || this.chapterBtn.contains(target)) {
                    return;
                }
                this.closeChapterPanel();
            }

            updateChapterPanelHeader(index) {
                if (!this.chapterActiveTitle || !this.chapterActiveTime) return;
                const chapters = this.store.chapters || [];
                const chapter = (typeof index === 'number' && index >= 0) ? chapters[index] : null;

                if (chapter) {
                    this.chapterActiveTitle.textContent = chapter.title || `章节 ${index + 1}`;
                    this.chapterActiveTime.textContent = this.formatTime(chapter.start);
                } else {
                    this.chapterActiveTitle.textContent = '未选择章节';
                    this.chapterActiveTime.textContent = '0:00';
                }
            }

            updateChapterButtonVisibility() {
                if (!this.chapterBtn) return;
                const hasChapters = this.store.chapters && this.store.chapters.length > 0;
                if (hasChapters || this.chapterSourceUrl) {
                    this.chapterBtn.classList.remove('hidden');
                } else {
                    this.chapterBtn.classList.add('hidden');
                    this.closeChapterPanel();
                }

                if (this.chapterAvailability) {
                    if (hasChapters) {
                        this.chapterAvailability.classList.remove('hidden');
                    } else {
                        this.chapterAvailability.classList.add('hidden');
                    }
                }

                this.chapterBtn.classList.toggle('text-primary', hasChapters);
                this.chapterBtn.classList.toggle('hover:text-primary', hasChapters);
                this.chapterBtn.classList.toggle('hover:text-base-content', !hasChapters);
            }

            updateChapterHighlight(options = {}) {
                const opts = typeof options === 'boolean'
                    ? { scrollIntoView: options, force: false }
                    : { scrollIntoView: false, force: false, ...options };

                const chapters = this.store.chapters || [];

                if (chapters.length === 0 || !this.chapterList) {
                    this.store.activeChapterIndex = -1;
                    this.updateChapterPanelHeader(-1);
                    return;
                }

                const currentTime = this.player.currentTime;
                let matchedIndex = chapters.length - 1;

                for (let i = 0; i < chapters.length; i += 1) {
                    const chapter = chapters[i];
                    const end = this.getChapterEnd(i);
                    if (currentTime >= chapter.start && currentTime < end) {
                        matchedIndex = i;
                        break;
                    }
                }

                const items = Array.from(this.chapterList.querySelectorAll('li[data-start]'));

                items.forEach((item, index) => {
                    if (index === matchedIndex) {
                        item.classList.add('bg-primary/10', 'text-primary');
                        item.classList.remove('text-base-content/80');
                        if ((opts.scrollIntoView || this.store.isChapterPanelOpen) && (index !== this.store.activeChapterIndex || opts.force)) {
                            item.scrollIntoView({ block: 'center' });
                        }
                    } else {
                        item.classList.remove('bg-primary/10', 'text-primary');
                        item.classList.add('text-base-content/80');
                    }
                });

                this.store.activeChapterIndex = matchedIndex;
                this.updateChapterPanelHeader(matchedIndex);
            }

            getChapterEnd(index) {
                const chapters = this.store.chapters || [];
                const chapter = chapters[index];
                if (!chapter) return Number.POSITIVE_INFINITY;

                if (chapter.end !== null && chapter.end !== undefined) {
                    return chapter.end;
                }

                if (index + 1 < chapters.length) {
                    return chapters[index + 1].start;
                }

                return this.player.duration || Number.POSITIVE_INFINITY;
            }

            // 解析SRT格式字幕
            parseSRTSubtitles(srtContent) {
                if (!srtContent) {
                    console.log('[字幕] 没有字幕内容');
                    return [];
                }

                console.log('[字幕] 开始解析SRT内容，长度:', srtContent.length);
                console.log('[字幕] SRT内容预览:', srtContent.substring(0, 200) + '...');

                const subtitles = [];
                const blocks = srtContent.trim().split(/\n\s*\n/);

                console.log('[字幕] 分割后的块数:', blocks.length);

                blocks.forEach((block, index) => {
                    const lines = block.trim().split('\n');
                    console.log(`[字幕] 处理第${index + 1}块，行数:`, lines.length, lines);

                    if (lines.length >= 3) {
                        // 更宽松的时间格式匹配
                        const timeMatch = lines[1].match(/(\d{1,2}):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d{1,2}):(\d{2}):(\d{2})[,.](\d{3})/);
                if (timeMatch) {
                    const start = this.parseTimeToSeconds([timeMatch[1], timeMatch[2], timeMatch[3], timeMatch[4]]);
                    const end = this.parseTimeToSeconds([timeMatch[5], timeMatch[6], timeMatch[7], timeMatch[8]]);
                    const text = this.cleanSubtitleText(lines.slice(2).join(' '));

                    if (text) {
                        subtitles.push({ start, end, text });
                        console.log(`[字幕] 添加字幕: ${start}s - ${end}s: "${text}"`);
                    }
                } else {
                    console.warn('[字幕] 时间格式不匹配:', lines[1]);
                }
            } else {
            console.warn('[字幕] 块格式不正确，行数不足:', lines);
        }
      });

        console.log(`[字幕] 解析完成，共${subtitles.length}条字幕`);
        return subtitles;
    }

        // 清理字幕文本中的多余空格
        cleanSubtitleText(text) {
            if (!text) return '';
            
            // 去除所有空格
            let cleaned = text.replace(/\s+/g, '');
            
            return cleaned;
        }

        parseTimeToSeconds(timeParts) {
            const [hours, minutes, seconds, milliseconds] = timeParts.map(Number);
            return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
        }

        // 键盘控制
        handleKeyboard(e) {
            if (!this.isPlayerVisible()) return;

            // 只在播放器可见且不在输入框中时响应键盘
            if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'textarea') {
                return;
            }

            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    this.togglePlay();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    this.player.currentTime = Math.max(0, this.player.currentTime - 10);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    this.player.currentTime = Math.min(this.player.duration, this.player.currentTime + 10);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.volumeSlider.value = Math.min(100, parseInt(this.volumeSlider.value) + 10);
                    this.onVolumeChange();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    this.volumeSlider.value = Math.max(0, parseInt(this.volumeSlider.value) - 10);
                    this.onVolumeChange();
                    break;
                case 'Escape':
                    this.closePlayer();
                    break;
            }
        }

        // UI控制
        showPlayer() {
            this.playerContainer.style.display = 'block';
            setTimeout(() => {
                this.playerContainer.style.transform = 'translateY(0)';
            }, 10);
        }

        closePlayer() {
            this.player.pause();
            this.playerContainer.style.transform = 'translateY(100%)';
            setTimeout(() => {
                this.playerContainer.style.display = 'none';
            }, 300);
            this.closeChapterPanel();
            this.store.chapters = [];
            this.store.activeChapterIndex = -1;
            this.chapterSourceUrl = null;
            this.currentAudio = null;
            this.updateChapterPanelHeader(-1);
            this.updateChapterButtonVisibility();
            this.renderChapterList();
            this.clearState();
        }

        isPlayerVisible() {
            return this.playerContainer.style.display !== 'none' &&
                this.playerContainer.style.transform === 'translateY(0px)';
        }

        // 状态持久化
        saveState() {
            if (this.currentAudio) {
                this.currentAudio.chapters = this.store.chapters;
                this.currentAudio.chaptersUrl = this.chapterSourceUrl;
                const state = {
                    audio: this.currentAudio,
                    currentTime: this.player.currentTime,
                    volume: this.volumeSlider.value,
                    isVisible: this.isPlayerVisible(),
                    chapterState: {
                        activeIndex: this.store.activeChapterIndex,
                        isPanelOpen: this.store.isChapterPanelOpen
                    }
                };
                localStorage.setItem('globalAudioPlayerState', JSON.stringify(state));
            }
        }

        loadSavedState() {
            const savedState = localStorage.getItem('globalAudioPlayerState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.audio && state.isVisible) {
                        this.volumeSlider.value = state.volume || 80;
                        this.onVolumeChange();

                        // 恢复播放状态（但不自动播放）
                        this.playAudio(state.audio.url, state.audio.title, state.audio.subtitles, {
                            chapters: state.audio.chapters,
                            chaptersUrl: state.audio.chaptersUrl
                        });

                        if (state.chapterState) {
                            const { activeIndex, isPanelOpen } = state.chapterState;
                            if (typeof activeIndex === 'number') {
                                this.store.activeChapterIndex = activeIndex;
                                this.updateChapterPanelHeader(activeIndex);
                            }
                            if (isPanelOpen) {
                                setTimeout(() => this.openChapterPanel(), 0);
                            }
                        }

                        if (state.currentTime) {
                            this.player.addEventListener('loadedmetadata', () => {
                                this.player.currentTime = state.currentTime;
                                this.updateChapterHighlight({ force: true });
                            }, { once: true });
                        }
                    }
                } catch (e) {
                    console.error('加载播放器状态失败:', e);
                }
            }
        }

        clearState() {
            localStorage.removeItem('globalAudioPlayerState');
        }

        // 工具函数
        formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00';

            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
  }

        // 初始化全局播放器
        let globalPlayer;
        document.addEventListener('DOMContentLoaded', function () {
            globalPlayer = new GlobalAudioPlayer();

            // 在window对象上暴露播放器，供其他页面调用
            window.globalAudioPlayer = globalPlayer;
        });

        // 页面卸载前保存状态
        window.addEventListener('beforeunload', function () {
            if (globalPlayer) {
                globalPlayer.saveState();
            }
        });
    </script>
</body>

</html>
