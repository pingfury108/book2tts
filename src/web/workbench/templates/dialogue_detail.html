{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
/* 自定义滚动条样式 */
.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: hsl(var(--b2));
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: hsl(var(--b3));
    border-radius: 4px;
    transition: background-color 0.2s;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--b4));
}

/* Firefox */
.custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: hsl(var(--b3)) hsl(var(--b2));
}
</style>
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <div class="flex justify-between items-center text-base-content">
            <div>
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold mr-3" id="script-title-display">{{ script.title }}</h1>
                    <button type="button" 
                            id="edit-script-btn"
                            class="btn btn-ghost btn-sm text-blue-600 hover:text-blue-800">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                </div>
                <div class="mt-2">
                    <span class="text-base-content/70">关联书籍：</span>
                    <span id="script-book-display" class="text-base-content/70">
                        {% if script.book %}{{ script.book.name }}{% else %}无关联书籍{% endif %}
                    </span>
                    <span class="text-base-content/70 ml-4">| 创建时间：{{ script.created_at|date:"Y-m-d H:i" }}</span>
                </div>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'dialogue_list' %}" 
                   class="btn btn-outline">
                    <i class="fas fa-arrow-left mr-2"></i>返回列表
                </a>
                {% if script.audio_file and not script.published %}
                <form style="display: inline;" 
                      method="post" 
                      action="{% url 'dialogue_publish' script.id %}"
                      id="publish-form">
                    {% csrf_token %}
                    <button type="button" 
                            id="publish-btn"
                            class="btn btn-success">
                        <i class="fas fa-upload mr-2"></i>发布音频
                    </button>
                </form>
                {% endif %}
                <button type="button" 
                        id="delete-script-btn"
                        class="btn btn-error">
                    <i class="fas fa-trash mr-2"></i>删除脚本
                </button>
            </div>
        </div>
    </div>

    <div class="flex flex-col gap-6 lg:flex-row lg:items-stretch lg:h-[calc(100vh-14rem)] lg:min-h-[32rem] lg:max-h-[calc(100vh-14rem)] lg:min-h-0">
        <!-- 对话内容预览 -->
        <div class="flex flex-col min-h-0 lg:flex-[2] lg:min-h-0">
            <div class="bg-base-100 shadow-md rounded-lg flex flex-col flex-1 min-h-0 relative">
                <h2 class="text-xl font-semibold p-6 pb-4 border-b border-base-200 flex-shrink-0">对话内容</h2>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 pt-4 min-h-0">
                    {% for segment in segments %}
                    <div class="mb-3 p-4 rounded-lg transition-all border border-transparent group {% if segment.dialogue_type == 'narration' %}bg-base-200/60 hover:bg-base-200{% else %}bg-primary/10 hover:bg-primary/20{% endif %}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-sm 
                                {% if segment.dialogue_type == 'narration' %}text-base-content/70{% else %}text-primary{% endif %}">
                                {{ segment.speaker }}
                                {% with voice_config=voice_settings|dict_get:segment.speaker %}
                                    {% with voice_name=voice_config|dict_get:'voice_name' %}
                                        {% if voice_name %}
                                            <span class="badge badge-success badge-sm ml-2">
                                                {{ voice_name }}
                                            </span>
                                        {% endif %}
                                    {% endwith %}
                                {% endwith %}
                            </span>
                            <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-xs text-base-content/60">#{{ segment.sequence }}</span>
                                {% with voice_config=voice_settings|dict_get:segment.speaker %}
                                    {% with voice_name=voice_config|dict_get:'voice_name' %}
                                        {% if voice_name %}
                                            <button type="button" 
                                                    data-segment-id="{{ segment.id }}"
                                                    class="preview-segment-btn text-green-600 hover:text-green-800 p-1" 
                                                    title="听见">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        {% endif %}
                                    {% endwith %}
                                {% endwith %}
                                <button type="button" 
                                        data-segment-id="{{ segment.id }}"
                                        data-speaker="{{ segment.speaker|escapejs }}"
                                        data-text="{{ segment.utterance|escapejs }}"
                                        data-sequence="{{ segment.sequence }}"
                                        class="edit-segment-btn text-blue-600 hover:text-blue-800 p-1" 
                                        title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" 
                                        data-segment-id="{{ segment.id }}"
                                        class="delete-segment-btn text-red-600 hover:text-red-800 p-1" 
                                        title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-base-content" id="segment-text-{{ segment.id }}">{{ segment.utterance }}</p>
                    </div>
                    {% endfor %}
                </div>
                <!-- 字幕下载和查看按钮 -->
                {% if script.subtitle_file and script.subtitle_file.name %}
                <div class="mt-4 p-4 bg-base-200/70 rounded-lg">
                    <div class="flex gap-2">
                        <a href="{{ script.subtitle_file.url }}" class="btn btn-secondary btn-sm" download>
                            <i class="fas fa-download"></i>
                            <span class="ml-2">下载字幕</span>
                        </a>
                        <button id="toggle-subtitles-btn" class="btn btn-outline btn-sm">
                            <i class="fas fa-closed-captioning"></i>
                            <span class="ml-2">查看字幕</span>
                        </button>
                    </div>
                    
                    <!-- 字幕内容显示区域 -->
                    <div id="subtitles-content" class="mt-4 hidden">
                        <h4 class="font-medium text-sm text-base-content mb-2">字幕内容</h4>
                        <div id="subtitles-text" class="text-xs text-base-content/70 max-h-40 overflow-y-auto custom-scrollbar p-3 bg-base-100 rounded border border-base-300">
                            <div class="text-center text-base-content/50">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                加载字幕中...
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <!-- 滚动渐变提示 -->
                <div class="absolute bottom-0 left-6 right-6 h-8 bg-gradient-to-t from-base-100 via-base-100/90 to-transparent pointer-events-none opacity-0 transition-opacity duration-300" id="scroll-fade"></div>
            </div>
        </div>

        <!-- 音色配置和控制面板 -->
        <div class="flex flex-col gap-6 min-h-0 lg:flex-[1] lg:min-h-0 lg:overflow-y-auto">
            <!-- 状态信息 -->
            <div class="bg-base-100 shadow-md rounded-lg p-6 text-base-content">
                <h3 class="text-lg font-semibold mb-3">状态信息</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>片段数量：</span>
                        <span>{{ segments.count }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>说话者数量：</span>
                        <span>{{ speakers|length }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>音频状态：</span>
                        <span>
                            {% if script.audio_file %}
                                {% if script.published %}
                                    <span class="text-success">已发布</span>
                                {% else %}
                                    <span class="text-primary">已生成</span>
                                {% endif %}
                            {% else %}
                                <span class="text-base-content/70">未生成</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if script.audio_duration %}
                    <div class="flex justify-between">
                        <span>音频时长：</span>
                        <span>{{ script.audio_duration|floatformat:1 }} 秒</span>
                    </div>
                    {% endif %}
                </div>
                
                {% if script.audio_file %}
                <div class="mt-4">
                    <button class="btn btn-primary w-full" onclick="playFinishedAudio('{{ script.audio_file.url }}', '{{ script.title|escapejs }}', {% if script.subtitle_file and script.subtitle_file.name %}'{{ script.subtitle_file.url }}'{% else %}null{% endif %})">
                        <i class="fas fa-play mr-2"></i>播放成品音频
                    </button>
                </div>
                {% endif %}
            </div>

            {% if script.audio_file %}
            <div class="bg-base-100 shadow-md rounded-lg p-6">
                <div class="flex items-center justify-between mb-3" data-chapter-wrapper>
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-list mr-2"></i>
                        章节导航
                    </h3>
                    {% if script.subtitle_file and script.subtitle_file.name %}
                    <button id="generate-dialogue-chapters-btn"
                        class="btn btn-sm btn-outline w-32 sm:w-36 justify-center"
                        data-target-url="{% url 'dialogue_generate_chapters' script.id %}"
                        data-force="{% if script.chapters %}true{% else %}false{% endif %}">
                        <i class="fas fa-magic mr-1"></i>
                        {% if script.chapters %}重新生成章节{% else %}生成章节{% endif %}
                    </button>
                    {% endif %}
                </div>
                {% if script.subtitle_file and script.subtitle_file.name %}
                    {% if script.chapters %}
                    <div class="space-y-3">
                        {% for chapter in script.chapters %}
                        <button
                            type="button"
                            class="w-full text-left p-3 rounded-lg border border-base-200 hover:border-primary hover:bg-primary/10 transition dialogue-chapter-btn"
                            data-chapter-start="{{ chapter.start_seconds }}"
                            data-audio-url="{{ script.audio_file.url }}"
                            data-subtitle-url="{{ script.subtitle_file.url }}"
                            data-audio-title="{{ script.title|escapejs }}"
                        >
                            <div class="flex items-center justify-between gap-3">
                                <span class="badge badge-outline badge-primary text-xs">{{ chapter.start_seconds|format_seconds }}</span>
                                <span class="font-semibold text-base-content flex-1">{{ chapter.title }}</span>
                                <i class="fas fa-play text-primary"></i>
                            </div>
                            {% if chapter.summary %}
                            <p class="mt-2 text-sm text-base-content/70 leading-relaxed">{{ chapter.summary }}</p>
                            {% endif %}
                        </button>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-sm text-base-content/60">
                        暂无章节信息，可点击右上方按钮生成。
                    </div>
                    {% endif %}
                {% else %}
                <div class="text-sm text-base-content/60">
                    暂无字幕文件，无法生成章节。
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- 音色配置 -->
            <div class="bg-base-100 shadow-md rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-3">音色配置</h3>
                <form id="voice-config-form">
                    {% for speaker in speakers %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-base-content mb-2">
                            {{ speaker }}
                        </label>
                        {% with config=voice_settings|dict_get:speaker %}
                        {% with selected_voice=config|dict_get:'voice_name' %}
                        <div class="relative" data-voice-dropdown data-speaker="{{ speaker|escape }}">
                            <button type="button"
                                    class="btn btn-outline btn-sm w-full justify-between"
                                    data-role="voice-toggle">
                                <span data-role="voice-label">{{ selected_voice|default:"选择音色" }}</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div class="hidden absolute z-20 mt-1 w-full max-h-60 overflow-y-auto rounded-md border border-base-300 bg-base-100 shadow-lg"
                                 data-role="voice-menu"></div>
                            <input type="hidden"
                                   name="voice_mapping[{{ speaker }}][voice_name]"
                                   data-role="voice-input"
                                   value="{{ selected_voice|default:"" }}">
                        </div>
                        {% endwith %}
                        {% endwith %}
                    </div>
                    {% endfor %}
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">
                        <i class="fas fa-save mr-2"></i>保存配置
                    </button>
                </form>
            </div>

            <!-- 音频生成 -->
            <div class="bg-base-100 shadow-md rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-3">音频生成</h3>
                <form id="audio-generation-form" class="space-y-3">
                    <button type="submit" id="generate-audio-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg">
                        <i class="fas fa-microphone mr-2"></i>生成音频
                    </button>
                    <div id="dialogue-audio-status" class="hidden">
                        <div class="alert alert-info flex items-center gap-2 text-sm m-0" id="dialogue-audio-status-alert">
                            <span class="loading loading-spinner loading-sm"></span>
                            <span id="dialogue-audio-status-text">准备生成对话音频...</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- DaisyUI Modals -->
<!-- 脚本编辑对话框 -->
<div id="edit-script-modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-4">编辑脚本信息</h3>
        <div class="space-y-4">
            <!-- 标题编辑 -->
            <div>
                <label class="label">
                    <span class="label-text">脚本标题</span>
                </label>
                <input type="text" 
                       id="edit-script-title" 
                       class="input input-bordered w-full" 
                       placeholder="请输入脚本标题"
                       value="{{ script.title }}">
            </div>
            
            <!-- 关联书籍编辑 -->
            <div>
                <label class="label">
                    <span class="label-text">关联书籍</span>
                </label>
                <select id="edit-script-book" class="select select-bordered w-full">
                    <option value="">无关联书籍</option>
                    {% for book in books %}
                    <option value="{{ book.id }}" 
                        {% if script.book and script.book.id == book.id %}selected{% endif %}>
                        {{ book.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="modal-action">
            <button class="btn" id="cancel-script-edit">取消</button>
            <button class="btn btn-primary" id="save-script-edit">
                <i class="fas fa-save mr-2"></i>保存
            </button>
        </div>
    </div>
</div>

<!-- 确认对话框 -->
<div id="confirm-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg" id="confirm-title">确认操作</h3>
        <p class="py-4" id="confirm-message">确定要执行此操作吗？</p>
        <div class="modal-action">
            <button class="btn" id="confirm-cancel">取消</button>
            <button class="btn btn-error" id="confirm-ok">确定</button>
        </div>
    </div>
</div>

<!-- 输入对话框 -->
<div id="prompt-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg" id="prompt-title">输入信息</h3>
        <div class="py-4">
            <label class="label">
                <span class="label-text" id="prompt-label">请输入内容：</span>
            </label>
            <input type="text" id="prompt-input" class="input input-bordered w-full" placeholder="请输入内容">
        </div>
        <div class="modal-action">
            <button class="btn" id="prompt-cancel">取消</button>
            <button class="btn btn-primary" id="prompt-ok">确定</button>
        </div>
    </div>
</div>

<!-- Toast 容器 -->
<div id="toast-container" class="toast toast-end z-50"></div>

<script>

// DaisyUI 对话框和通知功能
function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    let alertClass = 'alert-info';
    let icon = 'fas fa-info-circle';
    
    switch(type) {
        case 'success':
            alertClass = 'alert-success';
            icon = 'fas fa-check-circle';
            break;
        case 'error':
            alertClass = 'alert-error';
            icon = 'fas fa-exclamation-circle';
            break;
        case 'warning':
            alertClass = 'alert-warning';
            icon = 'fas fa-exclamation-triangle';
            break;
    }
    
    toast.className = `alert ${alertClass} mb-2`;
    toast.innerHTML = `
        <i class="${icon}"></i>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, duration);
}

function showConfirm(title, message, onConfirm, onCancel = null) {
    const modal = document.getElementById('confirm-modal');
    const titleEl = document.getElementById('confirm-title');
    const messageEl = document.getElementById('confirm-message');
    const confirmBtn = document.getElementById('confirm-ok');
    const cancelBtn = document.getElementById('confirm-cancel');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    // 清除之前的事件监听器
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    // 添加新的事件监听器
    newConfirmBtn.addEventListener('click', () => {
        modal.classList.remove('modal-open');
        if (onConfirm) onConfirm();
    });
    
    newCancelBtn.addEventListener('click', () => {
        modal.classList.remove('modal-open');
        if (onCancel) onCancel();
    });
    
    modal.classList.add('modal-open');
}

function showPrompt(title, label, defaultValue = '', onConfirm, onCancel = null) {
    const modal = document.getElementById('prompt-modal');
    const titleEl = document.getElementById('prompt-title');
    const labelEl = document.getElementById('prompt-label');
    const inputEl = document.getElementById('prompt-input');
    const confirmBtn = document.getElementById('prompt-ok');
    const cancelBtn = document.getElementById('prompt-cancel');
    
    titleEl.textContent = title;
    labelEl.textContent = label;
    inputEl.value = defaultValue;
    
    // 清除之前的事件监听器
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    // 添加新的事件监听器
    newConfirmBtn.addEventListener('click', () => {
        const value = inputEl.value.trim();
        if (value) {
            modal.classList.remove('modal-open');
            if (onConfirm) onConfirm(value);
        } else {
            showToast('请输入内容', 'warning');
        }
    });
    
    newCancelBtn.addEventListener('click', () => {
        modal.classList.remove('modal-open');
        if (onCancel) onCancel();
    });
    
    // 支持回车键确认
    inputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            newConfirmBtn.click();
        }
    });
    
    modal.classList.add('modal-open');
    setTimeout(() => {
        inputEl.focus();
        inputEl.select();
    }, 100);
}

// 编辑脚本信息（标题和关联书籍）
function editScript() {
    const modal = document.getElementById('edit-script-modal');
    const titleInput = document.getElementById('edit-script-title');
    const bookSelect = document.getElementById('edit-script-book');
    
    // 设置当前值
    titleInput.value = document.getElementById('script-title-display').textContent;
    
    // 显示弹窗
    modal.classList.add('modal-open');
    
    // 聚焦标题输入框
    setTimeout(() => {
        titleInput.focus();
        titleInput.select();
    }, 100);
}

// 保存脚本信息
function saveScript() {
    const titleInput = document.getElementById('edit-script-title');
    const bookSelect = document.getElementById('edit-script-book');
    const saveBtn = document.getElementById('save-script-edit');
    
    const newTitle = titleInput.value.trim();
    const newBookId = bookSelect.value;
    const newBookName = bookSelect.options[bookSelect.selectedIndex].text;
    
    if (!newTitle) {
        showToast('标题不能为空', 'warning');
        return;
    }
    
    // 显示加载状态
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>保存中...';
    saveBtn.disabled = true;
    
    // 准备请求数据
    const promises = [];
    const currentTitle = document.getElementById('script-title-display').textContent;
    const currentBookText = document.getElementById('script-book-display').textContent;
    
    // 如果标题有变化，发送标题更新请求
    if (newTitle !== currentTitle) {
        promises.push(
            fetch('{% url "dialogue_update_title" script.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ title: newTitle })
            }).then(response => response.json())
        );
    }
    
    // 如果书籍有变化，发送书籍更新请求
    const currentBookName = currentBookText === '无关联书籍' ? '' : currentBookText;
    const selectedBookName = newBookId ? newBookName : '';
    if (selectedBookName !== currentBookName) {
        promises.push(
            fetch('{% url "dialogue_update_book" script.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ book_id: newBookId || null })
            }).then(response => response.json())
        );
    }
    
    // 如果没有变化，直接关闭弹窗
    if (promises.length === 0) {
        cancelScriptEdit();
        return;
    }
    
    // 执行所有请求
    Promise.all(promises)
        .then(results => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            // 检查是否所有请求都成功
            const allSuccess = results.every(result => result.success);
            
            if (allSuccess) {
                // 更新页面显示
                document.getElementById('script-title-display').textContent = newTitle;
                document.getElementById('script-book-display').textContent = newBookId ? newBookName : '无关联书籍';
                document.title = newTitle + ' - 对话脚本';
                
                showToast('脚本信息已更新', 'success');
                cancelScriptEdit();
            } else {
                // 显示错误信息
                const errors = results.filter(result => !result.success).map(result => result.error);
                showToast('更新失败：' + errors.join(', '), 'error');
            }
        })
        .catch(error => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            showToast('网络错误：' + error.message, 'error');
        });
}

// 取消编辑脚本
function cancelScriptEdit() {
    const modal = document.getElementById('edit-script-modal');
    modal.classList.remove('modal-open');
}

// 删除脚本
function deleteScript() {
    showConfirm('删除脚本', '确定要删除这个对话脚本吗？此操作不可恢复！', () => {
        fetch('{% url "dialogue_delete" script.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast(result.message, 'success');
                setTimeout(() => {
                    window.location.href = '{% url "dialogue_list" %}';
                }, 1500);
            } else {
                showToast('删除失败：' + result.error, 'error');
            }
        })
        .catch(error => {
            showToast('网络错误：' + error.message, 'error');
        });
    });
}

// 编辑片段
function editSegment(segmentId, currentSpeaker, currentText, currentSequence) {
    showPrompt('编辑说话者', '请输入说话者：', currentSpeaker, (newSpeaker) => {
        showPrompt('编辑对话内容', '请输入对话内容：', currentText, (newText) => {
            fetch(`/workbench/dialogue/segment/${segmentId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    speaker: newSpeaker,
                    text: newText,
                    sequence: currentSequence
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('片段已更新', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast('更新失败：' + result.error, 'error');
                }
            })
            .catch(error => {
                showToast('网络错误：' + error.message, 'error');
            });
        });
    });
}

// 删除片段
function deleteSegment(segmentId) {
    showConfirm('删除片段', '确定要删除这个对话片段吗？此操作不可恢复！', () => {
        fetch(`/workbench/dialogue/segment/${segmentId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast(result.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast('删除失败：' + result.error, 'error');
            }
        })
        .catch(error => {
            showToast('网络错误：' + error.message, 'error');
        });
    });
}

const segmentPreviewObjectUrls = new Map();

// 预览片段音频
function previewSegment(segmentId, triggerButton) {
    if (!segmentId) {
        return;
    }

    const btn = triggerButton || null;
    const originalHtml = btn ? btn.innerHTML : '';

    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
    }

    fetch(`/workbench/dialogue/segment/${segmentId}/preview/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(async (response) => {
        if (!response.ok) {
            const contentType = response.headers.get('Content-Type') || response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                const data = await response.json();
                throw new Error(data.error || '预览音频生成失败');
            }
            throw new Error('预览音频生成失败');
        }

        const contentType = response.headers.get('Content-Type') || response.headers.get('content-type') || 'audio/wav';
        const buffer = await response.arrayBuffer();
        return {
            buffer,
            contentType
        };
    })
    .then(({ buffer, contentType }) => {
        if (!buffer || buffer.byteLength === 0) {
            throw new Error('音频数据为空');
        }

        const blob = new Blob([buffer], { type: contentType });
        const objectUrl = URL.createObjectURL(blob);
        showPreviewAudio(objectUrl, segmentId, true);
        showToast('预览音频已生成', 'success');
    })
    .catch((error) => {
        showToast('预览生成失败：' + error.message, 'error');
    })
    .finally(() => {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    });
}

// 监听任务完成状态
function checkTaskStatus(taskId, callback) {
    fetch(`/workbench/task/${taskId}/status/`)
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            callback(result.task);
        }
    });
}

// 显示预览音频
function showPreviewAudio(audioUrl, segmentId, isObjectUrl = false) {
    if (!audioUrl || !segmentId) {
        return;
    }

    const containerId = `segment-preview-${segmentId}`;
    const existingContainer = document.getElementById(containerId);
    if (existingContainer) {
        const existingAudio = existingContainer.querySelector('audio');
        if (existingAudio && existingAudio.dataset.previewUrl === 'true') {
            const oldUrl = segmentPreviewObjectUrls.get(segmentId);
            if (oldUrl && oldUrl.startsWith('blob:')) {
                URL.revokeObjectURL(oldUrl);
            }
            segmentPreviewObjectUrls.delete(segmentId);
        }
        existingContainer.remove();
    } else {
        const oldUrl = segmentPreviewObjectUrls.get(segmentId);
        if (oldUrl && oldUrl.startsWith('blob:')) {
            URL.revokeObjectURL(oldUrl);
        }
        segmentPreviewObjectUrls.delete(segmentId);
    }

    const audioContainer = document.createElement('div');
    audioContainer.id = containerId;
    audioContainer.className = 'mt-2 p-2 bg-base-200 rounded border border-base-200 flex items-center gap-2';

    const audioElement = document.createElement('audio');
    audioElement.controls = true;
    audioElement.className = 'w-full';
    audioElement.src = audioUrl;
    audioElement.dataset.previewUrl = isObjectUrl ? 'true' : 'false';

    audioContainer.appendChild(audioElement);

    const segmentElement = document.querySelector(`#segment-text-${segmentId}`);
    if (segmentElement && segmentElement.parentNode) {
        segmentElement.parentNode.insertBefore(audioContainer, segmentElement.nextSibling);
    }

    if (isObjectUrl) {
        segmentPreviewObjectUrls.set(segmentId, audioUrl);
    }

    audioElement.play().catch(() => {
        // 自动播放失败时保持静音等待用户点击
    });
}

// 页面加载完成后初始化
function initializePreviewCheck() {
    // 检查是否有预览任务在运行
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('preview_task');
    if (taskId) {
        // 轮询检查任务状态
        const checkInterval = setInterval(() => {
            checkTaskStatus(taskId, (task) => {
                if (task.status === 'success') {
                    clearInterval(checkInterval);
                    showPreviewAudio(task.result_data.audio_file, task.metadata.segment_id);
                } else if (task.status === 'failure') {
                    clearInterval(checkInterval);
                    showToast('预览音频生成失败：' + task.error_message, 'error');
                }
            });
        }, 2000);
    }
}

// 确保所有函数在DOM加载后绑定事件 - 只保留这一个DOMContentLoaded监听器
document.addEventListener('DOMContentLoaded', function() {
    const voiceConfigForm = document.getElementById('voice-config-form');
    const audioGenerationForm = document.getElementById('audio-generation-form');
    const generateAudioBtn = document.getElementById('generate-audio-btn');
    const dialogueAudioStatusContainer = document.getElementById('dialogue-audio-status');
    const dialogueAudioStatusAlert = document.getElementById('dialogue-audio-status-alert');
    const dialogueAudioStatusText = document.getElementById('dialogue-audio-status-text');
    const dialogueAudioStatusSpinner = dialogueAudioStatusAlert ? dialogueAudioStatusAlert.querySelector('.loading') : null;
    const generateAudioBtnDefaultHtml = generateAudioBtn ? generateAudioBtn.innerHTML : '';
    const toggleSubtitlesBtn = document.getElementById('toggle-subtitles-btn');
    const subtitlesContent = document.getElementById('subtitles-content');
    const subtitlesText = document.getElementById('subtitles-text');
    const availableVoices = JSON.parse('{{ available_voices_json|escapejs }}') || [];
    const defaultProvider = '{{ default_provider }}';
    const voiceSettings = JSON.parse('{{ voice_settings_json|escapejs }}') || {};
    const speakers = JSON.parse('{{ speakers_json|escapejs }}') || [];
    const chapterButtons = document.querySelectorAll('.dialogue-chapter-btn');
    const generateChaptersBtn = document.getElementById('generate-dialogue-chapters-btn');

    let dialogueAudioPollingTimer = null;

    const voiceDropdowns = new Map();

    if (voiceConfigForm) {
        voiceConfigForm.querySelectorAll('[data-voice-dropdown]').forEach((container) => {
            const speaker = container.dataset.speaker;
            if (!speaker) {
                return;
            }
            voiceDropdowns.set(speaker, {
                container,
                toggle: container.querySelector('[data-role="voice-toggle"]'),
                label: container.querySelector('[data-role="voice-label"]'),
                menu: container.querySelector('[data-role="voice-menu"]'),
                hiddenInput: container.querySelector('[data-role="voice-input"]'),
            });
        });
    }

    const dialogueTaskStatusUrlTemplate = '{% url "task_status" "TASK_ID_PLACEHOLDER" %}';

    async function requestChapterGeneration(button) {
        if (!button || button.disabled) {
            return;
        }

        const requestUrl = button.dataset.targetUrl;
        const force = button.dataset.force === 'true';

        if (!requestUrl) {
            showToast('未找到章节生成接口', 'error');
            return;
        }

        const originalHtml = button.innerHTML;
        const originalWidth = button.offsetWidth;
        button.style.width = `${originalWidth}px`;
        button.disabled = true;
        button.innerHTML = '<span class="loading loading-spinner loading-xs mr-1"></span>处理中...';

        try {
            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ force })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                if (data.task_id) {
                    const statusUrl = dialogueTaskStatusUrlTemplate.replace('TASK_ID_PLACEHOLDER', encodeURIComponent(data.task_id));
                    startDialogueChapterPolling(button, statusUrl, originalHtml, originalWidth, true);
                } else {
                    button.dataset.force = 'true';
                    button.innerHTML = '<i class="fas fa-check mr-1"></i>已完成';
                    setTimeout(() => {
                        button.disabled = false;
                        button.dataset.force = 'true';
                        button.innerHTML = '<i class="fas fa-redo mr-1"></i>重新生成章节';
                        button.style.width = '';
                    }, 1200);
                }
            } else {
                const errorMsg = data.error || data.message || '章节生成失败';
                showToast(errorMsg, 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
                button.style.width = '';
            }
        } catch (error) {
            showToast('章节生成请求失败：' + error.message, 'error');
            button.disabled = false;
            button.innerHTML = originalHtml;
            button.style.width = '';
        }
    }

    function startDialogueChapterPolling(button, statusUrl, originalHtml, originalWidth, shouldReload) {
        const originalForce = button.dataset.force;

        const updateButton = (content, disabled = true) => {
            button.innerHTML = content;
            button.disabled = disabled;
        };

        let stopped = false;

        const poll = async () => {
            if (stopped) {
                return;
            }

            try {
                const response = await fetch(statusUrl, { headers: { 'Accept': 'application/json' } });
                const payload = await response.json();

                if (!response.ok || !payload.success || !payload.task) {
                    throw new Error(payload.error || payload.message || '状态查询失败');
                }

                const task = payload.task;
                const status = (task.status || '').toLowerCase();

                if (status === 'success') {
                    stopped = true;
                    clearInterval(pollingTimer);
                    updateButton('<i class="fas fa-check mr-1"></i>已完成');
                    button.dataset.force = 'true';
                    if (shouldReload) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            button.disabled = false;
                            button.dataset.force = 'true';
                            button.innerHTML = '<i class="fas fa-redo mr-1"></i>重新生成章节';
                            button.style.width = '';
                        }, 1200);
                    }
                } else if (status === 'failure') {
                    stopped = true;
                    clearInterval(pollingTimer);
                    const errorMsg = task.error_message || '章节生成失败，请重试';
                    showToast(errorMsg, 'error');
                    button.disabled = false;
                    button.dataset.force = originalForce;
                    button.innerHTML = originalHtml;
                    button.style.width = '';
                } else {
                    updateButton('<span class="loading loading-spinner loading-xs mr-1"></span>处理中...');
                }
            } catch (error) {
                stopped = true;
                clearInterval(pollingTimer);
                showToast(error.message || '状态查询失败', 'error');
                button.disabled = false;
                button.dataset.force = originalForce;
                button.innerHTML = originalHtml;
                button.style.width = '';
            }
        };

        const pollingTimer = setInterval(poll, 2000);
        poll();
    }

    function jumpToDialogueChapter(button) {
        if (!button) {
            return;
        }

        const start = parseFloat(button.dataset.chapterStart || '0');
        const audioUrl = button.dataset.audioUrl;
        const subtitleUrl = button.dataset.subtitleUrl || null;
        const audioTitle = button.dataset.audioTitle || '';

        if (Number.isNaN(start) || !audioUrl) {
            return;
        }

        if (!window.globalAudioPlayer) {
            showToast('全局播放器未初始化，请刷新页面重试', 'error');
            return;
        }

        const player = window.globalAudioPlayer;
        const seek = () => {
            player.player.currentTime = start;
            player.player.play().catch(() => {});
        };

        if (!player.currentAudio || player.currentAudio.url !== audioUrl) {
            player.player.addEventListener('loadedmetadata', () => {
                seek();
            }, { once: true });
            playFinishedAudio(audioUrl, audioTitle, subtitleUrl);
        } else if (player.player.readyState >= 1) {
            seek();
        } else {
            player.player.addEventListener('loadedmetadata', () => {
                seek();
            }, { once: true });
        }
    }

    function ensureVoiceDefaults(speaker) {
        if (!voiceSettings[speaker]) {
            voiceSettings[speaker] = {};
        }
        voiceSettings[speaker].provider = defaultProvider || 'edge_tts';
    }

    function showDialogueAudioStatus(message, variant = 'info', options = {}) {
        if (!dialogueAudioStatusContainer || !dialogueAudioStatusAlert || !dialogueAudioStatusText) {
            return;
        }

        const { showSpinner = true } = options;

        dialogueAudioStatusContainer.classList.remove('hidden');
        dialogueAudioStatusText.textContent = message;

        if (dialogueAudioStatusSpinner) {
            dialogueAudioStatusSpinner.classList.toggle('hidden', !showSpinner);
        }

        const variants = ['alert-info', 'alert-success', 'alert-error', 'alert-warning', 'alert-primary'];
        dialogueAudioStatusAlert.classList.add('alert');
        dialogueAudioStatusAlert.classList.remove(...variants);
        dialogueAudioStatusAlert.classList.add(`alert-${variant}`);
    }

    function setGenerateAudioButtonLoading(text) {
        if (!generateAudioBtn) {
            return;
        }
        const label = text || '生成中...';
        generateAudioBtn.disabled = true;
        generateAudioBtn.innerHTML = `<span class="loading loading-spinner loading-sm mr-2"></span>${label}`;
    }

    function resetGenerateAudioButton() {
        if (!generateAudioBtn) {
            return;
        }
        generateAudioBtn.disabled = false;
        generateAudioBtn.innerHTML = generateAudioBtnDefaultHtml;
    }

    function stopDialogueAudioPolling() {
        if (dialogueAudioPollingTimer) {
            clearTimeout(dialogueAudioPollingTimer);
            dialogueAudioPollingTimer = null;
        }
    }

    function startDialogueAudioPolling(taskId) {
        if (!taskId) {
            showDialogueAudioStatus('无法获取任务编号，稍后重试。', 'error', { showSpinner: false });
            resetGenerateAudioButton();
            return;
        }

        const statusUrlTemplate = '{% url "task_status" "TASK_ID_PLACEHOLDER" %}';
        const statusUrl = statusUrlTemplate.replace('TASK_ID_PLACEHOLDER', encodeURIComponent(taskId));

        const poll = () => {
            fetch(statusUrl, {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success || !data.task) {
                    stopDialogueAudioPolling();
                    showDialogueAudioStatus('任务状态查询失败，请稍后重试。', 'error', { showSpinner: false });
                    resetGenerateAudioButton();
                    return;
                }

                const task = data.task;
                const status = (task.status || '').toLowerCase();
                const progressMessage = task.progress_message || '';

                if (status === 'success') {
                    stopDialogueAudioPolling();
                    showDialogueAudioStatus('对话音频生成完成，即将刷新页面。', 'success', { showSpinner: false });
                    if (generateAudioBtn) {
                        generateAudioBtn.innerHTML = '<i class="fas fa-check mr-2"></i>生成完成';
                    }
                    setTimeout(() => {
                        window.location.reload();
                    }, 1200);
                    return;
                }

                if (status === 'failure') {
                    stopDialogueAudioPolling();
                    const errorMessage = task.error_message || '对话音频生成失败，请重试。';
                    showDialogueAudioStatus(errorMessage, 'error', { showSpinner: false });
                    resetGenerateAudioButton();
                    return;
                }

                const waitingMessage = progressMessage || (status === 'pending' ? '任务排队中，请稍候...' : '正在生成对话音频...');
                showDialogueAudioStatus(waitingMessage, 'info', { showSpinner: true });

                dialogueAudioPollingTimer = setTimeout(poll, 2000);
            })
            .catch(error => {
                stopDialogueAudioPolling();
                showDialogueAudioStatus('任务状态查询失败：' + error.message, 'error', { showSpinner: false });
                resetGenerateAudioButton();
            });
        };

        poll();
    }

    function getVoiceDisplayName(value) {
        if (!value) {
            return '选择音色';
        }
        const match = availableVoices.find((voice) => voice.value === value);
        return match ? (match.name || match.value) : `${value}（当前选择）`;
    }

    function buildDropdownMenu(speaker) {
        const dropdown = voiceDropdowns.get(speaker);
        if (!dropdown) {
            return;
        }

        const {menu, label, hiddenInput} = dropdown;
        if (!menu || !label || !hiddenInput) {
            return;
        }

        const selectedValue = hiddenInput.value || '';
        menu.classList.add('hidden');
        menu.innerHTML = '';

        if (!availableVoices.length && !selectedValue) {
            const emptyItem = document.createElement('div');
            emptyItem.className = 'px-3 py-2 text-xs text-base-content/60';
            emptyItem.textContent = '暂无音色';
            menu.appendChild(emptyItem);
        }

        availableVoices.forEach((option) => {
            const item = document.createElement('div');
            item.className = 'flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors duration-150';
            item.dataset.voiceValue = option.value;

            const selectBtn = document.createElement('button');
            selectBtn.type = 'button';
            selectBtn.className = 'flex-1 text-left text-sm';
            selectBtn.textContent = option.name || option.value;
            selectBtn.addEventListener('click', () => {
                selectVoice(speaker, option.value, option.name || option.value);
            });

            const previewBtn = document.createElement('button');
            previewBtn.type = 'button';
            previewBtn.className = 'btn btn-ghost btn-xs';
            previewBtn.innerHTML = '<i class="fas fa-headphones"></i>';
            previewBtn.addEventListener('click', async (event) => {
                event.stopPropagation();
                await previewVoice(option.value, previewBtn);
            });

            item.appendChild(selectBtn);
            item.appendChild(previewBtn);

            if (option.value === selectedValue) {
                item.classList.add('bg-primary', 'text-primary-content', 'ring-2', 'ring-primary', 'ring-offset-2', 'ring-offset-base-100');
                selectBtn.classList.add('text-primary-content');
                previewBtn.classList.add('text-primary-content');
                item.dataset.selected = 'true';
            } else {
                item.dataset.selected = 'false';
                item.classList.add('hover:bg-base-200');
            }

            menu.appendChild(item);
        });

        label.textContent = getVoiceDisplayName(selectedValue);
    }

    function selectVoice(speaker, value, labelText) {
        const dropdown = voiceDropdowns.get(speaker);
        if (!dropdown) {
            return;
        }

        const {hiddenInput, label, menu} = dropdown;
        if (hiddenInput) {
            hiddenInput.value = value || '';
        }
        if (label) {
            label.textContent = labelText || getVoiceDisplayName(value);
        }

        ensureVoiceDefaults(speaker);
        if (value) {
            voiceSettings[speaker].voice_name = value;
        } else {
            delete voiceSettings[speaker];
        }

        if (menu) {
            menu.classList.add('hidden');
        }

        buildDropdownMenu(speaker);
    }

    function scrollSelectedIntoView(dropdown) {
        if (!dropdown || !dropdown.menu) {
            return;
        }
        const selectedItem = dropdown.menu.querySelector('[data-selected="true"]');
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest' });
        }
    }

    if (voiceConfigForm) {
        speakers.forEach((speaker) => {
            ensureVoiceDefaults(speaker);
            const dropdown = voiceDropdowns.get(speaker);
            if (dropdown && dropdown.hiddenInput && dropdown.hiddenInput.value) {
                voiceSettings[speaker].voice_name = dropdown.hiddenInput.value;
            }
            buildDropdownMenu(speaker);
        });

        voiceDropdowns.forEach((dropdown) => {
            if (dropdown.toggle) {
                dropdown.toggle.addEventListener('click', () => {
                    if (!dropdown.menu) return;
                    dropdown.menu.classList.toggle('hidden');
                    if (!dropdown.menu.classList.contains('hidden')) {
                        scrollSelectedIntoView(dropdown);
                    }
                });
            }
        });

        document.addEventListener('click', (event) => {
            voiceDropdowns.forEach((dropdown) => {
                if (!dropdown.container.contains(event.target)) {
                    dropdown.menu.classList.add('hidden');
                }
            });
        });
    }

    async function previewVoice(voiceName, triggerButton) {
        const providerValue = defaultProvider || 'edge_tts';

        if (!voiceName) {
            showToast('请先选择音色', 'error');
            return;
        }

        if (!triggerButton) {
            return;
        }

        const originalContent = triggerButton.innerHTML;
        triggerButton.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
        triggerButton.disabled = true;

        try {
            const response = await fetch(`{% url 'tts_preview' %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    provider: providerValue,
                    voice_name: voiceName
                })
            });

            let data;
            try {
                data = await response.json();
            } catch (parseError) {
                throw new Error('服务器返回格式异常');
            }

            if (!response.ok || data.status !== 'ok') {
                throw new Error(data?.message || '试听失败');
            }

            if (window.voicePreviewAudio) {
                try {
                    window.voicePreviewAudio.pause();
                } catch (pauseError) {
                    console.warn('暂停上一段试听音频失败:', pauseError);
                }
            }

            const audio = new Audio(data.audio_url);
            window.voicePreviewAudio = audio;

            try {
                await audio.play();
            } catch (playError) {
                console.error('播放试听音频失败:', playError);
                showToast('浏览器阻止了自动播放，请点击播放按钮重试', 'error');
            }
        } catch (error) {
            console.error('音色试听失败:', error);
            showToast(error.message || '试听失败，请稍后重试', 'error');
        } finally {
            triggerButton.innerHTML = originalContent;
            triggerButton.disabled = false;
        }
    }
    
    // 字幕功能
    let subtitlesLoaded = false;
    
    if (toggleSubtitlesBtn && subtitlesContent) {
      toggleSubtitlesBtn.addEventListener('click', function() {
        if (subtitlesContent.classList.contains('hidden')) {
          // 显示字幕
          subtitlesContent.classList.remove('hidden');
          this.classList.add('btn-active');
          this.querySelector('span').textContent = '隐藏字幕';
          
          // 如果还没加载过字幕，则加载
          if (!subtitlesLoaded) {
            loadSubtitles();
          }
        } else {
          // 隐藏字幕
          subtitlesContent.classList.add('hidden');
          this.classList.remove('btn-active');
          this.querySelector('span').textContent = '查看字幕';
        }
      });
    }
    
    // 加载字幕内容
    function loadSubtitles() {
      const subtitleUrl = '{% if script.subtitle_file and script.subtitle_file.name %}{{ script.subtitle_file.url }}{% endif %}';
      if (!subtitleUrl) return;
      
      fetch(subtitleUrl)
        .then(response => response.text())
        .then(subtitleText => {
          subtitlesText.innerHTML = formatSubtitles(subtitleText);
          subtitlesLoaded = true;
        })
        .catch(error => {
          subtitlesText.innerHTML = `
            <div class="text-center text-red-500">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              加载字幕失败
            </div>
          `;
        });
    }
    
    // 格式化字幕内容
    function formatSubtitles(srtText) {
      if (!srtText.trim()) {
        return '<div class="text-center text-base-content/60">暂无字幕内容</div>';
      }
      
      // 解析SRT格式字幕
      const entries = srtText.trim().split('\n\n');
      let html = '<div class="space-y-2">';
      
      entries.forEach(entry => {
        const lines = entry.trim().split('\n');
        if (lines.length >= 3) {
          const number = lines[0];
          const timestamp = lines[1];
          let text = lines.slice(2).join('\n');
          
          // 清理多余空格
          text = cleanSubtitleText(text);
          
          html += `
            <div class="border-l-2 border-blue-300 pl-3 py-1">
              <div class="text-xs text-base-content/60 mb-1">${timestamp}</div>
              <div class="text-sm">${text}</div>
            </div>
          `;
        }
      });
      
      html += '</div>';
      return html;
    }
    
    // 清理字幕文本中的多余空格
    function cleanSubtitleText(text) {
      // 去除所有空格
      text = text.replace(/\s+/g, '');
      
      return text;
    }
    
    if (chapterButtons.length) {
        chapterButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                jumpToDialogueChapter(btn);
            });
        });
    }

    if (generateChaptersBtn) {
        generateChaptersBtn.addEventListener('click', () => {
            requestChapterGeneration(generateChaptersBtn);
        });
    }

    // 绑定按钮事件
    const editScriptBtn = document.getElementById('edit-script-btn');
    const deleteScriptBtn = document.getElementById('delete-script-btn');
    const publishBtn = document.getElementById('publish-btn');
    
    // 绑定脚本编辑按钮
    if (editScriptBtn) {
        editScriptBtn.addEventListener('click', editScript);
    }
    
    // 绑定发布按钮
    if (publishBtn) {
        publishBtn.addEventListener('click', function() {
            showConfirm('发布音频', '确定要发布这个对话音频吗？', () => {
                const form = document.getElementById('publish-form');
                form.submit();
            });
        });
    }
    
    // 绑定脚本编辑弹窗的保存和取消按钮
    const saveScriptBtn = document.getElementById('save-script-edit');
    const cancelScriptBtn = document.getElementById('cancel-script-edit');
    
    if (saveScriptBtn) {
        saveScriptBtn.addEventListener('click', saveScript);
    }
    
    if (cancelScriptBtn) {
        cancelScriptBtn.addEventListener('click', cancelScriptEdit);
    }
    
    // 绑定删除脚本按钮
    if (deleteScriptBtn) {
        deleteScriptBtn.addEventListener('click', deleteScript);
    }
    
    // 绑定片段按钮事件
    document.querySelectorAll('.preview-segment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const segmentId = this.dataset.segmentId;
            previewSegment(segmentId, this);
        });
    });

    window.addEventListener('beforeunload', () => {
        segmentPreviewObjectUrls.forEach((url) => {
            if (url && url.startsWith('blob:')) {
                URL.revokeObjectURL(url);
            }
        });
        segmentPreviewObjectUrls.clear();
    });

    document.querySelectorAll('.edit-segment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const segmentId = this.dataset.segmentId;
            const speaker = this.dataset.speaker;
            const text = this.dataset.text;
            const sequence = parseInt(this.dataset.sequence);
            editSegment(segmentId, speaker, text, sequence);
        });
    });
    
    document.querySelectorAll('.delete-segment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const segmentId = this.dataset.segmentId;
            deleteSegment(segmentId);
        });
    });
    
    // 绑定表单事件
    if (voiceConfigForm) {
        voiceConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const voiceMapping = {};

            speakers.forEach((speaker) => {
                const dropdown = voiceDropdowns.get(speaker);
                const voiceName = dropdown && dropdown.hiddenInput ? (dropdown.hiddenInput.value || '') : '';

                if (voiceName) {
                    voiceMapping[speaker] = {
                        voice_name: voiceName,
                    };
                } else {
                    voiceMapping[speaker] = {};
                }
            });
            
            fetch('{% url "dialogue_configure_voices" script.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    voice_mapping: voiceMapping
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('音色配置已保存', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast('保存失败：' + result.error, 'error');
                }
            })
            .catch(error => {
                showToast('网络错误：' + error.message, 'error');
            });
        });
    }
    
    if (audioGenerationForm) {
        audioGenerationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const unconfiguredSpeakers = speakers.filter((speaker) => {
                const dropdown = voiceDropdowns.get(speaker);
                return !dropdown || !dropdown.hiddenInput || !dropdown.hiddenInput.value;
            });

            if (unconfiguredSpeakers.length) {
                showToast('请先为以下说话者配置音色：' + unconfiguredSpeakers.join('、'), 'error');
                return;
            }

            // 检查是否已经有音频文件
            const hasAudio = {% if script.audio_file %}true{% else %}false{% endif %};
            
            let confirmMessage = '确定要生成音频吗？';
            if (hasAudio) {
                confirmMessage = '该脚本已经生成过音频文件，重新生成将覆盖原有音频。确定要继续吗？';
            }
            
            showConfirm('生成音频确认', confirmMessage, () => {
                stopDialogueAudioPolling();
                setGenerateAudioButtonLoading('生成中...');
                showDialogueAudioStatus('正在提交生成任务，请稍候...', 'info', { showSpinner: true });

                fetch('{% url "dialogue_generate_audio" script.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showDialogueAudioStatus('任务已提交，正在生成对话音频...', 'info', { showSpinner: true });
                        startDialogueAudioPolling(result.task_id);
                    } else {
                        const errorMessage = result.error || '音频生成任务创建失败';
                        showDialogueAudioStatus(errorMessage, 'error', { showSpinner: false });
                        resetGenerateAudioButton();
                    }
                })
                .catch(error => {
                    showDialogueAudioStatus('网络错误：' + error.message, 'error', { showSpinner: false });
                    resetGenerateAudioButton();
                });
            });
        });
    }
    
    // 滚动提示功能
    const scrollContainer = document.querySelector('.lg\\:col-span-2 .overflow-y-auto');
    if (scrollContainer) {
        scrollContainer.addEventListener('scroll', function() {
            const scrollFade = document.getElementById('scroll-fade');
            if (scrollFade) {
                const { scrollTop, scrollHeight, clientHeight } = scrollContainer;
                const isScrollable = scrollHeight > clientHeight;
                const isNearBottom = scrollTop + clientHeight >= scrollHeight - 20;
                
                if (isScrollable && !isNearBottom) {
                    scrollFade.style.opacity = '1';
                } else {
                    scrollFade.style.opacity = '0';
                }
            }
        });
        
        // 初始检查
        setTimeout(() => {
            const scrollFade = document.getElementById('scroll-fade');
            if (scrollFade) {
                const { scrollTop, scrollHeight, clientHeight } = scrollContainer;
                const isScrollable = scrollHeight > clientHeight;
                const isNearBottom = scrollTop + clientHeight >= scrollHeight - 20;
                
                if (isScrollable && !isNearBottom) {
                    scrollFade.style.opacity = '1';
                } else {
                    scrollFade.style.opacity = '0';
                }
            }
        }, 100);
    }
    
    // 初始化预览检查
    initializePreviewCheck();
});

// 成品音频全局播放功能
function playFinishedAudio(audioUrl, title, subtitleUrl) {
    if (!window.globalAudioPlayer) {
        showToast('全局播放器未初始化，请刷新页面重试', 'error');
        return;
    }
    
    let subtitles = null;
    
    // 如果有字幕文件，获取并解析字幕
    if (subtitleUrl) {
        fetch(subtitleUrl)
            .then(response => response.text())
            .then(subtitleContent => {
                if (subtitleContent.trim()) {
                    subtitles = window.globalAudioPlayer.parseSRTSubtitles(subtitleContent);
                }
                window.globalAudioPlayer.playAudio(audioUrl, title, subtitles);
            })
            .catch(error => {
                console.warn('字幕加载失败:', error);
                // 即使没有字幕也继续播放音频
                window.globalAudioPlayer.playAudio(audioUrl, title, null);
            });
    } else {
        // 无字幕直接播放
        window.globalAudioPlayer.playAudio(audioUrl, title, null);
    }
}
</script>
{% endblock %} 
