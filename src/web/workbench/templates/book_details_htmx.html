{% load custom_filters %}
<!-- å“åº”å¼å®¹å™¨ -->
<div class="container mx-auto px-2 sm:px-4 lg:px-6 xl:px-8">
    <!-- é¡¶éƒ¨å¯¼èˆª - å®Œæ•´å“åº”å¼è®¾è®¡ -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 lg:gap-6 mb-4 sm:mb-6 lg:mb-8">
        <!-- è¿”å›æŒ‰é’® -->
        <div class="flex justify-start order-1 sm:order-1">
            <a href="{% url 'aggregated_audio_segments' %}" class="btn btn-xs sm:btn-sm btn-outline w-full sm:w-auto">
                <i class="fas fa-arrow-left h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i>
                <span class="text-xs sm:text-sm">è¿”å›ä¹¦ç±åˆ—è¡¨</span>
            </a>
        </div>

        <!-- ä¹¦ç±æ ‡é¢˜ -->
        <div class="flex justify-center order-3 sm:order-2">
            <h2 class="text-lg sm:text-xl font-bold bg-primary text-primary-content
                       px-3 py-2 sm:px-4 sm:py-2 rounded-lg text-center w-full sm:w-auto">
                ğŸ“š {{ book_name }}
            </h2>
        </div>

        <!-- éŸ³é¢‘ç»Ÿè®¡ -->
        <div class="flex justify-end order-2 sm:order-3">
            <div class="badge badge-sm sm:badge-md badge-secondary">
                <span class="text-xs sm:text-sm">{{ total_segments }} ä¸ªéŸ³é¢‘</span>
            </div>
        </div>
    </div>

    <!-- åˆ†é¡µç»Ÿè®¡ä¿¡æ¯ - å“åº”å¼å¡ç‰‡å¸ƒå±€ -->
    {% if paginator.count > 0 %}
    <div class="card bg-base-100 shadow-sm mb-4 sm:mb-6">
        <div class="card-body p-3 sm:p-4 lg:p-6">
            <div
                class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4 text-xs sm:text-sm text-base-content opacity-70">
                <!-- æ˜¾ç¤ºä¿¡æ¯ -->
                <div class="flex items-center justify-center md:justify-start space-x-2">
                    <i class="fas fa-file-text h-3 w-3 sm:h-4 sm:w-4"></i>
                    <span>
                        æ˜¾ç¤º {{ page_obj.start_index }}-{{ page_obj.end_index }} / {{ paginator.count }} é¡¹
                    </span>
                </div>

                <!-- é¡µé¢å¤§å°é€‰æ‹©å™¨ -->
                <div class="flex items-center justify-center md:justify-start space-x-2">
                    <span class="whitespace-nowrap">æ¯é¡µæ˜¾ç¤º:</span>
                    <select class="select select-xs sm:select-md w-24 sm:w-28" onchange="changePageSize(this.value)"
                        id="page-size-selector">
                        {% for size in page_size_options %}
                        <option value="{{ size }}" {% if size == page_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                    <span>é¡¹</span>
                </div>

                <!-- é¡µé¢ä¿¡æ¯ -->
                <div class="flex items-center justify-center md:justify-end space-x-2">
                    <span>
                        ç¬¬ {{ page_obj.number }} / {{ paginator.num_pages }} é¡µ
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* è‡ªå®šä¹‰æŠ˜å å›¾æ ‡æ ·å¼ */
        const style = document.createElement('style');
        style.textContent = `
    /* ä¸»æŠ˜å ç»„ä»¶å›¾æ ‡æ—‹è½¬ */
    input[type="checkbox"]:checked + label .collapse-icon {
        transform: rotate(180deg);
    }

    /* æ–‡æœ¬æŠ˜å ç»„ä»¶å›¾æ ‡æ—‹è½¬ */
    input[type="checkbox"]:checked + label .text-collapse-icon {
        transform: rotate(180deg);
    }

    /* æŠ˜å æ ‡é¢˜æ‚¬åœæ•ˆæœ */
    .collapse-title:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    /* ä¼˜åŒ–æŠ˜å è¿‡æ¸¡åŠ¨ç”» */
    .collapse-content {
        transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
    }
`;
        document.head.appendChild(style);

        function changePageSize(newSize) {
            const bookId = parseInt('{{ book_id }}');
            const url = '/workbench/audio/book-details/' + bookId + '/?page=1&page_size=' + newSize;
            htmx.ajax('GET', url, {
                target: '#main-content',
                swap: 'innerHTML',
                pushURL: true
            });
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function jumpToPage() {
            const input = document.getElementById('page-jump-input');
            const pageNum = parseInt(input.value);
            const maxPages = parseInt('{{ paginator.num_pages }}');
            const currentPage = parseInt('{{ page_obj.number }}');
            const bookId = parseInt('{{ book_id }}');
            const pageSize = parseInt('{{ page_size }}');

            if (pageNum >= 1 && pageNum <= maxPages) {
                const url = '/workbench/audio/book-details/' + bookId + '/?page=' + pageNum + '&page_size=' + pageSize;
                htmx.ajax('GET', url, {
                    target: '#main-content',
                    swap: 'innerHTML',
                    pushURL: true
                });
            } else {
                input.value = currentPage;
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ï¼ˆ1-' + maxPages + 'ï¼‰');
            }
        }

        // åœ¨HTMXè¯·æ±‚å®Œæˆåè‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            if (evt.detail.target && evt.detail.target.id === 'main-content') {
                setTimeout(() => {
                    // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰é”šç‚¹
                    const hash = window.location.hash;
                    if (hash && hash.startsWith('#audio-')) {
                        scrollToAudioSegment(hash);
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 100);
            }
        });

        // é”šç‚¹è·³è½¬åŠŸèƒ½
        function scrollToAudioSegment(hash) {
            const targetElement = document.querySelector(hash);
            if (targetElement) {
                // æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ 
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start',
                    inline: 'nearest'
                });

                // æ·»åŠ é«˜äº®æ•ˆæœ
                targetElement.style.transition = 'all 0.3s ease';
                targetElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)'; // è“è‰²èƒŒæ™¯
                targetElement.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                targetElement.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';

                // 3ç§’åç§»é™¤é«˜äº®æ•ˆæœ
                setTimeout(() => {
                    targetElement.style.backgroundColor = '';
                    targetElement.style.borderColor = '';
                    targetElement.style.boxShadow = '';
                }, 3000);

                // è‡ªåŠ¨å±•å¼€æŠ˜å å†…å®¹ä»¥æ˜¾ç¤ºæ›´å¤šä¿¡æ¯
                const checkbox = targetElement.querySelector(`input[id^="segment-checkbox-"]`);
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                }
            }
        }

        // é¡µé¢é¦–æ¬¡åŠ è½½æ—¶æ£€æŸ¥é”šç‚¹
        document.addEventListener('DOMContentLoaded', function () {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#audio-')) {
                setTimeout(() => {
                    scrollToAudioSegment(hash);
                }, 500); // ç»™é¡µé¢æ¸²æŸ“ä¸€äº›æ—¶é—´
            }
        });

        // å“åº”å¼Toasté€šçŸ¥ç³»ç»Ÿ
        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.getElementById('segment-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'segment-toast';
            toast.className = `alert shadow-lg fixed top-4 left-2 right-2 sm:left-4 sm:right-4 md:left-auto md:right-4 md:max-w-sm
                       z-50 transform transition-all duration-300 ease-in-out text-xs sm:text-sm`;

            let alertClass, icon;
            switch (type) {
                case 'success':
                    alertClass = 'alert-success';
                    icon = `<i class="fas fa-check-circle h-4 w-4 sm:h-5 sm:w-5"></i>`;
                    break;
                case 'error':
                    alertClass = 'alert-error';
                    icon = `<i class="fas fa-times-circle h-4 w-4 sm:h-5 sm:w-5"></i>`;
                    break;
                case 'warning':
                    alertClass = 'alert-warning';
                    icon = `<i class="fas fa-exclamation-triangle h-4 w-4 sm:h-5 sm:w-5"></i>`;
                    break;
                default:
                    alertClass = 'alert-info';
                    icon = `<i class="fas fa-info-circle h-4 w-4 sm:h-5 sm:w-5"></i>`;
            }

            toast.className += ` ${alertClass}`;
            toast.innerHTML = `
        <div class="flex-1 flex items-center space-x-2">
            ${icon}
            <span>${message}</span>
        </div>
        <button class="btn btn-xs sm:btn-sm btn-ghost" onclick="this.parentElement.remove()">âœ•</button>
    `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // éŸ³é¢‘ç‰‡æ®µå‘å¸ƒæŒ‰é’®ç‚¹å‡»å¤„ç†å‡½æ•°
        async function handleSegmentPublishClick(segmentId, buttonElement) {
            const originalContent = buttonElement.innerHTML;
            const originalClass = buttonElement.className;
            const originalTitle = buttonElement.title;

            buttonElement.disabled = true;
            buttonElement.innerHTML = `<span class="loading loading-spinner loading-xs"></span>`;
            buttonElement.title = 'å¤„ç†ä¸­...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                    document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                    '{{ csrf_token }}';

                const response = await fetch(`/workbench/audio/publish/${segmentId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    updateSegmentPublishButton(buttonElement, data);
                    showToast(data.message, 'success');
                } else {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalContent;
                    buttonElement.className = originalClass;
                    buttonElement.title = originalTitle;
                    showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å‘å¸ƒæ“ä½œå¤±è´¥:', error);
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalContent;
                buttonElement.className = originalClass;
                buttonElement.title = originalTitle;
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // æ›´æ–°éŸ³é¢‘ç‰‡æ®µå‘å¸ƒæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
        function updateSegmentPublishButton(buttonElement, data) {
            buttonElement.disabled = false;

            if (data.published) {
                buttonElement.className = 'btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-warning touch-manipulation';
                buttonElement.innerHTML = `<i class="fas fa-times h-4 w-4"></i>`;
                buttonElement.title = 'å–æ¶ˆå‘å¸ƒ';
            } else {
                buttonElement.className = 'btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-success touch-manipulation';
                buttonElement.innerHTML = `<i class="fas fa-check h-4 w-4"></i>`;
                buttonElement.title = 'å‘å¸ƒ';
            }
        }
    </script>
    {% endif %}

    <div class="divider my-2 sm:my-4 lg:my-6"></div>

    <!-- éŸ³é¢‘ç‰‡æ®µåˆ—è¡¨ - å“åº”å¼ç½‘æ ¼å¸ƒå±€ -->
    <div class="grid grid-cols-1 gap-3 sm:gap-4 lg:gap-6">
        {% for segment in segments %}
        <div class="card shadow-md hover:shadow-lg transition-all duration-200" data-segment-id="{{ segment.id }}"
            id="audio-{{ segment.id }}">
            <!-- æŠ˜å ç»„ä»¶ - å“åº”å¼æ ‡é¢˜åŒºåŸŸ -->
            <div class="collapse">
                <input type="checkbox" id="segment-checkbox-{{ segment.id }}" />

                <!-- æ ‡é¢˜ä½œä¸ºæŠ˜å è§¦å‘å™¨ - å®Œå…¨å“åº”å¼ -->
                <label for="segment-checkbox-{{ segment.id }}" class="collapse-title cursor-pointer min-h-0
                              transition-colors p-3 sm:p-4 lg:p-5 relative">
                    <!-- è‡ªå®šä¹‰æŠ˜å å›¾æ ‡ -->
                    <div class="absolute right-3 sm:right-4 lg:right-5 top-3 sm:top-4 lg:top-5">
                        <i
                            class="fas fa-chevron-down transition-transform duration-200 text-base-content/60 hover:text-base-content collapse-icon"></i>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 lg:gap-6 items-center pr-8">
                        <!-- æ ‡é¢˜ -->
                        <div class="lg:col-span-9">
                            <h3 class="text-lg sm:text-xl font-bold text-base-content leading-tight break-words">
                                {% if segment.type == 'dialogue_script' %}
                                ğŸ­ {{ segment.title }}
                                {% else %}
                                ğŸ”– {{ segment.title }}
                                {% endif %}
                            </h3>
                            {% if segment.type == 'dialogue_script' and segment.speakers %}
                            <p class="text-sm text-base-content/70 mt-1">{{ segment.speakers|length }}ä¸ªè§’è‰²</p>
                            {% endif %}
                        </div>

                        <!-- æ“ä½œæŒ‰é’®ç»„ - ä¼˜åŒ–æ¡Œé¢ç«¯å¸ƒå±€ -->
                        <div class="lg:col-span-3 flex flex-wrap gap-2 lg:gap-4 justify-end lg:justify-end lg:items-center lg:pr-2"
                            onclick="event.stopPropagation()">
                            <!-- ä¸‹è½½æŒ‰é’® -->
                            {% if segment.file_url %}
                            <a href="{% url 'download_audio' segment_type=segment.type segment_id=segment.id %}" class="btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-primary touch-manipulation flex-shrink-0
                                      hover:scale-110 transition-transform duration-200" title="ä¸‹è½½éŸ³é¢‘ï¼ˆä¿å­˜ä¸ºï¼š{{ segment.title }}.wavï¼‰">
                                <i class="fas fa-download h-4 w-4 "></i>
                            </a>
                            {% endif %}

                            <!-- å­—å¹•ä¸‹è½½æŒ‰é’® -->
                            {% if segment.subtitle_file %}
                            <a href="{% url 'download_subtitle' segment_type=segment.type segment_id=segment.id %}" class="btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-info touch-manipulation flex-shrink-0
                                      hover:scale-110 transition-transform duration-200" title="ä¸‹è½½å­—å¹•ï¼ˆä¿å­˜ä¸ºï¼š{{ segment.title }}.srtï¼‰">
                                <i class="fas fa-closed-captioning h-4 w-4"></i>
                            </a>
                            {% endif %}

                            <!-- å‘å¸ƒ/å–æ¶ˆå‘å¸ƒæŒ‰é’® -->
                            {% if segment.type == 'dialogue_script' %}
                            <!-- å¯¹è¯è„šæœ¬çš„å‘å¸ƒæŒ‰é’® - ç›®å‰åªæ˜¾ç¤ºçŠ¶æ€ï¼Œä¸æä¾›åˆ‡æ¢åŠŸèƒ½ -->
                            {% if segment.published %}
                            <span class="px-2 py-1 text-xs bg-green-100 text-green-600 rounded-full">å·²å‘å¸ƒ</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs bg-blue-100 text-blue-600 rounded-full">å·²ç”Ÿæˆ</span>
                            {% endif %}
                            {% else %}
                            <!-- ä¼ ç»ŸéŸ³é¢‘ç‰‡æ®µçš„å‘å¸ƒåˆ‡æ¢æŒ‰é’® -->
                            {% if segment.published %}
                            <button class="btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-warning touch-manipulation flex-shrink-0
                                           hover:scale-110 transition-transform duration-200" title="å–æ¶ˆå‘å¸ƒ"
                                onclick="handleSegmentPublishClick('{{ segment.id }}', this)">
                                <i class="fas fa-times h-3 w-3 sm:h-4 sm:w-4 lg:h-5 lg:w-5"></i>
                            </button>
                            {% else %}
                            <button class="btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-success touch-manipulation flex-shrink-0
                                           hover:scale-110 transition-transform duration-200" title="å‘å¸ƒ"
                                onclick="handleSegmentPublishClick('{{ segment.id }}', this)">
                                <i class="fas fa-check h-4 w-4"></i>
                            </button>
                            {% endif %}
                            {% endif %}

                            <!-- åˆ é™¤æŒ‰é’® - æ ¹æ®ç±»å‹ä½¿ç”¨ä¸åŒçš„åˆ é™¤é€»è¾‘ -->
                            {% if segment.type == 'dialogue_script' %}
                            <!-- å¯¹è¯è„šæœ¬åˆ é™¤ï¼šè·³è½¬åˆ°å¯¹è¯è„šæœ¬è¯¦æƒ…é¡µé¢ -->
                            <a href="{% url 'dialogue_detail' segment.id %}" class="btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-info touch-manipulation flex-shrink-0
                                          hover:scale-110 transition-transform duration-200" title="ç¼–è¾‘å¯¹è¯è„šæœ¬">
                                <i class="fas fa-edit h-4 w-4 "></i>
                            </a>
                            {% else %}
                            <!-- ä¼ ç»ŸéŸ³é¢‘ç‰‡æ®µåˆ é™¤ -->
                            <button class="btn btn-circle btn-xs sm:btn-sm lg:btn-md btn-error touch-manipulation flex-shrink-0
                                           hover:scale-110 transition-transform duration-200" title="åˆ é™¤éŸ³é¢‘"
                                hx-delete="/workbench/audio/delete/{{ segment.id }}/"
                                hx-confirm="ç¡®å®šè¦åˆ é™¤éŸ³é¢‘ç‰‡æ®µ '{{ segment.title }}' å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚"
                                hx-target="[data-segment-id='{{ segment.id }}']" hx-swap="outerHTML" hx-trigger="click">
                                <i class="fas fa-trash h-4 w-4"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </label>

                <!-- æŠ˜å å†…å®¹ - å“åº”å¼ç½‘æ ¼å¸ƒå±€ -->
                <div class="collapse-content p-0">
                    <div class="card-body p-3 sm:p-4 lg:p-6">
                        <div class="grid grid-cols-1 gap-4">

                            <!-- å…ƒæ•°æ®åŒºåŸŸ -->
                            <div class="w-full">
                                <div class="rounded-lg p-3 sm:p-4 lg:p-5">
                                    <div
                                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 text-xs sm:text-sm text-base-content opacity-70">
                                        <!-- ä¹¦ç±ä¿¡æ¯ -->
                                        <div class="flex items-center justify-center sm:justify-start space-x-2">
                                            <i class="fas fa-book h-3 w-3 sm:h-4 sm:w-4"></i>
                                            <span class="font-medium">ä¹¦ç±:</span>
                                            <span class="truncate">{{ book_name }}</span>
                                        </div>

                                        <!-- é¡µé¢ä¿¡æ¯æˆ–å¯¹è¯è„šæœ¬ç‰¹æ®Šä¿¡æ¯ -->
                                        {% if segment.type == 'dialogue_script' %}
                                        {% if segment.audio_duration %}
                                        <div class="flex items-center justify-center sm:justify-start space-x-2">
                                            <i class="fas fa-clock h-3 w-3 sm:h-4 sm:w-4"></i>
                                            <span class="font-medium">æ—¶é•¿:</span>
                                            <span>{{ segment.audio_duration }}</span>
                                        </div>
                                        {% endif %}
                                        {% else %}
                                        <div class="flex items-center justify-center sm:justify-start space-x-2">
                                            <span class="font-medium">é¡µé¢:</span>
                                            {% if segment.book_page %}
                                            <button
                                                class="bg-secondary text-secondary-content rounded-full w-6 h-6 sm:w-7 sm:h-7
                                                           flex items-center justify-center hover:bg-secondary-focus cursor-pointer
                                                           transition-colors text-xs sm:text-sm font-medium touch-manipulation page-view-btn"
                                                data-segment-id="{{ segment.id }}"
                                                data-book-id="{{ book_id|default:1 }}"
                                                data-names="{{ segment.book_page|stringformat:'s' }}"
                                                onclick="loadPageContent(this); document.getElementById('modal-{{ segment.id }}').showModal()"
                                                title="ç‚¹å‡»æŸ¥çœ‹é¡µé¢å†…å®¹">
                                                {{ forloop.counter|add:page_obj.start_index|add:"-1" }}
                                            </button>
                                            {% else %}
                                            <div class="bg-base-300 text-base-content rounded-full w-6 h-6 sm:w-7 sm:h-7
                                                            flex items-center justify-center text-xs sm:text-sm">
                                                -
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        <!-- æ›´æ–°æ—¶é—´ -->
                                        <div
                                            class="flex items-center justify-center sm:justify-start lg:justify-end space-x-2">
                                            <i class="fas fa-clock h-3 w-3 sm:h-4 sm:w-4"></i>
                                            <span class="font-medium">æ›´æ–°:</span>
                                            <span>{{ segment.updated_at|date:"m-d H:i" }}</span>
                                        </div>
                                    </div>

                                    <!-- æ¨¡æ€å¼¹çª— - å“åº”å¼è®¾è®¡ -->
                                    <dialog id="modal-{{ segment.id }}" class="modal">
                                        <div
                                            class="modal-box bg-base-100 w-11/12 sm:w-3/4 lg:w-1/2 xl:w-2/5 max-w-4xl mx-auto">
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center space-x-2">
                                                    <i class="fas fa-file-alt h-4 w-4 sm:h-5 sm:w-5"></i>
                                                    <h3 class="font-medium text-xs sm:text-sm">é¡µé¢å†…å®¹</h3>
                                                </div>
                                                <form method="dialog">
                                                    <button class="btn btn-sm btn-circle touch-manipulation">âœ•</button>
                                                </form>
                                            </div>
                                            <div id="modal-content-{{ segment.id }}" class="max-h-60 sm:max-h-80 overflow-y-auto
                                                        whitespace-pre-wrap font-mono bg-base-200 rounded-lg
                                                        p-3 sm:p-4 text-xs sm:text-sm">
                                                <div class="htmx-indicator flex justify-center py-4">
                                                    <div class="loading loading-spinner loading-md"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <form method="dialog" class="modal-backdrop">
                                            <button>å…³é—­</button>
                                        </form>
                                    </dialog>
                                </div>
                            </div>

                            {% if segment.subtitle_file %}
                            <div class="w-full">
                                <div class="rounded-lg p-3 sm:p-4 lg:p-5 border border-base-200 bg-base-100">
                                    <div class="flex items-center justify-between gap-2 mb-3" data-chapter-wrapper>
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-list text-primary"></i>
                                            <span class="font-semibold text-sm sm:text-base">ç« èŠ‚å¯¼èˆª</span>
                                        </div>
                                        <button class="btn btn-xs sm:btn-sm btn-outline w-32 sm:w-36 justify-center"
                                            data-generate-url="{% if segment.type == 'dialogue_script' %}{% url 'dialogue_generate_chapters' segment.id %}{% else %}{% url 'generate_audio_chapters' segment.id %}{% endif %}"
                                            data-force="{% if segment.chapters %}true{% else %}false{% endif %}"
                                            onclick="triggerChapterGeneration(this)"
                                            {% if not segment.subtitle_file.url %}disabled{% endif %}>
                                            <i class="fas fa-magic mr-1"></i>
                                            {% if segment.chapters %}é‡æ–°ç”Ÿæˆç« èŠ‚{% else %}ç”Ÿæˆç« èŠ‚{% endif %}
                                        </button>
                                    </div>
                                    {% if segment.chapters %}
                                    <ul class="space-y-2 max-h-48 overflow-y-auto pr-1">
                                        {% for chapter in segment.chapters %}
                                        <li class="p-2 rounded-lg border border-base-200">
                                            <div class="flex items-center justify-between text-xs sm:text-sm font-medium">
                                                <span class="badge badge-outline badge-primary">{{ chapter.start_seconds|format_seconds }}</span>
                                                <span class="flex-1 ml-2 truncate">{{ chapter.title }}</span>
                                            </div>
                                            {% if chapter.summary %}
                                            <p class="mt-1 text-xs sm:text-sm text-base-content/70 leading-relaxed">{{ chapter.summary }}</p>
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <div class="text-xs sm:text-sm text-base-content/60">
                                        æš‚æ— ç« èŠ‚ä¿¡æ¯ï¼Œå¯ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆã€‚
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- æ–‡æœ¬å†…å®¹åŒºåŸŸ -->
                            <div class="w-full">
                                <div class="rounded-lg">
                                    <div class="collapse" id="text-content-{{ segment.id }}">
                                        <input type="checkbox" id="text-checkbox-{{ segment.id }}" />
                                        <label for="text-checkbox-{{ segment.id }}" class="collapse-title font-medium flex items-center justify-between cursor-pointer
                                                      py-2 sm:py-3 px-3 sm:px-4 text-xs sm:text-sm
                                                      min-h-0 touch-manipulation border-b border-gray-100">
                                            <div class="flex items-center">
                                                <i
                                                class="fas fa-align-left h-3 w-3 sm:h-4 sm:w-4 mr-2 text-base-content/60"></i>
                                                <span>æ–‡æœ¬å†…å®¹</span>
                                            </div>
                                            <i
                                                class="fas fa-chevron-down transition-transform duration-200 text-base-content/60 text-collapse-icon"></i>
                                        </label>
                                        <div class="collapse-content max-h-32 sm:max-h-40 lg:max-h-64 overflow-y-auto
                                                    text-xs sm:text-sm px-3 sm:px-4 pb-3 sm:pb-4">
                                            <p class="text-base-content opacity-80 whitespace-pre-wrap leading-relaxed">
                                                {% if segment.type == 'dialogue_script' %}
                                                {{ segment.original_text }}
                                                {% else %}
                                                {{ segment.text }}
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- éŸ³é¢‘æ’­æ”¾åŒºåŸŸ -->
                            <div class="w-full">
                                <div class="rounded-lg p-3 sm:p-4">
                                    <div class="flex items-center justify-center">
                                        <button class="btn btn-primary w-full sm:w-auto sm:btn-md"
                                            onclick="playInGlobalPlayer('{{ segment.file_url }}', '{{ segment.title|escapejs }}', {% if segment.subtitle_file %}{% if segment.subtitle_file.url %}'{{ segment.subtitle_file.url }}'{% else %}null{% endif %}{% else %}null{% endif %})"
                                            title="æ’­æ”¾éŸ³é¢‘">
                                            <i class="fas fa-play h-3 w-3 sm:h-4 sm:w-4 mr-2"></i>
                                            æ’­æ”¾éŸ³é¢‘{% if segment.subtitle_file %}{% if segment.subtitle_file.url %}<i class="fas fa-closed-captioning ml-2 text-yellow-300" title="å«å­—å¹•"></i>{% endif %}{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info shadow-lg">
            <i class="fas fa-info-circle h-5 w-5 sm:h-6 sm:w-6"></i>
            <span class="text-xs sm:text-sm">è¯¥ä¹¦ç±ä¸‹æ²¡æœ‰ä»»ä½•éŸ³é¢‘ç‰‡æ®µã€‚</span>
        </div>
        {% endfor %}
    </div>

    <!-- åˆ†é¡µå¯¼èˆª - ä¸index.htmlä¿æŒä¸€è‡´çš„æ ·å¼ -->
    {% if paginator.num_pages > 1 %}
    <div class="flex justify-center mt-8">
        <div class="join">
            {% if page_obj.has_previous %}
            <button class="join-item btn btn-xs sm:btn-sm"
                hx-get="{% url 'book_details_htmx' book_id=book_id %}?page=1&page_size={{ page_size }}"
                hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                hx-indicator="#loading-indicator">Â«</button>
            <button class="join-item btn btn-xs sm:btn-sm"
                hx-get="{% url 'book_details_htmx' book_id=book_id %}?page={{ page_obj.previous_page_number }}&page_size={{ page_size }}"
                hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                hx-indicator="#loading-indicator">â€¹</button>
            {% endif %}

            {% for num in paginator.page_range %}
            {% if num == page_obj.number %}
            <span class="join-item btn btn-xs sm:btn-sm btn-active">{{ num }}</span>
            {% elif num > page_obj.number|add:'-2' and num < page_obj.number|add:'2' %}
            <button class="join-item btn btn-xs sm:btn-sm"
                hx-get="{% url 'book_details_htmx' book_id=book_id %}?page={{ num }}&page_size={{ page_size }}"
                hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true" hx-indicator="#loading-indicator">
                {{ num }}
            </button>
                {% elif num == 1 or num == paginator.num_pages %}
                <button class="join-item btn btn-xs sm:btn-sm"
                    hx-get="{% url 'book_details_htmx' book_id=book_id %}?page={{ num }}&page_size={{ page_size }}"
                    hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                    hx-indicator="#loading-indicator">{{ num }}</button>
                {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                <span class="join-item btn btn-xs sm:btn-sm btn-disabled">...</span>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <button class="join-item btn btn-xs sm:btn-sm"
                    hx-get="{% url 'book_details_htmx' book_id=book_id %}?page={{ page_obj.next_page_number }}&page_size={{ page_size }}"
                    hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                    hx-indicator="#loading-indicator">â€º</button>
                <button class="join-item btn btn-xs sm:btn-sm"
                    hx-get="{% url 'book_details_htmx' book_id=book_id %}?page={{ paginator.num_pages }}&page_size={{ page_size }}"
                    hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                    hx-indicator="#loading-indicator">Â»</button>
                {% endif %}
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="flex justify-center items-center mt-4 sm:mt-6">
        <div id="loading-indicator" class="htmx-indicator">
            <div class="flex items-center space-x-2">
                <div class="loading loading-spinner loading-sm sm:loading-md"></div>
                <span class="text-xs sm:text-sm">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    const chapterStatusUrlTemplate = '{% url "task_status" "TASK_ID_PLACEHOLDER" %}';

    async function triggerChapterGeneration(button) {
        if (!button || button.disabled) {
            return;
        }

        const requestUrl = button.dataset.generateUrl;
        const force = button.dataset.force === 'true';

        if (!requestUrl) {
            showToast('æœªæ‰¾åˆ°ç« èŠ‚ç”Ÿæˆæ¥å£', 'error');
            return;
        }

        const originalContent = button.innerHTML;
        const originalWidth = button.offsetWidth;
        button.style.width = `${originalWidth}px`;
        button.disabled = true;
        button.innerHTML = '<span class="loading loading-spinner loading-xs mr-1"></span>å¤„ç†ä¸­...';

        try {
            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ force }),
            });

            const data = await response.json();

            if (response.ok && data.success) {
                if (data.task_id) {
                    const statusUrl = chapterStatusUrlTemplate.replace('TASK_ID_PLACEHOLDER', encodeURIComponent(data.task_id));
                    startChapterTaskPolling(button, statusUrl, originalContent, originalWidth, true);
                } else {
                    button.dataset.force = 'true';
                    button.innerHTML = '<i class="fas fa-check mr-1"></i>å·²å®Œæˆ';
                    setTimeout(() => {
                        button.disabled = false;
                        button.dataset.force = 'true';
                        button.innerHTML = '<i class="fas fa-redo mr-1"></i>é‡æ–°ç”Ÿæˆç« èŠ‚';
                        button.style.width = '';
                    }, 1200);
                }
            } else {
                const errorMsg = data.error || data.message || 'ç« èŠ‚ç”Ÿæˆå¤±è´¥';
                showToast(errorMsg, 'error');
                button.disabled = false;
                button.innerHTML = originalContent;
                button.style.width = '';
            }
        } catch (error) {
            showToast('ç« èŠ‚ç”Ÿæˆè¯·æ±‚å¤±è´¥ï¼š' + error.message, 'error');
            button.disabled = false;
            button.innerHTML = originalContent;
            button.style.width = '';
        }
    }

    function startChapterTaskPolling(button, statusUrl, originalContent, originalWidth, shouldReload) {
        const originalForce = button.dataset.force;

        const updateButton = (content, disabled = true) => {
            button.innerHTML = content;
            button.disabled = disabled;
        };

        let stopped = false;

        const poll = async () => {
            if (stopped) {
                return;
            }

            try {
                const response = await fetch(statusUrl, { headers: { 'Accept': 'application/json' } });
                const payload = await response.json();

                if (!response.ok || !payload.success || !payload.task) {
                    throw new Error(payload.error || payload.message || 'çŠ¶æ€æŸ¥è¯¢å¤±è´¥');
                }

                const task = payload.task;
                const status = (task.status || '').toLowerCase();

                if (status === 'success') {
                    stopped = true;
                    clearInterval(pollingTimer);
                    updateButton('<i class="fas fa-check mr-1"></i>å·²å®Œæˆ');
                    button.dataset.force = 'true';
                    if (shouldReload) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            button.disabled = false;
                            button.dataset.force = 'true';
                            button.innerHTML = '<i class="fas fa-redo mr-1"></i>é‡æ–°ç”Ÿæˆç« èŠ‚';
                            button.style.width = '';
                        }, 1200);
                    }
                } else if (status === 'failure') {
                    stopped = true;
                    clearInterval(pollingTimer);
                    const errorMsg = task.error_message || 'ç« èŠ‚ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•';
                    showToast(errorMsg, 'error');
                    button.disabled = false;
                    button.dataset.force = originalForce;
                    button.innerHTML = originalContent;
                    button.style.width = '';
                } else {
                    updateButton('<span class="loading loading-spinner loading-xs mr-1"></span>å¤„ç†ä¸­...');
                }
            } catch (error) {
                stopped = true;
                clearInterval(pollingTimer);
                showToast(error.message || 'çŠ¶æ€æŸ¥è¯¢å¤±è´¥', 'error');
                button.disabled = false;
                button.dataset.force = originalForce;
                button.innerHTML = originalContent;
                button.style.width = '';
            }
        };

        const pollingTimer = setInterval(poll, 2000);
        poll();
    }

    // å…¨å±€æ’­æ”¾å™¨é›†æˆå‡½æ•°
    async function playInGlobalPlayer(audioUrl, title, subtitleUrl) {
        console.log('[é›†æˆ] è°ƒç”¨å…¨å±€æ’­æ”¾å™¨:', { audioUrl, title, subtitleUrl });

        if (!window.globalAudioPlayer) {
            console.error('[é›†æˆ] å…¨å±€æ’­æ”¾å™¨æœªåˆå§‹åŒ–');
            alert('æ’­æ”¾å™¨æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•');
            return;
        }

        let subtitles = null;

        // å¦‚æœæœ‰å­—å¹•æ–‡ä»¶URLï¼Œè·å–å¹¶è§£æå­—å¹•
        if (subtitleUrl) {
            try {
                console.log('[é›†æˆ] æ­£åœ¨è·å–å­—å¹•æ–‡ä»¶:', subtitleUrl);
                const response = await fetch(subtitleUrl);
                console.log('[é›†æˆ] å­—å¹•æ–‡ä»¶å“åº”çŠ¶æ€:', response.status, response.statusText);

                if (response.ok) {
                    const srtContent = await response.text();
                    console.log('[é›†æˆ] å­—å¹•æ–‡ä»¶å†…å®¹é•¿åº¦:', srtContent.length);
                    console.log('[é›†æˆ] å­—å¹•æ–‡ä»¶å†…å®¹é¢„è§ˆ:', srtContent.substring(0, 300));

                    if (srtContent.trim()) {
                        subtitles = window.globalAudioPlayer.parseSRTSubtitles(srtContent);
                        console.log('[é›†æˆ] å­—å¹•è§£æç»“æœ:', subtitles);
                    } else {
                        console.warn('[é›†æˆ] å­—å¹•æ–‡ä»¶ä¸ºç©º');
                    }
                } else {
                    console.warn('[é›†æˆ] å­—å¹•æ–‡ä»¶è·å–å¤±è´¥:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('[é›†æˆ] å­—å¹•æ–‡ä»¶è·å–é”™è¯¯:', error);
            }
        } else {
            console.log('[é›†æˆ] æ²¡æœ‰æä¾›å­—å¹•æ–‡ä»¶URL');
        }

        // æ’­æ”¾éŸ³é¢‘
        console.log('[é›†æˆ] å¼€å§‹æ’­æ”¾ï¼Œå­—å¹•æ•°é‡:', subtitles ? subtitles.length : 0);
        window.globalAudioPlayer.playAudio(audioUrl, title, subtitles);

        // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå½“å‰æ’­æ”¾çŠ¶æ€
        setTimeout(() => {
            console.log('[é›†æˆ] æ’­æ”¾å™¨çŠ¶æ€æ£€æŸ¥:', {
                hasSubtitles: window.globalAudioPlayer.currentSubtitles && window.globalAudioPlayer.currentSubtitles.length > 0,
                subtitleCount: window.globalAudioPlayer.currentSubtitles ? window.globalAudioPlayer.currentSubtitles.length : 0,
                playerVisible: window.globalAudioPlayer.isPlayerVisible()
            });
        }, 1000);
    }

    // Load page content using POST request
    function loadPageContent(button) {
        const segmentId = button.dataset.segmentId;
        const bookId = button.dataset.bookId;
        const names = button.dataset.names;

        const targetElement = document.getElementById(`modal-content-${segmentId}`);

        // Show loading state
        targetElement.innerHTML = '<div class="flex justify-center py-4"><div class="loading loading-spinner loading-md"></div></div>';

        // Make POST request to get page content
        fetch(`/workbench/book/${bookId}/text/pages/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'names': names
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    targetElement.textContent = data.texts;
                } else {
                    targetElement.textContent = 'åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                }
            })
            .catch(error => {
                console.error('Error loading page content:', error);
                targetElement.textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
            });
    }
</script>
