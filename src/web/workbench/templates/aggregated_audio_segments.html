{% extends "base.html" %}

{% block content %}
<!-- Toast notification for success/error messages -->
<div id="toast-container" class="toast toast-top toast-end z-50 hidden">
    <div id="toast-message" class="alert alert-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="toast-text">æ“ä½œæˆåŠŸ!</span>
    </div>
</div>
<div id="main-content" class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-6 text-center bg-primary text-primary-content p-3 rounded-lg shadow-lg">ğŸ“š æˆ‘çš„éŸ³é¢‘åº“</h1>
    
    <!-- Initial Book List View -->
    <div id="book-list-view">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for book_name, segments in aggregated_data.items %}
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 cursor-pointer"
                 hx-get="/workbench/audio/book-details/{{ book_name|slugify|default:'unknown' }}/"
                 hx-target="#main-content"
                 hx-swap="innerHTML"
                 hx-trigger="click">
                <div class="card-body">
                    <h2 class="card-title text-xl font-bold">ğŸ“š {{ book_name }}</h2>
                    <div class="flex justify-between items-center mt-2">
                        <div class="badge badge-primary badge-lg">{{ segments|length }} ä¸ªéŸ³é¢‘</div>
                        <button class="btn btn-sm btn-circle btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full alert alert-info shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>æ‚¨è¿˜æ²¡æœ‰ä»»ä½•éŸ³é¢‘ç‰‡æ®µã€‚è¯·å…ˆä»ä¹¦ç±ä¸­åˆ›å»ºéŸ³é¢‘ã€‚</span>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- å·²ç§»é™¤æ—§çš„ä¹¦ç±è¯¦æƒ…éƒ¨åˆ†ï¼Œç°åœ¨ä½¿ç”¨HTMXåŠ¨æ€åŠ è½½ -->
</div>

<script>
    // å·²å®Œå…¨ç§»é™¤JavaScriptå‡½æ•°ï¼Œæ”¹ä¸ºä½¿ç”¨HTMX
    
    // HTMXäº‹ä»¶å¤„ç† - åœ¨åˆ é™¤éŸ³é¢‘ç‰‡æ®µåæ˜¾ç¤ºæˆåŠŸæç¤º
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.hasAttribute('data-segment-id')) {
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('éŸ³é¢‘ç‰‡æ®µå·²æˆåŠŸåˆ é™¤', 'success');
            
            // å¦‚æœéœ€è¦æ›´æ–°è®¡æ•°ï¼Œå¯ä»¥é€šè¿‡HTMXé‡æ–°åŠ è½½ä¹¦ç±åˆ—è¡¨
            if (evt.detail.pathInfo && evt.detail.pathInfo.requestPath && evt.detail.pathInfo.requestPath.includes('/audio/delete/')) {
                // åœ¨åˆ é™¤æ“ä½œåï¼Œå¦‚æœå½“å‰é¡µé¢æ²¡æœ‰éŸ³é¢‘ç‰‡æ®µäº†ï¼Œè¿”å›ä¹¦ç±åˆ—è¡¨
                if (document.querySelectorAll('.card').length === 0) {
                    // è§¦å‘è¿”å›ä¹¦ç±åˆ—è¡¨çš„HTMXè¯·æ±‚
                    const backButton = document.querySelector('[hx-get="/workbench/audio/books"]');
                    if (backButton) {
                        backButton.click();
                    }
                }
            }
        }
    });
    
    // HTMXäº‹ä»¶å¤„ç† - å¤„ç†åˆ é™¤é”™è¯¯
    document.body.addEventListener('htmx:responseError', function(evt) {
        if (evt.detail.xhr && evt.detail.xhr.status) {
            let errorMsg = 'åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                if (response.message) {
                    errorMsg = `åˆ é™¤å¤±è´¥: ${response.message}`;
                }
            } catch (e) {}
            
            showToast(errorMsg, 'error');
        }
    });
    
    // ç”±äºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨HTMXå®Œå…¨å¤„ç†UIæ›´æ–°ï¼Œè¿™äº›å‡½æ•°ä¸å†éœ€è¦
    
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastMessage = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');
        
        // Set the message and type
        toastText.textContent = message;
        toastMessage.className = `alert alert-${type}`;
        
        // Show the toast
        toastContainer.classList.remove('hidden');
        
        // Hide after 3 seconds
        setTimeout(() => {
            toastContainer.classList.add('hidden');
        }, 3000);
    }
</script>
{% endblock %}
