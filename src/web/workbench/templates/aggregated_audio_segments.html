{% extends "base.html" %}

{% block title %}æˆ‘çš„éŸ³é¢‘åº“ - Book2TTS{% endblock %}

{% block content %}
<!-- Toast notification for success/error messages -->
<div id="toast-container" class="toast toast-top toast-end z-50 hidden">
    <div id="toast-message" class="alert alert-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="toast-text">æ“ä½œæˆåŠŸ!</span>
    </div>
</div>
<div id="main-content" class="container mx-auto p-4">
    <!-- Initial Book List View -->
    <div id="book-list-view">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for book_name, book_data in books_with_ids.items %}
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 cursor-pointer text-base-content"
                hx-get="/workbench/audio/book-details/{{ book_data.book_id }}/" hx-target="#main-content" hx-swap="innerHTML"
                hx-trigger="click">
                <div class="card-body">
                    <h2 class="card-title text-xl font-bold text-base-content">ğŸ“š {{ book_name }}</h2>
                    <div class="flex justify-between items-center mt-2 text-base-content/80">
                        <div class="badge badge-outline badge-lg">{{ book_data.segments|length }} ä¸ªéŸ³é¢‘</div>
                        <button class="btn btn-sm btn-circle btn-ghost">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full alert alert-info shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>æ‚¨è¿˜æ²¡æœ‰ä»»ä½•éŸ³é¢‘ç‰‡æ®µã€‚è¯·å…ˆä»ä¹¦ç±ä¸­åˆ›å»ºéŸ³é¢‘ã€‚</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- å·²ç§»é™¤æ—§çš„ä¹¦ç±è¯¦æƒ…éƒ¨åˆ†ï¼Œç°åœ¨ä½¿ç”¨HTMXåŠ¨æ€åŠ è½½ -->
</div>

{% endblock %}

{% block script %}
<script>
    // å·²å®Œå…¨ç§»é™¤JavaScriptå‡½æ•°ï¼Œæ”¹ä¸ºä½¿ç”¨HTMX

    // HTMXäº‹ä»¶å¤„ç† - åœ¨åˆ é™¤éŸ³é¢‘ç‰‡æ®µåæ˜¾ç¤ºæˆåŠŸæç¤º
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail.target && evt.detail.target.hasAttribute('data-segment-id')) {
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('éŸ³é¢‘ç‰‡æ®µå·²æˆåŠŸåˆ é™¤', 'success');

            // å¦‚æœéœ€è¦æ›´æ–°è®¡æ•°ï¼Œå¯ä»¥é€šè¿‡HTMXé‡æ–°åŠ è½½ä¹¦ç±åˆ—è¡¨
            if (evt.detail.pathInfo && evt.detail.pathInfo.requestPath && evt.detail.pathInfo.requestPath.includes('/audio/delete/')) {
                // åœ¨åˆ é™¤æ“ä½œåï¼Œå¦‚æœå½“å‰é¡µé¢æ²¡æœ‰éŸ³é¢‘ç‰‡æ®µäº†ï¼Œè¿”å›ä¹¦ç±åˆ—è¡¨
                if (document.querySelectorAll('.card').length === 0) {
                    // è§¦å‘è¿”å›ä¹¦ç±åˆ—è¡¨çš„HTMXè¯·æ±‚
                    const backButton = document.querySelector('[hx-get="/workbench/audio/books"]');
                    if (backButton) {
                        backButton.click();
                    }
                }
            }
        }
    });

    // HTMXäº‹ä»¶å¤„ç† - å¤„ç†åˆ é™¤é”™è¯¯
    document.body.addEventListener('htmx:responseError', function (evt) {
        if (evt.detail.xhr && evt.detail.xhr.status) {
            let errorMsg = 'åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                if (response.message) {
                    errorMsg = `åˆ é™¤å¤±è´¥: ${response.message}`;
                }
            } catch (e) {}

            showToast(errorMsg, 'error');
        }
    });

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastMessage = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');

        // Set the message and type
        toastText.textContent = message;
        toastMessage.className = `alert alert-${type}`;

        // Show the toast
        toastContainer.classList.remove('hidden');

        // Hide after 3 seconds
        setTimeout(() => {
            toastContainer.classList.add('hidden');
        }, 3000);
    }

    // å¤„ç†é”šç‚¹è·³è½¬ - æ£€æµ‹ #audio-123 æ ¼å¼çš„é”šç‚¹å¹¶é€šè¿‡HTMXåŠ è½½å¯¹åº”ä¹¦ç±è¯¦æƒ…
    function handleAudioAnchor() {
        const hash = window.location.hash;
        if (hash && hash.startsWith('#audio-')) {
            const audioId = hash.replace('#audio-', '');
            
            // æŸ¥æ‰¾åŒ…å«è¯¥éŸ³é¢‘IDçš„ä¹¦ç±
            {% for book_name, book_data in books_with_ids.items %}
                {% for segment in book_data.segments %}
                    if ('{{ segment.id }}' === audioId) {
                        // æ‰¾åˆ°äº†å¯¹åº”çš„éŸ³é¢‘ç‰‡æ®µï¼Œé€šè¿‡HTMXåŠ è½½ä¹¦ç±è¯¦æƒ…
                        const bookDetailUrl = '/workbench/audio/book-details/{{ book_data.book_id }}/';
                        
                        // è®¾ç½®ä¸€ä¸ªå…¨å±€æ ‡è®°ï¼Œç”¨äºåœ¨HTMXåŠ è½½å®Œæˆåå¤„ç†é”šç‚¹
                        window.pendingAnchorHash = hash;
                        
                        // ä½¿ç”¨HTMXåŠ è½½ä¹¦ç±è¯¦æƒ…å†…å®¹
                        htmx.ajax('GET', bookDetailUrl, {
                            target: '#main-content',
                            swap: 'innerHTML'
                        });
                        
                        return;
                    }
                {% endfor %}
            {% endfor %}
            
            // å¦‚æœæ²¡æ‰¾åˆ°å¯¹åº”çš„éŸ³é¢‘ç‰‡æ®µï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            showToast('æœªæ‰¾åˆ°éŸ³é¢‘ç‰‡æ®µ #' + audioId, 'warning');
            // æ¸…é™¤URLä¸­çš„é”šç‚¹
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
    
    // é”šç‚¹è·³è½¬åŠŸèƒ½ï¼ˆä»book_details_htmx.htmlå¤åˆ¶è¿‡æ¥ï¼‰
    function scrollToAudioSegment(hash) {
        const targetElement = document.querySelector(hash);
        if (targetElement) {
            // æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ 
            targetElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start',
                inline: 'nearest'
            });
            
            // æ·»åŠ é«˜äº®æ•ˆæœ
            targetElement.style.transition = 'all 0.3s ease';
            targetElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)'; // è“è‰²èƒŒæ™¯
            targetElement.style.borderColor = 'rgba(59, 130, 246, 0.3)';
            targetElement.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
            
            // 3ç§’åç§»é™¤é«˜äº®æ•ˆæœ
            setTimeout(() => {
                targetElement.style.backgroundColor = '';
                targetElement.style.borderColor = '';
                targetElement.style.boxShadow = '';
            }, 3000);
            
            // è‡ªåŠ¨å±•å¼€æŠ˜å å†…å®¹ä»¥æ˜¾ç¤ºæ›´å¤šä¿¡æ¯
            const checkbox = targetElement.querySelector(`input[id^="segment-checkbox-"]`);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
            }
        }
    }

    // ç›‘å¬HTMX afterSwapäº‹ä»¶ï¼Œåœ¨å†…å®¹åŠ è½½å®Œæˆåå¤„ç†é”šç‚¹
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'main-content') {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„é”šç‚¹
            if (window.pendingAnchorHash) {
                setTimeout(() => {
                    scrollToAudioSegment(window.pendingAnchorHash);
                    // æ¸…é™¤å¾…å¤„ç†çš„é”šç‚¹æ ‡è®°
                    window.pendingAnchorHash = null;
                }, 200);
            }
        }
    });
    
    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥é”šç‚¹
    document.addEventListener('DOMContentLoaded', function() {
        handleAudioAnchor();
    });
    
    // ç›‘å¬hashchangeäº‹ä»¶ï¼Œå¤„ç†ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹é”šç‚¹çš„æƒ…å†µ
    window.addEventListener('hashchange', function() {
        handleAudioAnchor();
    });
</script>
{% endblock %}
