{% extends "base.html" %}

{% block title %}我的音频库 - Book2TTS{% endblock %}

{% block content %}
<!-- Toast notification for success/error messages -->
<div id="toast-container" class="toast toast-top toast-end z-50 hidden">
    <div id="toast-message" class="alert alert-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="toast-text">操作成功!</span>
    </div>
</div>
<div id="main-content" class="container mx-auto p-4">
    <!-- Initial Book List View -->
    <div id="book-list-view">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for book_name, book_data in books_with_ids.items %}
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 cursor-pointer"
                hx-get="/workbench/audio/book-details/{{ book_data.book_id }}/" hx-target="#main-content" hx-swap="innerHTML"
                hx-trigger="click">
                <div class="card-body">
                    <h2 class="card-title text-xl font-bold">📚 {{ book_name }}</h2>
                    <div class="flex justify-between items-center mt-2">
                        <div class="badge badge-primary badge-lg">{{ book_data.segments|length }} 个音频</div>
                        <button class="btn btn-sm btn-circle btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full alert alert-info shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>您还没有任何音频片段。请先从书籍中创建音频。</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 已移除旧的书籍详情部分，现在使用HTMX动态加载 -->
</div>

{% endblock %}

{% block script %}
<script>
    // 已完全移除JavaScript函数，改为使用HTMX

    // HTMX事件处理 - 在删除音频片段后显示成功提示
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail.target && evt.detail.target.hasAttribute('data-segment-id')) {
            // 显示成功提示
            showToast('音频片段已成功删除', 'success');

            // 如果需要更新计数，可以通过HTMX重新加载书籍列表
            if (evt.detail.pathInfo && evt.detail.pathInfo.requestPath && evt.detail.pathInfo.requestPath.includes('/audio/delete/')) {
                // 在删除操作后，如果当前页面没有音频片段了，返回书籍列表
                if (document.querySelectorAll('.card').length === 0) {
                    // 触发返回书籍列表的HTMX请求
                    const backButton = document.querySelector('[hx-get="/workbench/audio/books"]');
                    if (backButton) {
                        backButton.click();
                    }
                }
            }
        }
    });

    // HTMX事件处理 - 处理删除错误
    document.body.addEventListener('htmx:responseError', function (evt) {
        if (evt.detail.xhr && evt.detail.xhr.status) {
            let errorMsg = '删除时发生错误，请稍后再试';
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                if (response.message) {
                    errorMsg = `删除失败: ${response.message}`;
                }
            } catch (e) {}

            showToast(errorMsg, 'error');
        }
    });

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastMessage = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');

        // Set the message and type
        toastText.textContent = message;
        toastMessage.className = `alert alert-${type}`;

        // Show the toast
        toastContainer.classList.remove('hidden');

        // Hide after 3 seconds
        setTimeout(() => {
            toastContainer.classList.add('hidden');
        }, 3000);
    }

    // 处理锚点跳转 - 检测 #audio-123 格式的锚点并通过HTMX加载对应书籍详情
    function handleAudioAnchor() {
        const hash = window.location.hash;
        if (hash && hash.startsWith('#audio-')) {
            const audioId = hash.replace('#audio-', '');
            
            // 查找包含该音频ID的书籍
            {% for book_name, book_data in books_with_ids.items %}
                {% for segment in book_data.segments %}
                    if ('{{ segment.id }}' === audioId) {
                        // 找到了对应的音频片段，通过HTMX加载书籍详情
                        const bookDetailUrl = '/workbench/audio/book-details/{{ book_data.book_id }}/';
                        
                        // 设置一个全局标记，用于在HTMX加载完成后处理锚点
                        window.pendingAnchorHash = hash;
                        
                        // 使用HTMX加载书籍详情内容
                        htmx.ajax('GET', bookDetailUrl, {
                            target: '#main-content',
                            swap: 'innerHTML'
                        });
                        
                        return;
                    }
                {% endfor %}
            {% endfor %}
            
            // 如果没找到对应的音频片段，显示提示信息
            showToast('未找到音频片段 #' + audioId, 'warning');
            // 清除URL中的锚点
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
    
    // 锚点跳转功能（从book_details_htmx.html复制过来）
    function scrollToAudioSegment(hash) {
        const targetElement = document.querySelector(hash);
        if (targetElement) {
            // 滚动到目标元素
            targetElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start',
                inline: 'nearest'
            });
            
            // 添加高亮效果
            targetElement.style.transition = 'all 0.3s ease';
            targetElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)'; // 蓝色背景
            targetElement.style.borderColor = 'rgba(59, 130, 246, 0.3)';
            targetElement.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
            
            // 3秒后移除高亮效果
            setTimeout(() => {
                targetElement.style.backgroundColor = '';
                targetElement.style.borderColor = '';
                targetElement.style.boxShadow = '';
            }, 3000);
            
            // 自动展开折叠内容以显示更多信息
            const checkbox = targetElement.querySelector(`input[id^="segment-checkbox-"]`);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
            }
        }
    }

    // 监听HTMX afterSwap事件，在内容加载完成后处理锚点
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'main-content') {
            // 检查是否有待处理的锚点
            if (window.pendingAnchorHash) {
                setTimeout(() => {
                    scrollToAudioSegment(window.pendingAnchorHash);
                    // 清除待处理的锚点标记
                    window.pendingAnchorHash = null;
                }, 200);
            }
        }
    });
    
    // 页面加载完成后检查锚点
    document.addEventListener('DOMContentLoaded', function() {
        handleAudioAnchor();
    });
    
    // 监听hashchange事件，处理用户手动修改锚点的情况
    window.addEventListener('hashchange', function() {
        handleAudioAnchor();
    });
</script>
{% endblock %}
