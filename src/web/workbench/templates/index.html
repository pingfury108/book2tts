{% extends "base.html" %}


{% block content %}
<div class="flex p-2 w-full h-screen bg-base-100">
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg">
      <div class="container text-center p-2">
        <h2 class="text-lg font-bold mb-2">ğŸ“š {{ title }}</h2>
        <div role="tablist" class="tabs tabs-bordered">
          <a role="tab" class="tab tab-active" id="tab_toc"
             hx-get="{% url 'toc' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >
            TOC ({{ tocs|length }} ç« )
          </a>
          <a role="tab" class="tab" id="tab_page"
             hx-get="{% url 'pages' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >é¡µé¢ ({{ pages|length }} é¡µ)</a>
        </div>
      </div>
        <div class="container pt-2 h-full" id="toc" hx-get="/workbench/book/{{ book_id }}/toc" hx-trigger="load">
          </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-3/5 overflow-hidden rounded-lg bg-base-100 shadow-lg">
        <div class="container text-center pt-2 bg-primary text-primary-content rounded-t-lg">
            <h3 class="text-lg font-sans font-bold py-2">ğŸ“„ å†…å®¹</h3>
        </div>
        <div class="container p-2 flex flex-col h-[calc(100%-3.5rem)]" id="context">
            <div class="mb-2 p-2 bg-base-200 rounded-lg">
                <div class="flex justify-between items-center">
                    <div class="badge badge-primary p-3 text-sm">ç« èŠ‚å†…å®¹</div>
                    <div class="flex gap-2">
                        <button class="btn btn-xs btn-outline" id="format-text-btn"
                                hx-post="{% url 'reformat' %}"
                                hx-include="#src-text"
                                hx-target="#src-text"
                                hx-swap="innerHTML">è‡ªåŠ¨æ’ç‰ˆ</button>
                        <button class="btn btn-xs btn-outline" id="increase-font-btn">æ”¾å¤§å­—ä½“</button>
                        <button class="btn btn-xs btn-outline" id="decrease-font-btn">ç¼©å°å­—ä½“</button>
                    </div>
                </div>
            </div>
            <textarea class="textarea textarea-bordered flex-grow w-full bg-base-100 font-serif" id="src-text" name="texts" placeholder="é€‰æ‹©å·¦ä¾§ç›®å½•æˆ–é¡µé¢ä»¥åŠ è½½å†…å®¹..." style="font-size: 16px; line-height: 1.6; min-height: 0;"></textarea>
        </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg bg-base-200 shadow-lg">
      <div class="container text-center p-2 bg-secondary text-secondary-content rounded-t-lg">
            <h3 class="font-bold py-2">âš™ï¸ æ§åˆ¶é¢æ¿</h3>
        </div>
        <div class="overflow-y-auto h-[calc(100vh-4rem)] space-y-3 p-2">
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">ğŸ“š ä¹¦ç±ä¿¡æ¯</h3>
                    <div class="flex flex-col gap-1">
                        <div>
                            <label class="font-bold">ä¹¦å:</label>
                            <span class="text-sm">{{ title }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">ğŸ“ å†…å®¹å¤„ç†</h3>
                    <form class="form-control gap-2"
                          hx-post="{% url 'reformat' %}"
                          hx-target="#context"
                          hx-include="#src-text">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary w-full">
                            æ’ç‰ˆå†…å®¹
                        </button>
                    </form>
                </div>
            </div>
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">ğŸ”Š éŸ³é¢‘å¤„ç†</h3>
                    <div class="space-y-1">
                        <select class="select select-bordered w-full" id="tts-provider">
                            <option disabled selected>TTS ä¾›åº”å•†</option>
                            <option value="azure">azure</option>
                            <option value="edge-tts" selected>edge-tts</option>
                        </select>
                        <select class="select select-bordered w-full" id="voice-model"
                                hx-get="{% url 'voice_list' %}"
                                hx-trigger="load"
                                hx-target="this"
                                hx-swap="innerHTML">
                            <option disabled selected>è¯­éŸ³æ¨¡å‹</option>
                        </select>
                        <input type="text" id="audio-title-input" class="input input-bordered w-full" placeholder="éŸ³é¢‘æ ‡é¢˜ï¼ˆé€‰å¡«ï¼‰" />
                        <button class="btn btn-primary w-full" id="synthesize-btn">åˆæˆéŸ³é¢‘</button>
                        <div id="audio-player-container" class="hidden mt-2 p-3 bg-base-300 rounded-lg">
                            <div class="text-center mb-2">
                                <span class="badge badge-primary" id="audio-title"></span>
                            </div>
                            <audio id="audio-player" controls class="w-full"></audio>
                            <div id="audio-status" class="text-sm mt-1 text-center font-medium text-success"></div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-secondary flex-1" id="download-btn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                ä¸‹è½½
                            </button>
                            <button class="btn btn-accent flex-1" id="publish-btn" disabled
                                    hx-post="{% url 'aggregated_audio_segments' %}"
                                    hx-trigger="click"
                                    hx-target="body"
                                    hx-push-url="true">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                å‘å¸ƒ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}

<script>
 // ä¸ºæ‰€æœ‰ HTMX è¯·æ±‚æ·»åŠ  CSRF ä»¤ç‰Œ
 document.body.addEventListener('htmx:configRequest', function(evt) {
   evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
 });

 // Font size adjustment with HTMX compatibility
 function setupFontSizeButtons() {
   // ä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶å‡ºé”™
   document.getElementById('increase-font-btn')?.addEventListener('click', function() {
     const textarea = document.getElementById('src-text');
     const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
     textarea.style.fontSize = (currentSize + 2) + 'px';
   });
   
   document.getElementById('decrease-font-btn')?.addEventListener('click', function() {
     const textarea = document.getElementById('src-text');
     const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
     if (currentSize > 12) {
       textarea.style.fontSize = (currentSize - 2) + 'px';
     }
   });
 }

 // åˆå§‹è®¾ç½®
 document.addEventListener('DOMContentLoaded', setupFontSizeButtons);
 
 // HTMXå†…å®¹æ›´æ–°åé‡æ–°è®¾ç½®
 document.body.addEventListener('htmx:afterSwap', setupFontSizeButtons);
 
 // Track page/TOC changes when content is loaded via HTMX
 document.body.addEventListener('htmx:afterRequest', function(evt) {
   // If this was a tab switch (target is #toc)
   if (evt.detail.target && evt.detail.target.id === 'toc') {
     // Reset current page name when switching tabs
     currentPageName = '';
     currentPageId = '';
     
     // Update placeholder
     const titleInput = document.getElementById('audio-title-input');
     if (titleInput) {
       titleInput.placeholder = 'éŸ³é¢‘æ ‡é¢˜ï¼ˆé€‰å¡«ï¼‰';
     }
   }
   
   // If this was a text content load from TOC or page
   if (evt.detail.target && evt.detail.target.id === 'src-text') {
     // Find which item is currently highlighted
     const activeItem = document.querySelector('#toc a.bg-base-300');
     if (activeItem) {
       currentPageName = activeItem.textContent.trim();
       
       // Get the actual page ID
       if (activeTab === 'tab_toc' && activeItem.hasAttribute('data-toc-href')) {
         currentPageId = activeItem.getAttribute('data-toc-href');
       } else if (activeTab === 'tab_page' && activeItem.hasAttribute('data-page-number')) {
         currentPageId = activeItem.getAttribute('data-page-number');
       } else {
         // Try to extract from hx-get URL
         const hxGetAttr = activeItem.getAttribute('hx-get');
         if (hxGetAttr) {
           // Extract page/toc parameter from URL query string
           const urlParams = new URLSearchParams(hxGetAttr.split('?')[1] || '');
           const pageParam = urlParams.get('page');
           const tocParam = urlParams.get('toc');
           currentPageId = pageParam || tocParam || '';
         }
       }
       
       // Update the audio title input placeholder
       const titleInput = document.getElementById('audio-title-input');
       if (titleInput) {
         titleInput.placeholder = `éŸ³é¢‘æ ‡é¢˜ (é»˜è®¤: ${currentPageName})`;
       }
     }
   }
 });
 
 // é¡µé¢/ç›®å½•é¡¹ç‚¹å‡»å¤„ç†
 let currentPageName = ''; // Display name
 let currentPageId = ''; // Actual page ID
 let activeTab = 'tab_toc'; // Track which tab is currently active
 
 document.body.addEventListener('click', function(event) {
   // Handle tab switching
   if (event.target.id === 'tab_toc') {
     event.target.classList.add('tab-active');
     document.getElementById("tab_page").classList.remove('tab-active');
     activeTab = 'tab_toc';
   };
   if (event.target.id === 'tab_page') {
     event.target.classList.add('tab-active');
     document.getElementById("tab_toc").classList.remove('tab-active');
     activeTab = 'tab_page';
   }
   
   // Track clicked TOC or page item - works for both tabs since content is loaded into #toc
   if (event.target.closest('#toc a')) {
     const clickedItem = event.target.closest('#toc a');
     
     // Remove highlight from all items
     document.querySelectorAll('#toc a').forEach(item => {
       item.classList.remove('bg-base-300');
     });
     
     // Add highlight to clicked item
     clickedItem.classList.add('bg-base-300');
     
     // Store the page/TOC name
     currentPageName = clickedItem.textContent.trim();
     
     // Get the actual page ID
     if (activeTab === 'tab_toc' && clickedItem.hasAttribute('data-toc-href')) {
       currentPageId = clickedItem.getAttribute('data-toc-href');
     } else if (activeTab === 'tab_page' && clickedItem.hasAttribute('data-page-number')) {
       currentPageId = clickedItem.getAttribute('data-page-number');
     } else {
       // Try to extract from hx-get URL
       const hxGetAttr = clickedItem.getAttribute('hx-get');
       if (hxGetAttr) {
         // Extract page/toc parameter from URL query string
         const urlParams = new URLSearchParams(hxGetAttr.split('?')[1] || '');
         const pageParam = urlParams.get('page');
         const tocParam = urlParams.get('toc');
         currentPageId = pageParam || tocParam || '';
       }
     }
     
     // Update the audio title input placeholder
     const titleInput = document.getElementById('audio-title-input');
     if (titleInput) {
       titleInput.placeholder = `éŸ³é¢‘æ ‡é¢˜ (é»˜è®¤: ${currentPageName})`;
     }
   }
 });

 // Audio synthesis functionality
 document.getElementById('synthesize-btn').addEventListener('click', function() {
   const text = document.getElementById('src-text').value;
   const voiceModel = document.getElementById('voice-model').value;
   const bookId = '{{ book_id }}';
   const title = '{{ title }}';
   const audioTitle = document.getElementById('audio-title-input').value;
   
   // Use the page ID for book_page field, but store the display name as well
   const bookPage = currentPageId;
   const pageDisplayName = currentPageName;
   
   if (!text) {
     alert('è¯·å…ˆé€‰æ‹©æˆ–è¾“å…¥æ–‡æœ¬å†…å®¹');
     return;
   }
   
   if (!voiceModel || voiceModel === 'è¯­éŸ³æ¨¡å‹') {
     alert('è¯·é€‰æ‹©è¯­éŸ³æ¨¡å‹');
     return;
   }
   
   // Show loading state
   const synthesizeBtn = document.getElementById('synthesize-btn');
   const originalBtnText = synthesizeBtn.textContent;
   synthesizeBtn.textContent = 'åˆæˆä¸­...';
   synthesizeBtn.disabled = true;
   
   // Prepare form data
   const formData = new FormData();
   formData.append('text', text);
   formData.append('voice_name', voiceModel);
   formData.append('book_id', bookId);
   formData.append('title', title);
   formData.append('book_page', bookPage);
   formData.append('page_display_name', pageDisplayName);
   formData.append('audio_title', audioTitle);
   formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
   
   // Send request to synthesize audio
   fetch('{% url "synthesize_audio" %}', {
     method: 'POST',
     body: formData,
   })
   .then(response => response.json())
   .then(data => {
     synthesizeBtn.textContent = originalBtnText;
     synthesizeBtn.disabled = false;
     
     if (data.status === 'success') {
       // Show audio player
       const audioPlayerContainer = document.getElementById('audio-player-container');
       audioPlayerContainer.classList.remove('hidden');
       
       // Set audio source
       const audioPlayer = document.getElementById('audio-player');
       audioPlayer.src = data.audio_url;
       audioPlayer.dataset.audioId = data.audio_id;
       
       // Update audio title display with the page name
       const titleText = audioTitle || currentPageName || 'å½“å‰å†…å®¹';
       document.getElementById('audio-title').textContent = titleText;
       document.getElementById('audio-status').textContent = 'âœ… éŸ³é¢‘åˆæˆæˆåŠŸ';
       
       // Enable download and publish buttons
       document.getElementById('download-btn').disabled = false;
       document.getElementById('publish-btn').disabled = false;
     } else {
       alert('éŸ³é¢‘åˆæˆå¤±è´¥: ' + data.message);
     }
   })
   .catch(error => {
     synthesizeBtn.textContent = originalBtnText;
     synthesizeBtn.disabled = false;
     alert('å‘ç”Ÿé”™è¯¯: ' + error);
   });
 });
 
 // Download audio button
 document.getElementById('download-btn').addEventListener('click', function() {
   const audioPlayer = document.getElementById('audio-player');
   const audioTitle = document.getElementById('audio-title').textContent;
   if (audioPlayer.src) {
     // Create a temporary link to download the audio
     const link = document.createElement('a');
     link.href = audioPlayer.src;
     link.download = `${audioTitle || 'éŸ³é¢‘'}_${new Date().getTime()}.wav`;
     document.body.appendChild(link);
     link.click();
     document.body.removeChild(link);
   }
 });
</script>

{% endblock %}
