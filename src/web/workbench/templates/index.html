{% extends "base.html" %}


{% block content %}
<div class="flex p-2 w-full h-screen bg-base-100">
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg">
      <div class="container text-center p-2">
        <h2 class="text-lg font-bold mb-2">ğŸ“š {{ title }}</h2>
        <div role="tablist" class="tabs tabs-bordered">
          <a role="tab" class="tab tab-active" id="tab_toc"
             hx-get="{% url 'toc' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >
            TOC ({{ tocs|length }} ç« )
          </a>
          <a role="tab" class="tab" id="tab_page"
             hx-get="{% url 'pages' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >é¡µé¢ ({{ pages|length }} é¡µ)</a>
        </div>
      </div>
        <div class="container pt-2 overflow-y-auto" style="height: calc(100% - 5rem);" id="toc" hx-get="{% url 'toc' book_id=book_id %}" hx-trigger="load">
        </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-3/5 overflow-hidden rounded-lg bg-base-100 shadow-lg">
        <div class="container text-center pt-2 bg-primary text-primary-content rounded-t-lg">
            <h3 class="text-lg font-sans font-bold py-2">ğŸ“„ å†…å®¹</h3>
        </div>
        <div class="container p-2 flex flex-col h-[calc(100%-3.5rem)]" id="context">
            <div class="mb-2 p-2 bg-base-200 rounded-lg">
                <div class="flex justify-between items-center">
                    <div class="badge badge-primary p-3 text-sm">ç« èŠ‚å†…å®¹</div>
                    <div class="flex gap-2">
                        <button class="btn btn-xs btn-outline" id="format-text-btn">è‡ªåŠ¨æ’ç‰ˆ</button>
                        <button class="btn btn-xs btn-outline" id="increase-font-btn">æ”¾å¤§å­—ä½“</button>
                        <button class="btn btn-xs btn-outline" id="decrease-font-btn">ç¼©å°å­—ä½“</button>
                    </div>
                </div>
            </div>
            <textarea class="textarea textarea-bordered flex-grow w-full bg-base-100 font-serif" id="src-text" name="texts" placeholder="é€‰æ‹©å·¦ä¾§ç›®å½•æˆ–é¡µé¢ä»¥åŠ è½½å†…å®¹..." style="font-size: 16px; line-height: 1.6; min-height: 0;"></textarea>
        </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg bg-base-200 shadow-lg">
      <div class="container text-center p-2 bg-secondary text-secondary-content rounded-t-lg">
            <h3 class="font-bold py-2">âš™ï¸ æ§åˆ¶é¢æ¿</h3>
        </div>
        <div class="overflow-y-auto h-[calc(100vh-4rem)] space-y-3 p-2">
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">ğŸ“š ä¹¦ç±ä¿¡æ¯</h3>
                    <div class="flex flex-col gap-1">
                        <div>
                            <label class="font-bold">ä¹¦å:</label>
                            <span class="text-sm">{{ title }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">ğŸ”Š éŸ³é¢‘å¤„ç†</h3>
                    <div class="space-y-1">
                        <select class="select select-bordered w-full" id="tts-provider">
                            <option disabled selected>TTS ä¾›åº”å•†</option>
                            <option value="azure">azure</option>
                            <option value="edge-tts" selected>edge-tts</option>
                        </select>
                        <select class="select select-bordered w-full" id="voice-model"
                                hx-get="{% url 'voice_list' %}"
                                hx-trigger="load"
                                hx-target="this"
                                hx-swap="innerHTML">
                            <option disabled selected>è¯­éŸ³æ¨¡å‹</option>
                        </select>
                        <input type="text" id="audio-title-input" class="input input-bordered w-full" placeholder="éŸ³é¢‘æ ‡é¢˜ï¼ˆé€‰å¡«ï¼‰" />
                        <button class="btn btn-primary w-full" id="synthesize-btn">åˆæˆéŸ³é¢‘</button>
                        <div id="audio-player-container" class="hidden mt-2 p-3 bg-base-300 rounded-lg">
                            <div class="text-center mb-2">
                                <span class="badge badge-primary" id="audio-title"></span>
                            </div>
                            <audio id="audio-player" controls class="w-full"></audio>
                            <div id="audio-status" class="text-sm mt-1 text-center font-medium text-success"></div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-secondary flex-1" id="download-btn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                ä¸‹è½½
                            </button>
                            <button class="btn btn-accent flex-1" id="publish-btn" disabled
                                    hx-target="this"
                                    hx-swap="outerHTML">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                å‘å¸ƒ
                            </button>
                        </div>
                        <div id="publish-status" class="text-sm mt-1 text-center font-medium"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
 // ä¸ºæ‰€æœ‰ HTMX è¯·æ±‚æ·»åŠ  CSRF ä»¤ç‰Œ
 document.body.addEventListener('htmx:configRequest', function(evt) {
   evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
 });

 // Font size adjustment with HTMX compatibility
 function setupFontSizeButtons() {
   // ä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶å‡ºé”™
   document.getElementById('increase-font-btn')?.addEventListener('click', function() {
     const textarea = document.getElementById('src-text');
     const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
     textarea.style.fontSize = (currentSize + 2) + 'px';
   });
   
   document.getElementById('decrease-font-btn')?.addEventListener('click', function() {
     const textarea = document.getElementById('src-text');
     const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
     if (currentSize > 12) {
       textarea.style.fontSize = (currentSize - 2) + 'px';
     }
   });
 }

 // åˆå§‹åŒ–å­—ä½“è°ƒæ•´æŒ‰é’®
 $(document).ready(function() {
   setupFontSizeButtons();
 });

 // æ·»åŠ è°ƒè¯•æ—¥å¿—
 function logState(message) {
   console.log(`[State] ${message}:`, {
     currentPageName: window.currentPageName,
     currentPageId: window.currentPageId,
     activeTab: window.activeTab,
     currentAudioSegmentId: window.currentAudioSegmentId
   });
 }

 // é¡µé¢/ç›®å½•é¡¹ç‚¹å‡»å¤„ç†
 window.currentPageName = window.currentPageName || ''; // Display name
 window.currentPageId = window.currentPageId || ''; // Actual page ID
 window.activeTab = window.activeTab || 'tab_toc'; // Track which tab is currently active
 window.currentAudioSegmentId = window.currentAudioSegmentId || 0;

 // Tab switching
 $(document).ready(function() {
   $('#tab_toc').on('click', function() {
     $(this).addClass('tab-active');
     $('#tab_page').removeClass('tab-active');
     window.activeTab = 'tab_toc';
     logState('Tab switched to TOC');
   });

   $('#tab_page').on('click', function() {
     $(this).addClass('tab-active');
     $('#tab_toc').removeClass('tab-active');
     window.activeTab = 'tab_page';
     logState('Tab switched to Page');
   });
 });

 // éŸ³é¢‘åˆæˆå’Œç®¡ç†
 document.getElementById('synthesize-btn')?.addEventListener('click', async function() {
   const textContent = document.getElementById('src-text').value;
   const voiceModel = document.getElementById('voice-model').value;
   const audioTitle = document.getElementById('audio-title-input').value || window.currentPageName;
   
   if (!textContent || !voiceModel) {
     alert('è¯·å…ˆé€‰æ‹©è¯­éŸ³æ¨¡å‹å¹¶è¾“å…¥æ–‡æœ¬');
     return;
   }
   
   // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   this.innerHTML = '<span class="loading loading-spinner loading-xs"></span> åˆæˆä¸­...';
   this.disabled = true;
   
   try {
     const response = await fetch(`{% url 'synthesize_audio' %}`, {
       method: 'POST',
       headers: {
         'Content-Type': 'application/x-www-form-urlencoded',
         'X-CSRFToken': '{{ csrf_token }}'
       },
       body: new URLSearchParams({
         text: textContent,
         voice_name: voiceModel,
         book_id: '{{ book_id }}',
         title: audioTitle || 'æœªå‘½åéŸ³é¢‘',
         book_page: window.currentPageId || '',
         page_display_name: window.currentPageName || '',
         audio_title: audioTitle || ''
       })
     });
     
     const data = await response.json();
     console.log('Audio synthesis response:', data);
     
     if (data.status === 'success') {
       // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
       document.getElementById('audio-player-container').classList.remove('hidden');
       const audioPlayer = document.getElementById('audio-player');
       audioPlayer.src = data.audio_url;
       document.getElementById('audio-title').textContent = audioTitle || 'æœªå‘½åéŸ³é¢‘';
       document.getElementById('audio-status').textContent = 'åˆæˆæˆåŠŸï¼';
       
       // å¯ç”¨ä¸‹è½½å’Œå‘å¸ƒæŒ‰é’®
       const downloadBtn = document.getElementById('download-btn');
       downloadBtn.disabled = false;
       downloadBtn.onclick = function() {
         const a = document.createElement('a');
         a.href = data.audio_url;
         a.download = (audioTitle || 'éŸ³é¢‘') + '.wav';
         document.body.appendChild(a);
         a.click();
         document.body.removeChild(a);
       };
       
       const publishBtn = document.getElementById('publish-btn');
       publishBtn.disabled = false;
       window.currentAudioSegmentId = data.audio_id;
       console.log("Setting audio segment ID:", window.currentAudioSegmentId);
       
       // Update hx-post attribute and explicitly tell HTMX to process the element
       const publishUrl = `/workbench/audio/publish/${window.currentAudioSegmentId}/`;
       console.log("Setting publish URL to:", publishUrl);
       publishBtn.setAttribute('hx-post', publishUrl);
       
       // Ensure HTMX processes the updated attributes
       if (typeof htmx !== 'undefined') {
         htmx.process(publishBtn);
       }

       logState('Audio synthesized');
     } else {
       document.getElementById('audio-status').textContent = 'åˆæˆå¤±è´¥ï¼š' + data.message;
     }
   } catch (error) {
     console.error('éŸ³é¢‘åˆæˆé”™è¯¯:', error);
     document.getElementById('audio-status').textContent = 'åˆæˆå¤±è´¥ï¼š' + error.message;
   } finally {
     // æ¢å¤æŒ‰é’®çŠ¶æ€
     this.innerHTML = 'åˆæˆéŸ³é¢‘';
     this.disabled = false;
   }
 });

 // æ·»åŠ  HTMX è¯·æ±‚å’Œå“åº”ç›‘å¬ (ä¿ç•™ä»¥å…¼å®¹å…¶ä»–HTMXåŠŸèƒ½)
 document.body.addEventListener('htmx:beforeRequest', function(evt) {
   console.log('HTMX beforeRequest:', {
     target: evt.detail.target?.id,
     path: evt.detail.path,
     verb: evt.detail.verb
   });
 });

 // å®‰å…¨åœ°æ¸…ç†èµ„æºçš„å‡½æ•°
 function cleanupFormatting() {
   // å®‰å…¨åœ°å…³é—­äº‹ä»¶æº
   if (formatEventSource) {
     try {
       formatEventSource.close();
     } catch (e) {
       console.error('å…³é—­äº‹ä»¶æºæ—¶å‡ºé”™:', e);
     }
     formatEventSource = null;
   }
   
   // é‡ç½®çŠ¶æ€
   isFormattingInProgress = false;
   
   // æ¢å¤æŒ‰é’®çŠ¶æ€
   const formatBtn = document.getElementById('format-text-btn');
   if (formatBtn) {
     formatBtn.disabled = false;
     formatBtn.innerHTML = 'è‡ªåŠ¨æ’ç‰ˆ';
   }
   
   // å¦‚æœæ–‡æœ¬æ¡†æ˜¯ç©ºçš„ï¼Œä½†è¿‡ç¨‹ä¸­æ²¡æ”¶åˆ°ä»»ä½•å†…å®¹ï¼Œæ¢å¤åŸæ–‡æœ¬
   const textarea = document.getElementById('src-text');
   if (textarea && !formattedText && textarea.value.startsWith('æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆ')) {
     textarea.value = textContent || '';
   }
 }
 
 // è‡ªåŠ¨æ’ç‰ˆæŒ‰é’®ç‚¹å‡»å¤„ç†
 document.getElementById('format-text-btn')?.addEventListener('click', function() {
   const textContent = document.getElementById('src-text').value;
   const formatBtn = this;
   
   if (!textContent.trim()) {
     alert('è¯·å…ˆè¾“å…¥æˆ–åŠ è½½æ–‡æœ¬å†…å®¹');
     return;
   }
   
   // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   formatBtn.disabled = true;
   formatBtn.innerHTML = 'æ­£åœ¨æ’ç‰ˆ...';
   
   // å…³é—­ä»»ä½•å·²å­˜åœ¨çš„è¿æ¥
   cleanupFormatting();
   
   // é‡ç½®æ–‡æœ¬ç´¯ç§¯å˜é‡å’ŒçŠ¶æ€
   formattedText = '';
   isFormattingInProgress = true;
   
   // æ¸…ç©ºæ–‡æœ¬æ¡†å¹¶æ˜¾ç¤ºåˆå§‹æç¤º
   const textarea = document.getElementById('src-text');
   if (textarea) {
     textarea.value = 'æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆï¼Œè¯·ç¨å€™...';
     console.log('æ–‡æœ¬åŒºåŸŸå·²æ¸…ç©º');
   }

   try {
     // å»ºç«‹SSEè¿æ¥å¹¶å‘é€POSTè¯·æ±‚
     console.log('å‘é€POSTè¯·æ±‚å¹¶å»ºç«‹SSEè¿æ¥');
     
     // æ·»åŠ è¿›åº¦æ˜¾ç¤ºå˜é‡
     let progressCount = 0;
     const progressInterval = setInterval(() => {
       if (isFormattingInProgress) {
         progressCount = (progressCount + 1) % 4;
         const dots = '.'.repeat(progressCount);
         formatBtn.innerHTML = `æ’ç‰ˆä¸­${dots}`;
         
         // å¦‚æœæ²¡æœ‰æ”¶åˆ°ä»»ä½•æ ¼å¼åŒ–æ–‡æœ¬ï¼Œç»§ç»­æ˜¾ç¤ºç­‰å¾…æ¶ˆæ¯
         if (!formattedText && textarea) {
           textarea.value = `æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆï¼Œè¯·ç¨å€™${dots}`;
         }
       } else {
         clearInterval(progressInterval);
       }
     }, 500);
     
     // é¦–å…ˆåˆ›å»ºPOSTè¯·æ±‚å‘é€æ–‡æœ¬å†…å®¹
     fetch('{% url "reformat" %}', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/x-www-form-urlencoded',
         'X-CSRFToken': '{{ csrf_token }}'
       },
       body: new URLSearchParams({
         texts: textContent
       })
     }).then(response => {
       // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
       if (!response.ok) {
         throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
       }
       
       // åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶æºè¯»å–æµå¼å“åº”ç»“æœ
       const reader = response.body.getReader();
       const decoder = new TextDecoder();
       
       // è¯»å–å“åº”æµ
       function readStream() {
         reader.read().then(({ done, value }) => {
           if (done) {
             console.log('æµè¯»å–å®Œæˆ');
             cleanupFormatting();
             return;
           }
           
           // å¤„ç†æ”¶åˆ°çš„æ•°æ®å—
           const chunk = decoder.decode(value, { stream: true });
           // ç®€åŒ–æ—¥å¿—ï¼Œé¿å…è¾“å‡ºå¤§é‡åŸå§‹æ•°æ®
           console.log('æ¥æ”¶åˆ°æ•°æ®å—...');
           
           // åˆ†å‰²SSEæ¶ˆæ¯
           const messages = chunk.split('\n\n');
           for (const message of messages) {
             if (!message.trim()) continue;
             
             // æå–äº‹ä»¶ç±»å‹å’Œæ•°æ®
             const eventMatch = message.match(/^event: (.+)$/m);
             
             // ä¿®æ”¹æ•°æ®æå–æ–¹å¼ï¼Œæ”¯æŒå¤šè¡Œå†…å®¹
             let dataContent = '';
             
             // æ£€æŸ¥äº‹ä»¶ç±»å‹
             if (eventMatch) {
               const eventType = eventMatch[1];
               console.log('å¤„ç†äº‹ä»¶ç±»å‹:', eventType);
               
               // æå–æ‰€æœ‰dataå¼€å¤´çš„è¡Œ
               const dataLines = message.split('\n').filter(line => line.startsWith('data: '));
               
               // ä»æ¯è¡Œæå–æ•°æ®å†…å®¹ï¼ˆå»æ‰"data: "å‰ç¼€ï¼‰
               if (dataLines.length > 0) {
                 dataContent = dataLines.map(line => line.substring(6)).join('\n');
               }
               
               if (dataContent) {
                 if (eventType === 'message') {
                   // æ•°æ®å†…å®¹å³ä¸ºæ ¼å¼åŒ–åçš„æ–‡æœ¬ï¼Œæ— éœ€å†è§£æJSON
                   console.log('æ”¶åˆ°æ ¼å¼åŒ–æ–‡æœ¬:', dataContent.substring(0, 50) + '...');
                   
                   // ç´¯ç§¯æ ¼å¼åŒ–åçš„æ–‡æœ¬
                   formattedText += dataContent;
                   if (textarea) {
                     textarea.value = formattedText;
                     textarea.scrollTop = textarea.scrollHeight;
                   }
                 } else if (eventType === 'complete') {
                   console.log('æ ¼å¼åŒ–å®Œæˆ');
                 } else if (eventType === 'error') {
                   console.error('æ ¼å¼åŒ–é”™è¯¯:', dataContent);
                   alert('è‡ªåŠ¨æ’ç‰ˆå¤±è´¥: ' + dataContent);
                 }
               }
             }
           }
           
           // ç»§ç»­è¯»å–æµ
           readStream();
         }).catch(error => {
           console.error('è¯»å–æµé”™è¯¯:', error);
           cleanupFormatting();
         });
       }
       
       // å¼€å§‹è¯»å–æµ
       readStream();
     }).catch(error => {
       console.error('å‘é€æ–‡æœ¬é”™è¯¯:', error);
       cleanupFormatting();
       alert('è‡ªåŠ¨æ’ç‰ˆå¤±è´¥: ' + error.message);
     });
   } catch (error) {
     console.error('æ•è·åˆ°çš„é”™è¯¯:', error);
     cleanupFormatting();
   }
 });
</script>

{% endblock %}
