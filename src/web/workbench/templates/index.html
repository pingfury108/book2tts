{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }} - åˆ¶ä½œå·¥ä½œå° - Book2TTS{% endblock %}

{% block content %}
<div id="desktop-warning" class="hidden w-full bg-base-200 text-base-content text-center py-12 min-h-[calc(100vh-4rem)] flex items-center justify-center">
  <div class="max-w-md mx-auto space-y-3 px-6">
    <h2 class="text-2xl font-bold">å»ºè®®ä½¿ç”¨ç”µè„‘ç«¯è®¿é—®</h2>
    <p class="text-sm">å½“å‰å±å¹•å°ºå¯¸ä¸è¶³ä»¥æ­£å¸¸ä½¿ç”¨åˆ¶ä½œå·¥ä½œå°ã€‚è¯·åœ¨å®½å±è®¾å¤‡ä¸Šæ‰“å¼€ä»¥è·å¾—å®Œæ•´ä½“éªŒã€‚</p>
  </div>
</div>

<div class="flex p-2 w-full h-screen bg-base-100" id="workbench-root">
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg flex flex-col pb-2">
      <div class="container text-center p-2">
        <div role="tablist" class="tabs tabs-bordered">
          <a role="tab" class="tab tab-active" id="tab_toc"
             hx-get="{% url 'toc' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >
            TOC ({{ tocs|length }} ç« )
          </a>
          <a role="tab" class="tab" id="tab_page"
             hx-get="{% url 'pages' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >é¡µé¢ ({{ pages|length }} é¡µ)</a>
        </div>
      </div>
        <div class="container pt-2 flex-grow overflow-y-auto" id="toc" hx-get="{% url 'toc' book_id=book_id %}" hx-trigger="load">
        </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-3/5 overflow-hidden rounded-lg shadow-lg">
        <div class="container p-2 flex flex-col h-full" id="context">
            <div class="mb-2 p-2 rounded-lg">
                <div class="flex justify-between items-center">
                    <div class="flex gap-2 items-center">
                        <div class="badge badge-primary p-3 text-sm">ç« èŠ‚å†…å®¹</div>
                        <div class="badge badge-outline p-3 text-xs" id="word-count-badge">0 å­—</div>
                        <!-- é¡µé¢å›¾ç‰‡æŸ¥çœ‹æŒ‰é’® - åªåœ¨æ‰«æç‰ˆPDFæ—¶æ˜¾ç¤º -->
                        <button class="btn btn-xs btn-outline" id="view-page-image-btn" style="display: none;" title="æŸ¥çœ‹é¡µé¢åŸå›¾">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-4.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                            </svg>
                            æŸ¥çœ‹åŸå›¾
                        </button>
                        <button class="btn btn-xs btn-outline" id="view-original-btn" title="æŸ¥çœ‹åŸå§‹å†…å®¹">
                            <i class="fas fa-eye"></i>
                            æŸ¥çœ‹åŸæ–‡
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-xs btn-outline" id="format-text-btn">è‡ªåŠ¨æ’ç‰ˆ</button>
                        <button class="btn btn-xs btn-outline" id="translate-text-btn">ç¿»è¯‘</button>
                        <button class="btn btn-xs btn-outline" id="increase-font-btn">æ”¾å¤§å­—ä½“</button>
                        <button class="btn btn-xs btn-outline" id="decrease-font-btn">ç¼©å°å­—ä½“</button>
                    </div>
                </div>
            </div>
            <textarea class="textarea textarea-bordered flex-grow w-full bg-base-100 font-serif" id="src-text" name="texts" placeholder="é€‰æ‹©å·¦ä¾§ç›®å½•æˆ–é¡µé¢ä»¥åŠ è½½å†…å®¹..." style="font-size: 16px; line-height: 1.6; min-height: 0;"></textarea>
        </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg shadow-lg">
        <div class="flex flex-col h-full">
            <div class="px-2 pt-2">
                <div role="tablist" class="tabs tabs-bordered" id="right-panel-tabs">
                    <a role="tab" class="tab tab-active" id="tab_production" data-target="#production-panel" href="#">åˆ¶ä½œé…ç½®</a>
                    <a role="tab" class="tab" id="tab_account" data-target="#account-panel" href="#">è´¦æˆ·æƒç›Š</a>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2">
                <div id="production-panel" class="space-y-3 right-panel-tab">
                    <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div class="card-body p-4">
                            <div class="flex flex-col gap-1">
                                <div>
                                    <span class="text-sm">{{ title }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div class="card-body p-4">
                            <div class="space-y-2" id="page-audio-status">
                                <div class="text-sm text-gray-500 text-center">
                                    é€‰æ‹©é¡µé¢æŸ¥çœ‹éŸ³é¢‘ç”ŸæˆçŠ¶æ€
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div class="card-body p-4">
                            <div class="space-y-3">
                                <div class="relative" id="voice-dropdown">
                                    <button type="button" id="voice-dropdown-toggle" class="btn btn-outline btn-sm w-full justify-between">
                                        <span id="voice-dropdown-label">è¯­éŸ³æ¨¡å‹</span>
                                        <i class="fas fa-chevron-down text-xs"></i>
                                    </button>
                                    <div id="voice-dropdown-menu" class="hidden absolute z-20 mt-1 w-full max-h-60 overflow-y-auto rounded-md border border-base-300 bg-base-100 shadow-lg"></div>
                                </div>
                                <select class="hidden" id="voice-model"
                                        hx-get="{% url 'voice_list' %}"
                                        hx-trigger="load"
                                        hx-target="this"
                                        hx-swap="innerHTML">
                                    <option disabled selected>è¯­éŸ³æ¨¡å‹</option>
                                </select>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium">é€Ÿåº¦:</label>
                                    <input type="range" min="-50" max="50" value="0" class="range range-xs flex-1" id="audio-rate-range" />
                                    <span class="text-sm w-12 text-center" id="audio-rate-value">100%</span>
                                    <input type="hidden" id="audio-rate" value="+0%" />
                                </div>
                                <div class="flex flex-col gap-3">
                                    <input type="text" id="audio-title-input" class="input input-bordered input-sm w-full text-sm" placeholder="éŸ³é¢‘æ ‡é¢˜ï¼ˆé€‰å¡«ï¼‰" />
                                    <button class="btn btn-outline btn-sm w-full text-sm" id="create-dialogue-btn">
                                        <i class="fas fa-comments h-4 w-4 mr-1"></i>
                                        ç”Ÿæˆå¤šè§’è‰²éŸ³é¢‘
                                    </button>
                                    <button class="btn btn-primary btn-sm w-full text-sm" id="synthesize-btn">
                                        <i class="fas fa-wave-square h-4 w-4 mr-1"></i>
                                        åˆæˆéŸ³é¢‘
                                    </button>
                                </div>
                                <div id="audio-player-container" class="hidden mt-2 p-3 rounded-lg">
                                    <div class="text-center mb-3">
                                        <div class="inline-block bg-primary text-primary-content px-3 py-2 rounded-lg text-sm font-medium leading-relaxed max-w-full break-words" id="audio-title" style="min-height: 2.5rem; line-height: 1.4;"></div>
                                    </div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <audio id="audio-player" controls class="flex-1"></audio>
                                        <!-- å…¨å±€æ’­æ”¾å™¨æŒ‰é’® -->
                                        <button 
                                            id="global-play-from-workbench" 
                                            class="btn btn-sm btn-primary"
                                            title="åœ¨å…¨å±€æ’­æ”¾å™¨ä¸­æ’­æ”¾"
                                            style="display: none;"
                                            onclick="playWorkbenchAudioInGlobal()">
                                            <i class="fas fa-external-link-alt h-3 w-3"></i>
                                        </button>
                                    </div>
                                    <div id="audio-status" class="text-sm mt-1 text-center font-medium text-success"></div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button class="btn btn-secondary btn-sm flex-1 text-sm" id="download-btn" disabled>
                                        <i class="fas fa-download h-4 w-4 mr-1"></i>
                                        ä¸‹è½½
                                    </button>
                                    <button class="btn btn-accent btn-sm flex-1 text-sm" id="publish-btn" disabled
                                            onclick="handlePublishClick()">
                                        <i class="fas fa-upload h-4 w-4 mr-1"></i>
                                        å‘å¸ƒ
                                    </button>
                                </div>
                                <div id="publish-status" class="text-sm mt-1 text-center font-medium"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="account-panel" class="space-y-3 right-panel-tab hidden">
                    <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div class="card-body p-4">
                            <div class="space-y-2" id="quota-info"
                                 hx-get="{% url 'get_user_quota' %}"
                                 hx-trigger="load, refresh"
                                 hx-target="this"
                                 hx-swap="innerHTML">
                                <div class="flex items-center justify-center">
                                    <span class="loading loading-spinner loading-sm"></span>
                                    <span class="ml-2 text-sm">åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è´­ä¹°è”ç³»ä¿¡æ¯ -->
                    <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div class="card-body p-4">
                            <div class="space-y-3">
                                <div class="text-sm text-base-content/80">
                                    <p class="mb-2">å¦‚éœ€è´­ä¹°ç§¯åˆ†æˆ–é‡ç½®é…é¢ï¼Œè¯·è”ç³»å®¢æœï¼š</p>
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-comment text-primary mr-2"></i>
                                        <span>å¾®ä¿¡å®¢æœ: qzz18580256051</span>
                                    </div>
                                    <div class="flex items-center mb-3">
                                        <i class="fas fa-envelope text-primary mr-2"></i>
                                        <span>é‚®ç®±: pingfury@outlook.com</span>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline btn-primary w-full" onclick="showWeChatQR()">
                                    <i class="fas fa-qrcode mr-1"></i>
                                    å¾®ä¿¡æ‰«ç æ·»åŠ 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¿»è¯‘è¯­è¨€é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="translate-language-modal" class="modal">
  <div class="modal-box max-w-md">
    <h3 class="font-bold text-lg mb-4 text-center">ğŸŒ é€‰æ‹©ç¿»è¯‘è¯­è¨€</h3>
    <div class="space-y-3" id="language-options">
      <button class="btn btn-outline w-full justify-start text-left" data-lang="en">
        <span class="mr-2">ğŸ‡ºğŸ‡¸</span>
        <span class="flex-1">English (è‹±è¯­)</span>
      </button>
      <button class="btn btn-outline w-full justify-start text-left" data-lang="zh">
        <span class="mr-2">ğŸ‡¨ğŸ‡³</span>
        <span class="flex-1">ä¸­æ–‡ (Chinese)</span>
      </button>
      <button class="btn btn-outline w-full justify-start text-left" data-lang="ja">
        <span class="mr-2">ğŸ‡¯ğŸ‡µ</span>
        <span class="flex-1">æ—¥æœ¬èª (Japanese)</span>
      </button>
      <button class="btn btn-outline w-full justify-start text-left" data-lang="ko">
        <span class="mr-2">ğŸ‡°ğŸ‡·</span>
        <span class="flex-1">í•œêµ­ì–´ (Korean)</span>
      </button>
      <button class="btn btn-outline w-full justify-start text-left" data-lang="fr">
        <span class="mr-2">ğŸ‡«ğŸ‡·</span>
        <span class="flex-1">FranÃ§ais (French)</span>
      </button>
      <button class="btn btn-outline w-full justify-start text-left" data-lang="de">
        <span class="mr-2">ğŸ‡©ğŸ‡ª</span>
        <span class="flex-1">Deutsch (German)</span>
      </button>
      <button class="btn btn-outline w-full justify-start text-left" data-lang="es">
        <span class="mr-2">ğŸ‡ªğŸ‡¸</span>
        <span class="flex-1">EspaÃ±ol (Spanish)</span>
      </button>
      <button class="btn btn-outline w-full justify-start text-left" data-lang="ru">
        <span class="mr-2">ğŸ‡·ğŸ‡º</span>
        <span class="flex-1">Ğ ÑƒÑÑĞºĞ¸Ğ¹ (Russian)</span>
      </button>
    </div>
    <div class="modal-action">
      <button class="btn" onclick="closeTranslateLanguageModal()">å–æ¶ˆ</button>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeTranslateLanguageModal()"></div>
</div>

<!-- é¡µé¢å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div id="page-image-modal" class="modal">
  <div class="modal-box max-w-6xl max-h-[90vh]">
    <h3 class="font-bold text-lg mb-4">é¡µé¢åŸå›¾</h3>
    <div id="page-images-container" class="flex justify-center">
      <!-- å›¾ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
    <div id="image-loading" class="flex justify-center items-center h-64">
      <span class="loading loading-spinner loading-lg"></span>
      <span class="ml-2">åŠ è½½é¡µé¢å›¾ç‰‡ä¸­...</span>
    </div>
    <div class="modal-action">
      <button class="btn" onclick="document.getElementById('page-image-modal').classList.remove('modal-open')">å…³é—­</button>
    </div>
</div>
<div class="modal-backdrop" onclick="document.getElementById('page-image-modal').classList.remove('modal-open')"></div>
</div>

<!-- åŸå§‹å†…å®¹æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div id="original-content-modal" class="modal">
  <div class="modal-box max-w-6xl w-[96vw] max-h-[92vh] overflow-hidden">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-bold text-lg" id="original-modal-title">åŸå§‹å†…å®¹</h3>
      <button class="btn btn-sm btn-circle btn-ghost" id="close-original-modal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="original-content-container" class="bg-base-200 border border-base-300 rounded-lg overflow-hidden">
      <div id="original-content-loading" class="flex justify-center items-center h-48" style="display:none;">
        <span class="loading loading-spinner loading-lg"></span>
      </div>
      <div id="original-content-error" class="alert alert-error m-4" style="display:none;"></div>
      <div id="original-content-body" class="space-y-4" style="display:none;"></div>
    </div>
    <div class="modal-action hidden">
      <button class="btn" id="dismiss-original-modal">å…³é—­</button>
    </div>
  </div>
  <div class="modal-backdrop" id="original-modal-backdrop"></div>
</div>

<!-- å¾®ä¿¡äºŒç»´ç æ¨¡æ€æ¡† -->
<div id="wechat-qr-modal" class="modal">
  <div class="modal-box max-w-md">
    <h3 class="font-bold text-lg mb-4 text-center">ğŸ’¬ å¾®ä¿¡è´­ä¹°å’¨è¯¢</h3>
    <div class="text-center">
      <div class="bg-white p-4 rounded-lg inline-block shadow-md">
        <img src="{% static 'images/wechat_qr.png' %}" alt="å¾®ä¿¡äºŒç»´ç " class="w-48 h-48 mx-auto">
      </div>
      <p class="text-sm text-base-content/70 mt-3">æ‰«ç æ·»åŠ å¾®ä¿¡ï¼Œè·å–è´­ä¹°æœåŠ¡å’ŒæŠ€æœ¯æ”¯æŒ</p>
      <p class="text-xs text-base-content/60 mt-2">å¾®ä¿¡å·: qzz18580256051</p>
    </div>
    <div class="modal-action">
      <button class="btn" onclick="closeWeChatQR()">å…³é—­</button>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeWeChatQR()"></div>
</div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
 // ä¸ºæ‰€æœ‰ HTMX è¯·æ±‚æ·»åŠ  CSRF ä»¤ç‰Œ
 document.body.addEventListener('htmx:configRequest', function(evt) {
   evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
 });

 // é‡ç½®éŸ³é¢‘æ˜¾ç¤ºåŠŸèƒ½
 function resetAudioDisplay() {
   // éšè—éŸ³é¢‘æ’­æ”¾å™¨å®¹å™¨
   const playerContainer = document.getElementById('audio-player-container');
   if (playerContainer) {
     playerContainer.classList.add('hidden');
   }
   
   // é‡ç½®éŸ³é¢‘æ’­æ”¾å™¨æºå’Œæ˜¾ç¤º
   const audioPlayer = document.getElementById('audio-player');
   if (audioPlayer) {
     audioPlayer.src = '';
     audioPlayer.pause();
     audioPlayer.style.display = ''; // æ¢å¤æ˜¾ç¤º
   }
   
   // éšè—å…¨å±€æ’­æ”¾å™¨æŒ‰é’®
   const globalPlayBtn = document.getElementById('global-play-from-workbench');
  if (globalPlayBtn) {
    globalPlayBtn.style.display = 'none';
    globalPlayBtn.dataset.audioUrl = '';
    globalPlayBtn.dataset.audioTitle = '';
    delete globalPlayBtn.dataset.subtitleUrl;
    delete globalPlayBtn.dataset.chaptersUrl;
    globalPlayBtn.cachedSubtitles = null;
    globalPlayBtn.cachedChapters = null;
  }
   
   // é‡ç½®ç›¸å…³çŠ¶æ€å’ŒæŒ‰é’®
   const audioTitle = document.getElementById('audio-title');
   if (audioTitle) {
     audioTitle.textContent = '';
   }
   
   const audioStatus = document.getElementById('audio-status');
   if (audioStatus) {
     audioStatus.textContent = '';
     audioStatus.innerHTML = ''; // æ¸…é™¤æ‰€æœ‰HTMLå†…å®¹
     audioStatus.className = 'text-sm mt-1 text-center font-medium text-success'; // é‡ç½®ä¸ºé»˜è®¤æ ·å¼
   }
   
   // ç¦ç”¨ä¸‹è½½å’Œå‘å¸ƒæŒ‰é’®
   const downloadBtn = document.getElementById('download-btn');
   if (downloadBtn) {
     downloadBtn.disabled = true;
   }
   
   const publishBtn = document.getElementById('publish-btn');
   if (publishBtn) {
     publishBtn.disabled = true;
   }
   
   // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€
   const synthesizeBtn = document.getElementById('synthesize-btn');
   if (synthesizeBtn) {
     synthesizeBtn.innerHTML = 'åˆæˆéŸ³é¢‘';
     synthesizeBtn.disabled = false;
   }
   
   // é‡ç½®å½“å‰éŸ³é¢‘ID
   window.currentAudioSegmentId = 0;
 }

 // Font size adjustment with HTMX compatibility
 function setupFontSizeButtons() {
   // å»é™¤å¯é€‰é“¾æ“ä½œç¬¦ï¼Œä½¿ç”¨å¸¸è§„nullæ£€æŸ¥
   const increaseFontBtn = document.getElementById('increase-font-btn');
   if (increaseFontBtn) {
     increaseFontBtn.addEventListener('click', function() {
       const textarea = document.getElementById('src-text');
       const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
       textarea.style.fontSize = (currentSize + 2) + 'px';
     });
   }
   
   const decreaseFontBtn = document.getElementById('decrease-font-btn');
   if (decreaseFontBtn) {
     decreaseFontBtn.addEventListener('click', function() {
       const textarea = document.getElementById('src-text');
       const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
       if (currentSize > 12) {
         textarea.style.fontSize = (currentSize - 2) + 'px';
       }
     });
   }
 }

 // å­—æ•°ç»Ÿè®¡åŠŸèƒ½ï¼ˆå¸¦é˜²é‡å¤æœºåˆ¶ï¼‰
 let lastUpdateTime = 0;
 let lastCountValue = -1;
 let lastTextValue = ''; // æ·»åŠ æ–‡æœ¬å†…å®¹ç¼“å­˜ï¼Œä¾›å®šæœŸæ£€æŸ¥ä½¿ç”¨
 
 function updateWordCount() {
   const textarea = document.getElementById('src-text');
   const wordCountBadge = document.getElementById('word-count-badge');
   
   if (textarea && wordCountBadge) {
     const text = textarea.value;
     // è®¡ç®—å­—ç¬¦æ•°ï¼ˆå»é™¤ç©ºç™½å­—ç¬¦ï¼‰
     const charCount = text.replace(/\s/g, '').length;
     const currentTime = Date.now();
     
     // é˜²é‡å¤æœºåˆ¶ï¼šå¦‚æœå­—æ•°ç›¸åŒä¸”æ—¶é—´é—´éš”å°äº2000msï¼Œåˆ™è·³è¿‡æ›´æ–°
     if (charCount === lastCountValue && (currentTime - lastUpdateTime) < 2000) {
       return;
     }
     
     wordCountBadge.textContent = `${charCount} å­—`;
     lastUpdateTime = currentTime;
     lastCountValue = charCount;
     lastTextValue = text; // åŒæ­¥æ›´æ–°æ–‡æœ¬ç¼“å­˜
     
     // è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
     if (charCount > 0) {
       console.log('[WordCount] å­—æ•°å·²æ›´æ–°:', charCount, 'æ—¶é—´:', new Date().toLocaleTimeString());
     }
   }
 }

// åˆå§‹åŒ–å­—ä½“è°ƒæ•´æŒ‰é’®å’Œå­—æ•°ç»Ÿè®¡
$(document).ready(function() {
  setupFontSizeButtons();
  setupRightPanelTabs();
  
  // åˆå§‹åŒ–å­—æ•°ç»Ÿè®¡
  updateWordCount();
   
   // åˆå§‹åŒ–éŸ³é¢‘é€Ÿåº¦æ»‘å—
   const rateRange = document.getElementById('audio-rate-range');
   const rateValue = document.getElementById('audio-rate-value');
   const rateHidden = document.getElementById('audio-rate');
   
   if (rateRange && rateValue && rateHidden) {
     rateRange.addEventListener('input', function() {
       const value = parseInt(this.value);
       const percentage = 100 + value;
       rateValue.textContent = percentage + '%';
       
       // ç”Ÿæˆedge-ttsæ ¼å¼çš„é€Ÿåº¦å‚æ•°
       const rateParam = value >= 0 ? '+' + value + '%' : value + '%';
       rateHidden.value = rateParam;
     });
   }
   
   // æ‹¦æˆªjQueryçš„valæ–¹æ³•æ¥ç›‘å¬å†…å®¹å˜åŒ–
   interceptJQueryVal();
   
   // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
   setupPeriodicCheck();
   
   // ç›‘å¬æ–‡æœ¬åŒºåŸŸå˜åŒ–
   const textarea = document.getElementById('src-text');
   if (textarea) {
     textarea.addEventListener('input', updateWordCount);
     textarea.addEventListener('paste', function() {
       // ç²˜è´´åéœ€è¦å»¶è¿Ÿä¸€ä¸‹å†ç»Ÿè®¡ï¼Œç¡®ä¿å†…å®¹å·²æ›´æ–°
       setTimeout(updateWordCount, 10);
     });
  }
});

function setupRightPanelTabs() {
  const tabContainer = document.getElementById('right-panel-tabs');
  if (!tabContainer) {
    return;
  }

  const tabs = tabContainer.querySelectorAll('[role="tab"]');
  const panels = document.querySelectorAll('.right-panel-tab');

  tabs.forEach(function(tab) {
    tab.addEventListener('click', function(event) {
      event.preventDefault();
      const targetSelector = tab.dataset.target;
      if (!targetSelector) {
        return;
      }

      tabs.forEach(function(item) {
        item.classList.remove('tab-active');
      });

      panels.forEach(function(panel) {
        panel.classList.add('hidden');
      });

      tab.classList.add('tab-active');
      const targetPanel = document.querySelector(targetSelector);
      if (targetPanel) {
        targetPanel.classList.remove('hidden');
      }
    });
  });
}

 // æ·»åŠ è°ƒè¯•æ—¥å¿—
 function logState(message) {
   console.log(`[State] ${message}:`, {
     currentPageName: window.currentPageName,
     currentPageId: window.currentPageId,
     activeTab: window.activeTab,
     currentAudioSegmentId: window.currentAudioSegmentId
   });
 }

 // é¡µé¢/ç›®å½•é¡¹ç‚¹å‡»å¤„ç†
 window.currentPageName = window.currentPageName || ''; // Display name
 window.currentPageId = window.currentPageId || ''; // Actual page ID
 window.activeTab = window.activeTab || 'tab_toc'; // Track which tab is currently active
 window.currentAudioSegmentId = window.currentAudioSegmentId || 0;
window.currentBookPdfType = window.currentBookPdfType || 'unknown'; // Track book PDF type
window.currentBookFileType = window.currentBookFileType || '';
window.currentBookFileUrl = window.currentBookFileUrl || '';
window.currentSelectedPages = window.currentSelectedPages || []; // Track selected pages for multi-page viewing
window.currentSelectedContentIds = window.currentSelectedContentIds || [];

 // Tab switching
$(document).ready(function() {
  function checkViewport() {
    const warning = document.getElementById('desktop-warning');
    const root = document.getElementById('workbench-root');
    if (!warning || !root) return;

    const isSmall = window.innerWidth < 1024;
    if (isSmall) {
      warning.classList.remove('hidden');
      root.classList.add('hidden');
    } else {
      warning.classList.add('hidden');
      root.classList.remove('hidden');
    }
  }

  checkViewport();
  window.addEventListener('resize', checkViewport);

  $('#tab_toc').on('click', function() {
     $(this).addClass('tab-active');
     $('#tab_page').removeClass('tab-active');
     window.activeTab = 'tab_toc';
     resetAudioDisplay(); // åˆ‡æ¢åˆ°ç›®å½•é€‰é¡¹å¡æ—¶é‡ç½®éŸ³é¢‘æ˜¾ç¤º
     logState('Tab switched to TOC');
   });

  $('#tab_page').on('click', function() {
    $(this).addClass('tab-active');
    $('#tab_toc').removeClass('tab-active');
    window.activeTab = 'tab_page';
    resetAudioDisplay(); // åˆ‡æ¢åˆ°é¡µé¢é€‰é¡¹å¡æ—¶é‡ç½®éŸ³é¢‘æ˜¾ç¤º
    logState('Tab switched to Page');
  });
});

// éŸ³è‰²ä¸‹æ‹‰ & è¯•å¬
const voiceDropdown = document.getElementById('voice-dropdown');
const voiceDropdownToggle = document.getElementById('voice-dropdown-toggle');
const voiceDropdownMenu = document.getElementById('voice-dropdown-menu');
const voiceDropdownLabel = document.getElementById('voice-dropdown-label');
const voiceHiddenSelect = document.getElementById('voice-model');
const browserVoicePreferences = getBrowserLanguagePreferences();

function getBrowserLanguagePreferences() {
  if (typeof navigator === 'undefined') {
    return ['en-us', 'en'];
  }

  const rawList = navigator.languages && navigator.languages.length
    ? Array.from(navigator.languages)
    : [navigator.language || navigator.userLanguage || ''];

  const normalized = [];

  rawList.forEach((raw) => {
    const localeInfo = normalizeLocale(raw);
    if (!localeInfo) {
      return;
    }

    if (localeInfo.locale && !normalized.includes(localeInfo.locale)) {
      normalized.push(localeInfo.locale);
    }
    if (localeInfo.lang && !normalized.includes(localeInfo.lang)) {
      normalized.push(localeInfo.lang);
    }
  });

  if (!normalized.includes('en-us')) {
    normalized.push('en-us');
  }
  if (!normalized.includes('en')) {
    normalized.push('en');
  }

  return normalized;
}

function normalizeLocale(locale) {
  if (!locale || typeof locale !== 'string') {
    return null;
  }

  const cleaned = locale.trim().replace('_', '-');
  if (!cleaned) {
    return null;
  }

  const segments = cleaned.split('-');
  if (!segments.length) {
    return null;
  }

  const lang = segments[0].toLowerCase();
  const region = segments[1] ? segments[1].toUpperCase() : '';
  const normalizedLocale = region ? `${lang}-${region}` : lang;

  return {
    locale: normalizedLocale.toLowerCase(),
    lang,
  };
}

function extractVoiceLocale(shortName) {
  if (!shortName || typeof shortName !== 'string') {
    return { locale: '', lang: '' };
  }

  const parts = shortName.split('-');
  if (parts.length < 2) {
    const lang = parts[0] ? parts[0].toLowerCase() : '';
    return { locale: lang, lang };
  }

  const lang = parts[0].toLowerCase();
  const region = parts[1] ? parts[1].toUpperCase() : '';
  const locale = region ? `${lang}-${region}` : lang;

  return { locale: locale.toLowerCase(), lang };
}

function findPreferredVoiceItem(container) {
  if (!container) {
    return null;
  }

  for (const preference of browserVoicePreferences) {
    const exactMatch = container.querySelector(`[data-voice-locale="${preference}"]`);
    if (exactMatch) {
      return exactMatch;
    }

    if (!preference.includes('-')) {
      const fallbackMatch = container.querySelector(`[data-voice-lang="${preference}"]`);
      if (fallbackMatch) {
        return fallbackMatch;
      }
    }
  }

  return container.firstElementChild || null;
}

if (voiceDropdownToggle) {
  voiceDropdownToggle.addEventListener('click', () => {
    if (!voiceDropdownMenu) return;
    voiceDropdownMenu.classList.toggle('hidden');
    if (!voiceDropdownMenu.classList.contains('hidden')) {
      scrollSelectedVoiceIntoView();
    } else {
      stopVoicePreview();
    }
  });
}

document.addEventListener('click', (event) => {
  if (!voiceDropdown || !voiceDropdownMenu) return;
  if (!voiceDropdown.contains(event.target)) {
    voiceDropdownMenu.classList.add('hidden');
    stopVoicePreview();
  }
});

document.addEventListener('htmx:afterSwap', (event) => {
  if (event.target && event.target.id === 'voice-model') {
    buildVoiceDropdown();
  }
});

document.addEventListener('DOMContentLoaded', () => {
  buildVoiceDropdown();
});

function buildVoiceDropdown() {
  if (!voiceHiddenSelect || !voiceDropdownMenu || !voiceDropdownLabel) {
    return;
  }

  const options = Array.from(voiceHiddenSelect.options);
  if (!options.length) {
    voiceDropdownLabel.textContent = 'è¯­éŸ³æ¨¡å‹';
    voiceDropdownMenu.innerHTML = '';
    return;
  }

  voiceDropdownMenu.classList.add('hidden');
  voiceDropdownMenu.innerHTML = '';

  const placeholder = options.find((opt) => opt.disabled);
  const selectedOption = options.find((opt) => opt.selected && !opt.disabled);
  voiceDropdownLabel.textContent = selectedOption ? selectedOption.textContent : (placeholder ? placeholder.textContent : 'è¯­éŸ³æ¨¡å‹');

  options.forEach((option) => {
    if (option.disabled) {
      return;
    }

    const item = document.createElement('div');
    item.className = 'flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors duration-150';
    item.dataset.voiceValue = option.value;
    const localeInfo = extractVoiceLocale(option.value);
    item.dataset.voiceLocale = localeInfo.locale;
    item.dataset.voiceLang = localeInfo.lang;

    const selectBtn = document.createElement('button');
    selectBtn.type = 'button';
    selectBtn.className = 'flex-1 text-left text-sm';
    selectBtn.textContent = option.textContent;

    selectBtn.addEventListener('click', () => {
      stopVoicePreview();
      voiceHiddenSelect.value = option.value;
      voiceDropdownLabel.textContent = option.textContent;
      voiceDropdownMenu.classList.add('hidden');
      voiceHiddenSelect.dispatchEvent(new Event('change'));
      buildVoiceDropdown();
    });

    const previewBtn = document.createElement('button');
    previewBtn.type = 'button';
    previewBtn.className = 'btn btn-ghost btn-xs';
    previewBtn.innerHTML = '<i class="fas fa-headphones"></i>';
    previewBtn.addEventListener('click', async (event) => {
      event.stopPropagation();
      await previewVoice(option.value, previewBtn);
    });

    item.appendChild(selectBtn);
    item.appendChild(previewBtn);

    if (selectedOption && selectedOption.value === option.value) {
      item.classList.add('bg-primary', 'text-primary-content');
      selectBtn.classList.add('text-primary-content');
      previewBtn.classList.add('text-primary-content');
      item.classList.add('ring-2', 'ring-primary', 'ring-offset-2', 'ring-offset-base-100');
      item.dataset.selected = 'true';
    }
    else {
      item.dataset.selected = 'false';
      item.classList.add('hover:bg-base-200');
    }

    voiceDropdownMenu.appendChild(item);
  });
}

function scrollSelectedVoiceIntoView() {
  if (!voiceDropdownMenu) {
    return;
  }

  const selectedItem = voiceDropdownMenu.querySelector('[data-selected="true"]');
  if (selectedItem) {
    selectedItem.scrollIntoView({ block: 'nearest' });
    return;
  }

  const preferredItem = findPreferredVoiceItem(voiceDropdownMenu);
  if (preferredItem) {
    preferredItem.scrollIntoView({ block: 'nearest' });
  }
}

async function previewVoice(voiceName, triggerButton) {
  const providerValue = '{{ default_tts_provider|default:"edge_tts" }}';

  if (!voiceName) {
    alert('è¯·å…ˆé€‰æ‹©è¯­éŸ³æ¨¡å‹');
    return;
  }

  if (isPreviewingCurrentVoice(voiceName)) {
    stopVoicePreview();
    return;
  }

  stopVoicePreview();

  const originalContent = triggerButton.innerHTML;
  triggerButton.dataset.originalContent = originalContent;
  setPreviewButtonState(triggerButton, 'loading');

  try {
    const response = await fetch(`{% url 'tts_preview' %}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams({
        provider: providerValue,
        voice_name: voiceName
      })
    });

    let data;
    try {
      data = await response.json();
    } catch (parseError) {
      throw new Error('æœåŠ¡å™¨è¿”å›æ ¼å¼å¼‚å¸¸');
    }

    if (!response.ok || data.status !== 'ok') {
      throw new Error(data?.message || 'è¯•å¬å¤±è´¥');
    }

    if (window.voicePreviewAudio) {
      try {
        window.voicePreviewAudio.pause();
      } catch (pauseError) {
        console.warn('æš‚åœä¸Šä¸€æ®µè¯•å¬éŸ³é¢‘å¤±è´¥:', pauseError);
      }
    }

    const audio = new Audio(data.audio_url);
    window.voicePreviewAudio = audio;
    window.voicePreviewAudioName = voiceName;
    window.voicePreviewTrigger = triggerButton;

    audio.addEventListener('ended', stopVoicePreview);
    audio.addEventListener('pause', () => {
      if (audio.currentTime < audio.duration) {
        stopVoicePreview();
      }
    });

    try {
      await audio.play();
      setPreviewButtonState(triggerButton, 'playing');
    } catch (playError) {
      console.error('æ’­æ”¾è¯•å¬éŸ³é¢‘å¤±è´¥:', playError);
      alert('æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®é‡è¯•');
      stopVoicePreview();
    }
  } catch (error) {
    console.error('éŸ³è‰²è¯•å¬å¤±è´¥:', error);
    alert(error.message || 'è¯•å¬å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  } finally {
    if (!isPreviewingCurrentVoice(voiceName)) {
      resetPreviewButton(triggerButton);
    }
  }
}

function isPreviewingCurrentVoice(voiceName) {
  return window.voicePreviewAudio && window.voicePreviewAudioName === voiceName;
}

function setPreviewButtonState(button, state) {
  if (!button) {
    return;
  }

  if (state === 'loading') {
    button.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
    button.disabled = true;
    button.classList.add('btn-active');
    return;
  }

  if (state === 'playing') {
    button.innerHTML = '<i class="fas fa-stop"></i>';
    button.disabled = false;
    button.classList.add('btn-active');
    return;
  }

  resetPreviewButton(button);
}

function resetPreviewButton(button) {
  if (!button) {
    return;
  }

  const original = button.dataset.originalContent || '<i class="fas fa-headphones"></i>';
  button.innerHTML = original;
  button.disabled = false;
  button.classList.remove('btn-active');
  delete button.dataset.originalContent;
}

function stopVoicePreview() {
  const audio = window.voicePreviewAudio;
  const trigger = window.voicePreviewTrigger;

  window.voicePreviewAudio = null;
  window.voicePreviewAudioName = null;
  window.voicePreviewTrigger = null;

  if (audio) {
    try {
      audio.pause();
    } catch (error) {
      console.warn('åœæ­¢è¯•å¬æ—¶å‡ºé”™:', error);
    }
  }

  if (trigger) {
    resetPreviewButton(trigger);
  }
}

 const dialogueDraftStorageKey = 'dialogue-draft';

 function normalizeDialogueTitle(rawTitle) {
   if (!rawTitle) {
     return '';
   }
   const normalized = rawTitle.replace(/\s+/g, ' ').trim();
   if (!normalized) {
     return '';
   }
   const parts = normalized.split(' ');
   if (parts.length % 2 === 0) {
     const half = parts.length / 2;
     const firstHalf = parts.slice(0, half).join(' ');
     const secondHalf = parts.slice(half).join(' ');
     if (firstHalf && firstHalf === secondHalf) {
       return firstHalf;
     }
   }
   return normalized;
 }

 const createDialogueBtn = document.getElementById('create-dialogue-btn');
 if (createDialogueBtn) {
   createDialogueBtn.addEventListener('click', function() {
     const textarea = document.getElementById('src-text');
     const textContent = textarea ? textarea.value.trim() : '';

     if (!textContent) {
       alert('è¯·å…ˆåŠ è½½æˆ–è¾“å…¥ç« èŠ‚å†…å®¹');
       return;
     }

     const rawSuggestedTitle = (window.currentPageName && window.currentPageName.trim()) || '{{ title|escapejs }}';
     const suggestedTitle = normalizeDialogueTitle(rawSuggestedTitle);

     const draftData = {
       bookId: '{{ book_id }}',
       bookTitle: '{{ title|escapejs }}',
       chapterId: window.currentPageId || '',
       chapterName: window.currentPageName || '',
       selectedContentIds: Array.isArray(window.currentSelectedContentIds) ? window.currentSelectedContentIds : [],
       selectedPages: Array.isArray(window.currentSelectedPages) ? window.currentSelectedPages : [],
       text: textContent,
       suggestedTitle: suggestedTitle || '{{ title|escapejs }}',
       source: 'workbench',
       timestamp: Date.now()
     };

     try {
       sessionStorage.setItem(dialogueDraftStorageKey, JSON.stringify(draftData));
     } catch (error) {
       console.error('æ— æ³•ç¼“å­˜å¯¹è¯è‰ç¨¿æ•°æ®', error);
       alert('æµè§ˆå™¨å­˜å‚¨å¼‚å¸¸ï¼Œæš‚æ—¶æ— æ³•è·³è½¬');
       return;
     }

     window.location.href = `{% url 'dialogue_create' %}`;
   });
 }

 // éŸ³é¢‘åˆæˆå’Œç®¡ç†
 const synthesizeBtn = document.getElementById('synthesize-btn');
 if (synthesizeBtn) {
   synthesizeBtn.addEventListener('click', async function() {
     const textContent = document.getElementById('src-text').value;
     const voiceModel = document.getElementById('voice-model').value;
     const audioRate = document.getElementById('audio-rate').value;
     const audioTitle = document.getElementById('audio-title-input').value || window.currentPageName;
     
     if (!textContent || !voiceModel) {
       alert('è¯·å…ˆé€‰æ‹©è¯­éŸ³æ¨¡å‹å¹¶è¾“å…¥æ–‡æœ¬');
       return;
     }
     
     // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     this.innerHTML = '<span class="loading loading-spinner loading-xs"></span> å¯åŠ¨ä»»åŠ¡...';
     this.disabled = true;
     console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šå¯åŠ¨ä»»åŠ¡ä¸­');
     
     try {
       // å¯åŠ¨éŸ³é¢‘åˆæˆä»»åŠ¡
       const response = await fetch(`{% url 'synthesize_audio' %}`, {
         method: 'POST',
         headers: {
           'Content-Type': 'application/x-www-form-urlencoded',
           'X-CSRFToken': '{{ csrf_token }}'
         },
         body: new URLSearchParams({
           text: textContent,
           voice_name: voiceModel,
           rate: audioRate,
           book_id: '{{ book_id }}',
           title: audioTitle || 'æœªå‘½åéŸ³é¢‘',
           book_page: window.currentPageId || '',
           page_display_name: window.currentPageName || '',
           audio_title: audioTitle || ''
         })
       });
       
       const data = await response.json();
       console.log('Audio synthesis response:', data);
       
       if (data.status === 'started') {
         // ä»»åŠ¡å·²å¯åŠ¨ï¼Œå¼€å§‹è½®è¯¢çŠ¶æ€
         this.innerHTML = '<span class="loading loading-spinner loading-xs"></span> æ­£åœ¨åˆæˆ...';
         console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šæ­£åœ¨åˆæˆ');
         await pollTaskStatus(data.task_id, audioTitle);
       } else {
         // å¤„ç†å¯åŠ¨å¤±è´¥çš„æƒ…å†µ
         console.log('[Button] ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
         await handleAudioError(data.message || 'å¯åŠ¨éŸ³é¢‘åˆæˆä»»åŠ¡å¤±è´¥');
       }
     } catch (error) {
       console.error('å¯åŠ¨éŸ³é¢‘åˆæˆä»»åŠ¡é”™è¯¯:', error);
       console.log('[Button] å‘ç”Ÿå¼‚å¸¸ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
       await handleAudioError(`ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸: ${error.message}`);
     }
   });
 }

 // è½®è¯¢ä»»åŠ¡çŠ¶æ€çš„å‡½æ•°
 async function pollTaskStatus(taskId, audioTitle) {
   const maxAttempts = 120; // æœ€å¤šè½®è¯¢2åˆ†é’Ÿ
   let attempts = 0;
   
   const poll = async () => {
     attempts++;
     
     try {
       const response = await fetch(`{% url 'check_task_status' 'TASK_ID' %}`.replace('TASK_ID', taskId));
       const statusData = await response.json();
       
       console.log('Task status:', statusData);
       
       const synthesizeBtn = document.getElementById('synthesize-btn');
       
       switch (statusData.status) {
         case 'pending':
           if (synthesizeBtn) {
             synthesizeBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> ç­‰å¾…æ‰§è¡Œ...';
             synthesizeBtn.disabled = true;
             console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šç­‰å¾…æ‰§è¡Œ');
           }
           break;
           
         case 'processing':
           if (synthesizeBtn) {
             synthesizeBtn.innerHTML = `<span class="loading loading-spinner loading-xs"></span> ${statusData.message || 'æ­£åœ¨å¤„ç†...'}`;
             synthesizeBtn.disabled = true;
             console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šæ­£åœ¨å¤„ç† -', statusData.message);
           }
           break;
           
         case 'success':
           // ä»»åŠ¡æˆåŠŸå®Œæˆ
           console.log('[Button] ä»»åŠ¡æˆåŠŸå®Œæˆï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
           await handleAudioSuccess(statusData, audioTitle);
           return; // åœæ­¢è½®è¯¢
           
         case 'failure':
           // ä»»åŠ¡å¤±è´¥
           console.log('[Button] ä»»åŠ¡å¤±è´¥ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
           await handleAudioError(statusData.message || 'éŸ³é¢‘åˆæˆå¤±è´¥');
           return; // åœæ­¢è½®è¯¢
           
         default:
           if (synthesizeBtn) {
             synthesizeBtn.innerHTML = `<span class="loading loading-spinner loading-xs"></span> ${statusData.message || 'å¤„ç†ä¸­...'}`;
             synthesizeBtn.disabled = true;
             console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šå¤„ç†ä¸­ -', statusData.message);
           }
           break;
       }
       
       // å¦‚æœè¿˜æ²¡å®Œæˆä¸”æœªè¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œç»§ç»­è½®è¯¢
       if (attempts < maxAttempts) {
         setTimeout(poll, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
       } else {
         console.log('[Button] è½®è¯¢è¶…æ—¶ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
         await handleAudioError('éŸ³é¢‘åˆæˆè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
       }
       
     } catch (error) {
       console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€é”™è¯¯:', error);
       if (attempts < maxAttempts) {
         setTimeout(poll, 2000); // å‡ºé”™æ—¶2ç§’åé‡è¯•
       } else {
         console.log('[Button] è½®è¯¢é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
         await handleAudioError('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥');
       }
     }
   };
   
   // å¼€å§‹è½®è¯¢
   setTimeout(poll, 1000); // 1ç§’åå¼€å§‹ç¬¬ä¸€æ¬¡è½®è¯¢
 }

 // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
 function restoreSynthesizeButton() {
   const synthesizeBtn = document.getElementById('synthesize-btn');
   if (synthesizeBtn) {
     synthesizeBtn.innerHTML = 'åˆæˆéŸ³é¢‘';
     synthesizeBtn.disabled = false;
     console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€å·²æ¢å¤ä¸ºå¯ç”¨çŠ¶æ€');
   }
 }

 // æ£€æŸ¥å¹¶ç¡®ä¿æŒ‰é’®çŠ¶æ€ä¸€è‡´æ€§çš„å‡½æ•°
 function ensureButtonStateConsistency() {
   const synthesizeBtn = document.getElementById('synthesize-btn');
   if (synthesizeBtn) {
     // å¦‚æœæŒ‰é’®æ˜¾ç¤ºä¸ºåŠ è½½çŠ¶æ€ä½†æ²¡æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œåˆ™æ¢å¤æŒ‰é’®çŠ¶æ€
     const buttonText = synthesizeBtn.innerHTML;
     const isShowingLoadingState = buttonText.includes('loading-spinner') || 
                                  buttonText.includes('å¯åŠ¨ä»»åŠ¡') || 
                                  buttonText.includes('æ­£åœ¨åˆæˆ') || 
                                  buttonText.includes('ç­‰å¾…æ‰§è¡Œ') || 
                                  buttonText.includes('æ­£åœ¨å¤„ç†') || 
                                  buttonText.includes('å¤„ç†ä¸­');
     
     if (isShowingLoadingState) {
       console.log('[Button] æ£€æµ‹åˆ°æŒ‰é’®å¯èƒ½å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼Œå½“å‰æ–‡æœ¬:', buttonText);
       // å¯ä»¥æ·»åŠ é¢å¤–çš„é€»è¾‘æ¥åˆ¤æ–­æ˜¯å¦çœŸçš„æœ‰ä»»åŠ¡åœ¨è¿›è¡Œ
       // è¿™é‡Œæš‚æ—¶è®°å½•çŠ¶æ€ï¼Œä¸è‡ªåŠ¨æ¢å¤ï¼Œé¿å…å¹²æ‰°æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
     }
   }
 }

 // å®šæœŸæ£€æŸ¥æŒ‰é’®çŠ¶æ€ä¸€è‡´æ€§ï¼ˆå¯é€‰çš„ä¿æŠ¤æªæ–½ï¼‰
 setInterval(ensureButtonStateConsistency, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

 // å¤„ç†éŸ³é¢‘åˆæˆæˆåŠŸçš„å‡½æ•°
 async function handleAudioSuccess(data, audioTitle) {
   // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€
   restoreSynthesizeButton();
   
  // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
  document.getElementById('audio-player-container').classList.remove('hidden');
  const audioPlayer = document.getElementById('audio-player');
  audioPlayer.src = data.audio_url;
  audioPlayer.style.display = 'block'; // ç¡®ä¿æ’­æ”¾å™¨å¯è§
  document.getElementById('audio-title').textContent = audioTitle || 'æœªå‘½åéŸ³é¢‘';
  
  // æ˜¾ç¤ºå…¨å±€æ’­æ”¾å™¨æŒ‰é’®
  const globalPlayBtn = document.getElementById('global-play-from-workbench');
  if (globalPlayBtn) {
    globalPlayBtn.style.display = 'block';
    // ä¿å­˜å½“å‰éŸ³é¢‘ä¿¡æ¯ä¾›å…¨å±€æ’­æ”¾å™¨ä½¿ç”¨
    globalPlayBtn.dataset.audioUrl = data.audio_url;
    globalPlayBtn.dataset.audioTitle = audioTitle || 'æœªå‘½åéŸ³é¢‘';
    if (data.subtitle_url) {
      globalPlayBtn.dataset.subtitleUrl = data.subtitle_url;
    } else {
      delete globalPlayBtn.dataset.subtitleUrl;
    }
    if (data.chapters_url) {
      globalPlayBtn.dataset.chaptersUrl = data.chapters_url;
    } else {
      delete globalPlayBtn.dataset.chaptersUrl;
    }
    if (Array.isArray(data.chapters) && data.chapters.length > 0) {
      globalPlayBtn.cachedChapters = data.chapters;
    } else {
      globalPlayBtn.cachedChapters = null;
    }
    globalPlayBtn.cachedSubtitles = null;
  }
   
   // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€å’Œé…é¢ä¿¡æ¯
   const audioStatus = document.getElementById('audio-status');
   audioStatus.className = 'text-sm mt-1 text-center font-medium text-success';
   audioStatus.innerHTML = '';
   audioStatus.textContent = 'åˆæˆæˆåŠŸï¼';
      
   // å¯ç”¨ä¸‹è½½å’Œå‘å¸ƒæŒ‰é’®
   const downloadBtn = document.getElementById('download-btn');
   if (downloadBtn) {
     downloadBtn.disabled = false;
     downloadBtn.onclick = function() {
       const a = document.createElement('a');
       a.href = data.audio_url;
       a.download = (audioTitle || 'éŸ³é¢‘') + '.wav';
       document.body.appendChild(a);
       a.click();
       document.body.removeChild(a);
     };
   }
   
   const publishBtn = document.getElementById('publish-btn');
   if (publishBtn) {
     publishBtn.disabled = false;
     window.currentAudioSegmentId = data.audio_id;
     console.log("Setting audio segment ID:", window.currentAudioSegmentId);
     
     // é‡ç½®æŒ‰é’®ä¸ºæœªå‘å¸ƒçŠ¶æ€
     publishBtn.className = 'btn btn-success btn-sm flex-1';
     publishBtn.innerHTML = `
       <i class="fas fa-check h-5 w-5 mr-1"></i>
       å‘å¸ƒ
     `;
     publishBtn.title = 'å‘å¸ƒ';
   }

   logState('Audio synthesized successfully');
 }

 // å¤„ç†éŸ³é¢‘åˆæˆé”™è¯¯çš„å‡½æ•°
 async function handleAudioError(errorMessage) {
   // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€
   restoreSynthesizeButton();
   
   const audioStatus = document.getElementById('audio-status');
   audioStatus.className = 'text-sm mt-1 text-center font-medium text-error';
   audioStatus.innerHTML = '';
   
   // åˆ›å»ºé”™è¯¯æ¶ˆæ¯å®¹å™¨
   const errorContainer = document.createElement('div');
   errorContainer.className = 'alert alert-error shadow-lg mt-2 p-2';
   
   // æ·»åŠ é”™è¯¯å›¾æ ‡å’Œæ¶ˆæ¯
   errorContainer.innerHTML = `
     <div class="flex items-center">
       <i class="fas fa-times-circle h-5 w-5 mr-2"></i>
       <span class="text-sm">${errorMessage}</span>
     </div>
   `;
   
   // å°†é”™è¯¯å®¹å™¨æ·»åŠ åˆ°éŸ³é¢‘çŠ¶æ€åŒºåŸŸ
   audioStatus.appendChild(errorContainer);
   
   // å¦‚æœæ˜¯é…é¢ä¸è¶³é”™è¯¯ï¼Œæ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨å®¹å™¨ä»¥ä¾¿ç”¨æˆ·çœ‹åˆ°é”™è¯¯ä¿¡æ¯
   if (errorMessage && errorMessage.includes('é…é¢ä¸è¶³')) {
     document.getElementById('audio-player-container').classList.remove('hidden');
     // éšè—éŸ³é¢‘æ’­æ”¾å™¨æœ¬èº«ï¼Œåªæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
     const audioPlayer = document.getElementById('audio-player');
     audioPlayer.style.display = 'none';
     document.getElementById('audio-title').textContent = 'é…é¢ä¸è¶³';
   }
   
   logState('Audio synthesis failed: ' + errorMessage);
 }

// å·¥ä½œå°éŸ³é¢‘å…¨å±€æ’­æ”¾åŠŸèƒ½
async function playWorkbenchAudioInGlobal() {
  const globalPlayBtn = document.getElementById('global-play-from-workbench');
  if (!globalPlayBtn || !window.globalAudioPlayer) {
    alert('å…¨å±€æ’­æ”¾å™¨æœªå‡†å¤‡å°±ç»ª');
    return;
  }
  
  const audioUrl = globalPlayBtn.dataset.audioUrl;
  const audioTitle = globalPlayBtn.dataset.audioTitle;
  const subtitleUrl = globalPlayBtn.dataset.subtitleUrl;
  const chapterUrl = globalPlayBtn.dataset.chaptersUrl;
  const chapters = Array.isArray(globalPlayBtn.cachedChapters) ? globalPlayBtn.cachedChapters : [];
  const chapterOptions = {
    chapters,
    chaptersUrl: chapterUrl || null
  };
  
  if (audioUrl) {
    let subtitles = globalPlayBtn.cachedSubtitles || null;

    if (!subtitles && subtitleUrl) {
      try {
        const response = await fetch(subtitleUrl);
        if (response.ok) {
          const subtitleContent = await response.text();
          if (subtitleContent.trim() && typeof window.globalAudioPlayer.parseSRTSubtitles === 'function') {
            subtitles = window.globalAudioPlayer.parseSRTSubtitles(subtitleContent);
            globalPlayBtn.cachedSubtitles = subtitles;
          }
        } else {
          console.warn('[Workbench] è·å–å­—å¹•å¤±è´¥:', response.status, response.statusText);
        }
      } catch (error) {
        console.error('[Workbench] è·å–å­—å¹•å‡ºé”™:', error);
      }
    }

    window.globalAudioPlayer.playAudio(audioUrl, audioTitle, subtitles, chapterOptions);
  }
}

 // æ·»åŠ  HTMX è¯·æ±‚å’Œå“åº”ç›‘å¬ (ä¿ç•™ä»¥å…¼å®¹å…¶ä»–HTMXåŠŸèƒ½)
 document.body.addEventListener('htmx:beforeRequest', function(evt) {
   console.log('HTMX beforeRequest:', {
     target: evt.detail.target?.id,
     path: evt.detail.path,
     verb: evt.detail.verb
   });
 });

 // ç›‘å¬HTMXå†…å®¹åŠ è½½å®Œæˆäº‹ä»¶ï¼Œæ›´æ–°å­—æ•°ç»Ÿè®¡
 document.body.addEventListener('htmx:afterSwap', function(evt) {
   // å¦‚æœæ˜¯TOCåŒºåŸŸçš„åŠ è½½ï¼ˆTOCå’Œpageséƒ½åŠ è½½åˆ°è¿™é‡Œï¼‰ï¼Œæ›´æ–°å­—æ•°ç»Ÿè®¡
   if (evt.detail.target && evt.detail.target.id === 'toc') {
     // å»¶è¿Ÿè¾ƒé•¿æ—¶é—´ï¼Œç¡®ä¿TOC/pagesç»„ä»¶çš„JavaScriptå·²æ‰§è¡Œå®Œæˆ
     setTimeout(updateWordCount, 200);
   }
 });

 // åˆ›å»ºä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œä¾›TOCå’Œpagesè°ƒç”¨æ¥æ›´æ–°å­—æ•°
 window.triggerWordCountUpdate = function() {
   setTimeout(updateWordCount, 10);
 };

 // å®šæœŸæ£€æŸ¥textareaå€¼å˜åŒ–ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
 function setupPeriodicCheck() {
   const textarea = document.getElementById('src-text');
   if (textarea && !window._periodicCheckSetup) {
     window._periodicCheckSetup = true;
     
     setInterval(function() {
       const currentValue = textarea.value;
       const currentLength = currentValue.replace(/\s/g, '').length;
       
       // ä½¿ç”¨å…±äº«çš„çŠ¶æ€å˜é‡ï¼Œé¿å…é‡å¤è§¦å‘
       if (currentValue !== lastTextValue) {
         console.log('[WordCount] å®šæœŸæ£€æŸ¥å‘ç°å˜åŒ–ï¼Œè§¦å‘æ›´æ–°');
         updateWordCount();
       }
     }, 2000); // æ”¹ä¸ºæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå‡å°‘é¢‘ç‡
   }
 }

 // æ‹¦æˆªjQueryçš„valæ–¹æ³•ï¼Œä¸“é—¨é’ˆå¯¹src-text textarea
 function interceptJQueryVal() {
   if (typeof $ !== 'undefined' && !window._jqueryValIntercepted) {
     window._jqueryValIntercepted = true;
     
     const originalVal = $.fn.val;
     $.fn.val = function(value) {
       const result = originalVal.apply(this, arguments);
       
       // å¦‚æœæ˜¯è®¾ç½®å€¼æ“ä½œï¼ˆæœ‰å‚æ•°ï¼‰
       if (arguments.length > 0) {
         // æ£€æŸ¥å½“å‰jQueryå¯¹è±¡æ˜¯å¦åŒ…å«src-textå…ƒç´ 
         const containsSrcText = this.filter('#src-text').length > 0 || this.is('#src-text');
         if (containsSrcText) {
           // å»¶è¿Ÿæ›´æ–°å­—æ•°ï¼Œç¡®ä¿DOMå·²æ›´æ–°
           setTimeout(updateWordCount, 50);
         }
       }
       
       return result;
     };
   }
 }

 // è‡ªåŠ¨æ’ç‰ˆç›¸å…³çš„å…¨å±€å˜é‡
 let formattedText = '';
 let formatEventSource = null;
 let isFormattingInProgress = false;
 let originalTextContent = '';

 // ç¿»è¯‘ç›¸å…³çš„å…¨å±€å˜é‡
 let translatedText = '';
 let translateEventSource = null;
 let isTranslationInProgress = false;
 let originalTranslateTextContent = '';

 // å®‰å…¨åœ°æ¸…ç†ç¿»è¯‘èµ„æºçš„å‡½æ•°
 function cleanupTranslation() {
   // å®‰å…¨åœ°å…³é—­äº‹ä»¶æº
   if (translateEventSource) {
     try {
       translateEventSource.close();
     } catch (e) {
       console.error('å…³é—­ç¿»è¯‘äº‹ä»¶æºæ—¶å‡ºé”™:', e);
     }
     translateEventSource = null;
   }

   // é‡ç½®çŠ¶æ€
   isTranslationInProgress = false;

   // æ¢å¤æŒ‰é’®çŠ¶æ€
   const translateBtn = document.getElementById('translate-text-btn');
   if (translateBtn) {
     translateBtn.disabled = false;
     translateBtn.innerHTML = 'ç¿»è¯‘';
   }

   // å¦‚æœæ–‡æœ¬æ¡†æ˜¯ç©ºçš„ï¼Œä½†è¿‡ç¨‹ä¸­æ²¡æ”¶åˆ°ä»»ä½•å†…å®¹ï¼Œæ¢å¤åŸæ–‡æœ¬
   const textarea = document.getElementById('src-text');
   if (textarea && !translatedText && textarea.value.startsWith('æ­£åœ¨è¿›è¡Œç¿»è¯‘')) {
     textarea.value = originalTranslateTextContent || '';
   }

   // æ›´æ–°å­—æ•°ç»Ÿè®¡
   updateWordCount();
 }

 // å®‰å…¨åœ°æ¸…ç†èµ„æºçš„å‡½æ•°
 function cleanupFormatting() {
   // å®‰å…¨åœ°å…³é—­äº‹ä»¶æº
   if (formatEventSource) {
     try {
       formatEventSource.close();
     } catch (e) {
       console.error('å…³é—­äº‹ä»¶æºæ—¶å‡ºé”™:', e);
     }
     formatEventSource = null;
   }
   
   // é‡ç½®çŠ¶æ€
   isFormattingInProgress = false;
   
   // æ¢å¤æŒ‰é’®çŠ¶æ€
   const formatBtn = document.getElementById('format-text-btn');
   if (formatBtn) {
     formatBtn.disabled = false;
     formatBtn.innerHTML = 'è‡ªåŠ¨æ’ç‰ˆ';
   }
   
   // å¦‚æœæ–‡æœ¬æ¡†æ˜¯ç©ºçš„ï¼Œä½†è¿‡ç¨‹ä¸­æ²¡æ”¶åˆ°ä»»ä½•å†…å®¹ï¼Œæ¢å¤åŸæ–‡æœ¬
   const textarea = document.getElementById('src-text');
   if (textarea && !formattedText && textarea.value.startsWith('æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆ')) {
     textarea.value = originalTextContent || '';
   }
   
   // æ›´æ–°å­—æ•°ç»Ÿè®¡
   updateWordCount();
 }
 
 // ç¿»è¯‘è¯­è¨€é€‰æ‹©æ¨¡æ€æ¡†åŠŸèƒ½
 function showTranslateLanguageModal() {
   const modal = document.getElementById('translate-language-modal');
   if (modal) {
     // æ ¹æ®æµè§ˆå™¨è¯­è¨€è‡ªåŠ¨é«˜äº®æ¨èé€‰é¡¹
     highlightRecommendedLanguage();
     modal.classList.add('modal-open');
   }
 }

 function closeTranslateLanguageModal() {
   const modal = document.getElementById('translate-language-modal');
   if (modal) {
     modal.classList.remove('modal-open');
   }
 }

 // æ ¹æ®æµè§ˆå™¨è¯­è¨€é«˜äº®æ¨èé€‰é¡¹
 function highlightRecommendedLanguage() {
   const browserLang = navigator.language || navigator.userLanguage;
   let recommendedLang = '';

   // æ£€æµ‹æµè§ˆå™¨è¯­è¨€å¹¶æ˜ å°„åˆ°æ”¯æŒçš„è¯­è¨€ä»£ç 
   if (browserLang.startsWith('en')) {
     recommendedLang = 'en';
   } else if (browserLang.startsWith('zh')) {
     recommendedLang = 'zh';
   } else if (browserLang.startsWith('ja')) {
     recommendedLang = 'ja';
   } else if (browserLang.startsWith('ko')) {
     recommendedLang = 'ko';
   } else if (browserLang.startsWith('fr')) {
     recommendedLang = 'fr';
   } else if (browserLang.startsWith('de')) {
     recommendedLang = 'de';
   } else if (browserLang.startsWith('es')) {
     recommendedLang = 'es';
   } else if (browserLang.startsWith('ru')) {
     recommendedLang = 'ru';
   }

   // é«˜äº®æ¨èçš„è¯­è¨€é€‰é¡¹
   const languageButtons = document.querySelectorAll('#language-options button[data-lang]');
   languageButtons.forEach(button => {
     button.classList.remove('btn-primary');
     button.classList.add('btn-outline');
     if (button.dataset.lang === recommendedLang) {
       button.classList.remove('btn-outline');
       button.classList.add('btn-primary');
     }
   });
 }

 // ç¿»è¯‘æŒ‰é’®ç‚¹å‡»å¤„ç†
 const translateTextBtn = document.getElementById('translate-text-btn');
 if (translateTextBtn) {
   translateTextBtn.addEventListener('click', function() {
     originalTranslateTextContent = document.getElementById('src-text').value;

     if (!originalTranslateTextContent.trim()) {
       showToast('è¯·å…ˆè¾“å…¥æˆ–åŠ è½½æ–‡æœ¬å†…å®¹', 'warning', 3000);
       return;
     }

     // æ˜¾ç¤ºè¯­è¨€é€‰æ‹©æ¨¡æ€æ¡†
     showTranslateLanguageModal();
   });
 }

 // è¯­è¨€é€‰æ‹©æŒ‰é’®äº‹ä»¶ç›‘å¬
 document.addEventListener('DOMContentLoaded', function() {
   const languageButtons = document.querySelectorAll('#language-options button[data-lang]');
   languageButtons.forEach(button => {
     button.addEventListener('click', function() {
       const targetLanguage = this.dataset.lang;
       const languageName = this.querySelector('span.flex-1').textContent;

       // å…³é—­æ¨¡æ€æ¡†
       closeTranslateLanguageModal();

       // å¼€å§‹ç¿»è¯‘
       startTranslation(targetLanguage, languageName);
     });
   });
 });

 // å¼€å§‹ç¿»è¯‘è¿‡ç¨‹
 function startTranslation(targetLanguage, languageName) {
   const translateBtn = document.getElementById('translate-text-btn');

   // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   translateBtn.disabled = true;
   translateBtn.innerHTML = `æ­£åœ¨ç¿»è¯‘ä¸º${languageName}...`;

   // å…³é—­ä»»ä½•å·²å­˜åœ¨çš„è¿æ¥
   cleanupTranslation();

   // é‡ç½®æ–‡æœ¬ç´¯ç§¯å˜é‡å’ŒçŠ¶æ€
   translatedText = '';
   isTranslationInProgress = true;

   // æ¸…ç©ºæ–‡æœ¬æ¡†å¹¶æ˜¾ç¤ºåˆå§‹æç¤º
   const textarea = document.getElementById('src-text');
   if (textarea) {
     textarea.value = `æ­£åœ¨ç¿»è¯‘ä¸º${languageName}ï¼Œè¯·ç¨å€™...`;
     console.log('æ–‡æœ¬åŒºåŸŸå·²æ¸…ç©ºï¼Œå¼€å§‹ç¿»è¯‘');
   }

   try {
     // å»ºç«‹SSEè¿æ¥å¹¶å‘é€POSTè¯·æ±‚
     console.log('å‘é€ç¿»è¯‘POSTè¯·æ±‚å¹¶å»ºç«‹SSEè¿æ¥');

     // æ·»åŠ è¿›åº¦æ˜¾ç¤ºå˜é‡
     let progressCount = 0;
     const progressInterval = setInterval(() => {
       if (isTranslationInProgress) {
         progressCount = (progressCount + 1) % 4;
         const dots = '.'.repeat(progressCount);
         translateBtn.innerHTML = `ç¿»è¯‘ä¸­${dots}`;

         // å¦‚æœæ²¡æœ‰æ”¶åˆ°ä»»ä½•ç¿»è¯‘æ–‡æœ¬ï¼Œç»§ç»­æ˜¾ç¤ºç­‰å¾…æ¶ˆæ¯
         if (!translatedText && textarea) {
           textarea.value = `æ­£åœ¨ç¿»è¯‘ä¸º${languageName}ï¼Œè¯·ç¨å€™${dots}`;
         }
       } else {
         clearInterval(progressInterval);
       }
     }, 500);

     // é¦–å…ˆåˆ›å»ºPOSTè¯·æ±‚å‘é€æ–‡æœ¬å†…å®¹
     fetch('{% url "translate" %}', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/x-www-form-urlencoded',
         'X-CSRFToken': '{{ csrf_token }}'
       },
       body: new URLSearchParams({
         texts: originalTranslateTextContent,
         target_language: targetLanguage
       })
     }).then(response => {
       // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
       if (!response.ok) {
         throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
       }

       // åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶æºè¯»å–æµå¼å“åº”ç»“æœ
       const reader = response.body.getReader();
       const decoder = new TextDecoder();

       // è¯»å–å“åº”æµ
       function readStream() {
         reader.read().then(({ done, value }) => {
           if (done) {
             console.log('ç¿»è¯‘æµè¯»å–å®Œæˆ');
             cleanupTranslation();
             return;
           }

           // å¤„ç†æ”¶åˆ°çš„æ•°æ®å—
           const chunk = decoder.decode(value, { stream: true });
           console.log('æ¥æ”¶åˆ°ç¿»è¯‘æ•°æ®å—...');

           // åˆ†å‰²SSEæ¶ˆæ¯
           const messages = chunk.split('\n\n');
           for (const message of messages) {
             if (!message.trim()) continue;

             // æå–äº‹ä»¶ç±»å‹å’Œæ•°æ®
             const eventMatch = message.match(/^event: (.+)$/m);

             // ä¿®æ”¹æ•°æ®æå–æ–¹å¼ï¼Œæ”¯æŒå¤šè¡Œå†…å®¹
             let dataContent = '';

             // æ£€æŸ¥äº‹ä»¶ç±»å‹
             if (eventMatch) {
               const eventType = eventMatch[1];
               console.log('å¤„ç†ç¿»è¯‘äº‹ä»¶ç±»å‹:', eventType);

               // æå–æ‰€æœ‰dataå¼€å¤´çš„è¡Œ
               const dataLines = message.split('\n').filter(line => line.startsWith('data: '));

               // ä»æ¯è¡Œæå–æ•°æ®å†…å®¹ï¼ˆå»æ‰"data: "å‰ç¼€ï¼‰
               if (dataLines.length > 0) {
                 dataContent = dataLines.map(line => line.substring(6)).join('\n');
               }

               if (dataContent) {
                 if (eventType === 'message') {
                   // æ•°æ®å†…å®¹å³ä¸ºç¿»è¯‘åçš„æ–‡æœ¬ï¼Œæ— éœ€å†è§£æJSON
                   console.log('æ”¶åˆ°ç¿»è¯‘æ–‡æœ¬:', dataContent.substring(0, 50) + '...');

                   // ç´¯ç§¯ç¿»è¯‘åçš„æ–‡æœ¬
                   translatedText += dataContent;
                   if (textarea) {
                     textarea.value = translatedText;
                     textarea.scrollTop = textarea.scrollHeight;
                     // æ›´æ–°å­—æ•°ç»Ÿè®¡
                     updateWordCount();
                   }
                 } else if (eventType === 'complete') {
                   console.log('ç¿»è¯‘å®Œæˆ');
                 } else if (eventType === 'error') {
                   console.error('ç¿»è¯‘é”™è¯¯:', dataContent);
                   showToast('ç¿»è¯‘å¤±è´¥: ' + dataContent, 'error', 5000);
                   cleanupTranslation();
                 }
               }
             }
           }

           // ç»§ç»­è¯»å–æµ
           readStream();
         }).catch(error => {
           console.error('è¯»å–ç¿»è¯‘æµé”™è¯¯:', error);
           showToast('è¯»å–ç¿»è¯‘ç»“æœæ—¶å‡ºé”™: ' + error.message, 'error', 5000);
           cleanupTranslation();
         });
       }

       // å¼€å§‹è¯»å–æµ
       readStream();
     }).catch(error => {
       console.error('å‘é€ç¿»è¯‘æ–‡æœ¬é”™è¯¯:', error);
       cleanupTranslation();
       showToast('ç¿»è¯‘å¤±è´¥: ' + error.message, 'error', 5000);
     });
   } catch (error) {
     console.error('æ•è·åˆ°çš„ç¿»è¯‘é”™è¯¯:', error);
     showToast('ç¿»è¯‘è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error', 5000);
     cleanupTranslation();
   }
 }

 // è‡ªåŠ¨æ’ç‰ˆæŒ‰é’®ç‚¹å‡»å¤„ç†
 const formatTextBtn = document.getElementById('format-text-btn');
 if (formatTextBtn) {
   formatTextBtn.addEventListener('click', function() {
     originalTextContent = document.getElementById('src-text').value;
     const formatBtn = this;
     
     if (!originalTextContent.trim()) {
       showToast('è¯·å…ˆè¾“å…¥æˆ–åŠ è½½æ–‡æœ¬å†…å®¹', 'warning', 3000);
       return;
     }
     
     // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     formatBtn.disabled = true;
     formatBtn.innerHTML = 'æ­£åœ¨æ’ç‰ˆ...';
     
     // å…³é—­ä»»ä½•å·²å­˜åœ¨çš„è¿æ¥
     cleanupFormatting();
     
     // é‡ç½®æ–‡æœ¬ç´¯ç§¯å˜é‡å’ŒçŠ¶æ€
     formattedText = '';
     isFormattingInProgress = true;
     
     // æ¸…ç©ºæ–‡æœ¬æ¡†å¹¶æ˜¾ç¤ºåˆå§‹æç¤º
     const textarea = document.getElementById('src-text');
     if (textarea) {
       textarea.value = 'æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆï¼Œè¯·ç¨å€™...';
       console.log('æ–‡æœ¬åŒºåŸŸå·²æ¸…ç©º');
     }

     try {
       // å»ºç«‹SSEè¿æ¥å¹¶å‘é€POSTè¯·æ±‚
       console.log('å‘é€POSTè¯·æ±‚å¹¶å»ºç«‹SSEè¿æ¥');
       
       // æ·»åŠ è¿›åº¦æ˜¾ç¤ºå˜é‡
       let progressCount = 0;
       const progressInterval = setInterval(() => {
         if (isFormattingInProgress) {
           progressCount = (progressCount + 1) % 4;
           const dots = '.'.repeat(progressCount);
           formatBtn.innerHTML = `æ’ç‰ˆä¸­${dots}`;
           
           // å¦‚æœæ²¡æœ‰æ”¶åˆ°ä»»ä½•æ ¼å¼åŒ–æ–‡æœ¬ï¼Œç»§ç»­æ˜¾ç¤ºç­‰å¾…æ¶ˆæ¯
           if (!formattedText && textarea) {
             textarea.value = `æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆï¼Œè¯·ç¨å€™${dots}`;
           }
         } else {
           clearInterval(progressInterval);
         }
       }, 500);
       
       // é¦–å…ˆåˆ›å»ºPOSTè¯·æ±‚å‘é€æ–‡æœ¬å†…å®¹
       fetch('{% url "reformat" %}', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/x-www-form-urlencoded',
           'X-CSRFToken': '{{ csrf_token }}'
         },
         body: new URLSearchParams({
           texts: originalTextContent
         })
       }).then(response => {
         // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
         if (!response.ok) {
           throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
         }
         
         // åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶æºè¯»å–æµå¼å“åº”ç»“æœ
         const reader = response.body.getReader();
         const decoder = new TextDecoder();
         
         // è¯»å–å“åº”æµ
         function readStream() {
           reader.read().then(({ done, value }) => {
             if (done) {
               console.log('æµè¯»å–å®Œæˆ');
               cleanupFormatting();
               return;
             }
             
             // å¤„ç†æ”¶åˆ°çš„æ•°æ®å—
             const chunk = decoder.decode(value, { stream: true });
             // ç®€åŒ–æ—¥å¿—ï¼Œé¿å…è¾“å‡ºå¤§é‡åŸå§‹æ•°æ®
             console.log('æ¥æ”¶åˆ°æ•°æ®å—...');
             
             // åˆ†å‰²SSEæ¶ˆæ¯
             const messages = chunk.split('\n\n');
             for (const message of messages) {
               if (!message.trim()) continue;
               
               // æå–äº‹ä»¶ç±»å‹å’Œæ•°æ®
               const eventMatch = message.match(/^event: (.+)$/m);
               
               // ä¿®æ”¹æ•°æ®æå–æ–¹å¼ï¼Œæ”¯æŒå¤šè¡Œå†…å®¹
               let dataContent = '';
               
               // æ£€æŸ¥äº‹ä»¶ç±»å‹
               if (eventMatch) {
                 const eventType = eventMatch[1];
                 console.log('å¤„ç†äº‹ä»¶ç±»å‹:', eventType);
                 
                 // æå–æ‰€æœ‰dataå¼€å¤´çš„è¡Œ
                 const dataLines = message.split('\n').filter(line => line.startsWith('data: '));
                 
                 // ä»æ¯è¡Œæå–æ•°æ®å†…å®¹ï¼ˆå»æ‰"data: "å‰ç¼€ï¼‰
                 if (dataLines.length > 0) {
                   dataContent = dataLines.map(line => line.substring(6)).join('\n');
                 }
                 
                 if (dataContent) {
                   if (eventType === 'message') {
                     // æ•°æ®å†…å®¹å³ä¸ºæ ¼å¼åŒ–åçš„æ–‡æœ¬ï¼Œæ— éœ€å†è§£æJSON
                     console.log('æ”¶åˆ°æ ¼å¼åŒ–æ–‡æœ¬:', dataContent.substring(0, 50) + '...');
                     
                     // ç´¯ç§¯æ ¼å¼åŒ–åçš„æ–‡æœ¬
                     formattedText += dataContent;
                     if (textarea) {
                       textarea.value = formattedText;
                       textarea.scrollTop = textarea.scrollHeight;
                       // æ›´æ–°å­—æ•°ç»Ÿè®¡
                       updateWordCount();
                     }
                   } else if (eventType === 'complete') {
                     console.log('æ ¼å¼åŒ–å®Œæˆ');
                   } else if (eventType === 'error') {
                     console.error('æ ¼å¼åŒ–é”™è¯¯:', dataContent);
                     showToast('è‡ªåŠ¨æ’ç‰ˆå¤±è´¥: ' + dataContent, 'error', 5000);
                     cleanupFormatting();
                   }
                 }
               }
             }
             
             // ç»§ç»­è¯»å–æµ
             readStream();
           }).catch(error => {
             console.error('è¯»å–æµé”™è¯¯:', error);
             showToast('è¯»å–æ’ç‰ˆç»“æœæ—¶å‡ºé”™: ' + error.message, 'error', 5000);
             cleanupFormatting();
           });
         }
         
         // å¼€å§‹è¯»å–æµ
         readStream();
       }).catch(error => {
         console.error('å‘é€æ–‡æœ¬é”™è¯¯:', error);
         cleanupFormatting();
         showToast('è‡ªåŠ¨æ’ç‰ˆå¤±è´¥: ' + error.message, 'error', 5000);
       });
            } catch (error) {
         console.error('æ•è·åˆ°çš„é”™è¯¯:', error);
         showToast('è‡ªåŠ¨æ’ç‰ˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error', 5000);
         cleanupFormatting();
       }
   });
 }

 // Toast é€šçŸ¥ç³»ç»Ÿ
 function showToast(message, type = 'info', duration = 3000) {
   // ç§»é™¤å·²å­˜åœ¨çš„toast
   const existingToast = document.getElementById('custom-toast');
   if (existingToast) {
     existingToast.remove();
   }
   
   // åˆ›å»ºtoastå…ƒç´ 
   const toast = document.createElement('div');
   toast.id = 'custom-toast';
   toast.className = `alert shadow-lg fixed top-4 right-4 z-50 max-w-sm transform transition-all duration-300 ease-in-out`;
   
   // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼å’Œå›¾æ ‡
   let alertClass, icon;
   switch (type) {
     case 'success':
       alertClass = 'alert-success';
       icon = `<i class="fas fa-check-circle h-6 w-6"></i>`;
       break;
     case 'error':
       alertClass = 'alert-error';
       icon = `<i class="fas fa-times-circle h-6 w-6"></i>`;
       break;
     case 'warning':
       alertClass = 'alert-warning';
       icon = `<i class="fas fa-exclamation-triangle h-6 w-6"></i>`;
       break;
     default:
       alertClass = 'alert-info';
       icon = `<i class="fas fa-info-circle h-6 w-6"></i>`;
   }
   
   toast.className += ` ${alertClass}`;
   toast.innerHTML = `
     <div>
       ${icon}
       <span>${message}</span>
     </div>
     <button class="btn btn-sm btn-ghost" onclick="this.parentElement.remove()">âœ•</button>
   `;
   
   // æ·»åŠ åˆ°é¡µé¢
   document.body.appendChild(toast);
   
   // æ˜¾ç¤ºåŠ¨ç”»
   setTimeout(() => {
     toast.style.transform = 'translateX(0)';
   }, 10);
   
   // è‡ªåŠ¨ç§»é™¤
   setTimeout(() => {
     if (toast.parentElement) {
       toast.style.transform = 'translateX(100%)';
       setTimeout(() => {
         if (toast.parentElement) {
           toast.remove();
         }
       }, 300);
     }
   }, duration);
 }

 // å‘å¸ƒæŒ‰é’®ç‚¹å‡»å¤„ç†å‡½æ•°
 async function handlePublishClick() {
   const publishBtn = document.getElementById('publish-btn');
   const publishStatus = document.getElementById('publish-status');
   
   if (!window.currentAudioSegmentId) {
     showToast('æ²¡æœ‰å¯å‘å¸ƒçš„éŸ³é¢‘ç‰‡æ®µ', 'warning');
     return;
   }
   
   // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   const originalContent = publishBtn.innerHTML;
   publishBtn.disabled = true;
   publishBtn.innerHTML = `
     <span class="loading loading-spinner loading-xs"></span>
     å¤„ç†ä¸­...
   `;
   
   try {
     const response = await fetch(`/workbench/audio/publish/${window.currentAudioSegmentId}/`, {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'X-CSRFToken': '{{ csrf_token }}'
       }
     });
     
     const data = await response.json();
     
     if (data.status === 'success') {
       // æ›´æ–°æŒ‰é’®çŠ¶æ€
       updatePublishButton(data);
       
       // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
       showToast(data.message, 'success');
       
       // æ›´æ–°å‘å¸ƒçŠ¶æ€æ˜¾ç¤º
     } else {
       // æ¢å¤æŒ‰é’®çŠ¶æ€
       publishBtn.disabled = false;
       publishBtn.innerHTML = originalContent;
       
       // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
       showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
       
       // æ›´æ–°å‘å¸ƒçŠ¶æ€æ˜¾ç¤º
       if (publishStatus) {
         publishStatus.className = 'text-sm mt-1 text-center font-medium text-error';
         publishStatus.innerHTML = `
           <div class="flex items-center justify-center">
             <i class="fas fa-times h-4 w-4 mr-1"></i>
             æ“ä½œå¤±è´¥
           </div>
         `;
       }
     }
   } catch (error) {
     console.error('å‘å¸ƒæ“ä½œå¤±è´¥:', error);
     
     // æ¢å¤æŒ‰é’®çŠ¶æ€
     publishBtn.disabled = false;
     publishBtn.innerHTML = originalContent;
     
     // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
     showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
     
     // æ›´æ–°å‘å¸ƒçŠ¶æ€æ˜¾ç¤º
     if (publishStatus) {
       publishStatus.className = 'text-sm mt-1 text-center font-medium text-error';
       publishStatus.innerHTML = `
         <div class="flex items-center justify-center">
           <i class="fas fa-times h-4 w-4 mr-1"></i>
           ç½‘ç»œé”™è¯¯
         </div>
       `;
     }
   }
 }

 // æ›´æ–°å‘å¸ƒæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
 function updatePublishButton(data) {
   const publishBtn = document.getElementById('publish-btn');
   if (!publishBtn) return;
   
   publishBtn.disabled = false;
   
   if (data.published) {
     // å·²å‘å¸ƒçŠ¶æ€ - æ˜¾ç¤ºå–æ¶ˆå‘å¸ƒæŒ‰é’®
     publishBtn.className = 'btn btn-warning btn-sm flex-1';
     publishBtn.innerHTML = `
       <i class="fas fa-times h-5 w-5 mr-1"></i>
       å–æ¶ˆå‘å¸ƒ
     `;
     publishBtn.title = 'å–æ¶ˆå‘å¸ƒ';
   } else {
     // æœªå‘å¸ƒçŠ¶æ€ - æ˜¾ç¤ºå‘å¸ƒæŒ‰é’®
     publishBtn.className = 'btn btn-success btn-sm flex-1';
     publishBtn.innerHTML = `
       <i class="fas fa-check h-5 w-5 mr-1"></i>
       å‘å¸ƒ
     `;
     publishBtn.title = 'å‘å¸ƒ';
   }
 }

// é¡µé¢å›¾ç‰‡æŸ¥çœ‹åŠŸèƒ½ï¼ˆä»…æ”¯æŒPDFï¼‰
function showPageImageButton() {
  const viewImageBtn = document.getElementById('view-page-image-btn');
  
  // åªåœ¨PDFæ–‡ä»¶ä¸”ä¸ºæ‰«æç‰ˆæ—¶æ˜¾ç¤ºæŒ‰é’®
  if (viewImageBtn && 
      window.currentBookPdfType === 'scanned' && 
      '{{ book.file_type|default:"" }}' === '.pdf' &&
      (window.currentPageId || window.currentSelectedPages.length > 0)) {
    viewImageBtn.style.display = 'inline-flex';
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºé€‰ä¸­é¡µé¢æ•°é‡
    const pageCount = window.currentSelectedPages.length || 1;
    const buttonText = pageCount > 1 ? `æŸ¥çœ‹åŸå›¾ (${pageCount}é¡µ)` : 'æŸ¥çœ‹åŸå›¾';
    viewImageBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-4.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
      </svg>
      ${buttonText}
    `;
  } else if (viewImageBtn) {
    viewImageBtn.style.display = 'none';
  }
}

// ç‚¹å‡»æŸ¥çœ‹é¡µé¢å›¾ç‰‡ï¼ˆæ”¯æŒå¤šé¡µé¢ï¼‰
function handleViewPageImage() {
  const pagesToView = window.currentSelectedPages.length > 0 ? 
                     window.currentSelectedPages : 
                     (window.currentPageId ? [window.currentPageId] : []);
  
  if (pagesToView.length === 0) {
    if (typeof showToast === 'function') {
      showToast('è¯·å…ˆé€‰æ‹©è¦æŸ¥çœ‹çš„é¡µé¢', 'warning');
    }
    return;
  }
  
  const modal = document.getElementById('page-image-modal');
  const pageImagesContainer = document.getElementById('page-images-container');
  const loadingIndicator = document.getElementById('image-loading');
  
  if (!modal || !pageImagesContainer || !loadingIndicator) {
    console.error('æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
    return;
  }
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†å’ŒåŠ è½½çŠ¶æ€
  modal.classList.add('modal-open');
  pageImagesContainer.innerHTML = '';
  pageImagesContainer.style.display = 'none';
  loadingIndicator.style.display = 'flex';
  loadingIndicator.innerHTML = `
    <span class="loading loading-spinner loading-lg"></span>
    <span class="ml-2">åŠ è½½ ${pagesToView.length} ä¸ªé¡µé¢å›¾ç‰‡ä¸­...</span>
  `;
  
  // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
  const modalTitle = modal.querySelector('h3');
  if (modalTitle) {
    modalTitle.textContent = pagesToView.length > 1 ? 
      `é¡µé¢åŸå›¾ (å…±${pagesToView.length}é¡µ)` : 'é¡µé¢åŸå›¾';
  }
  
  // å¹¶è¡Œè·å–æ‰€æœ‰é¡µé¢å›¾ç‰‡
  const imagePromises = pagesToView.map((pageId, index) => {
    const imageUrl = `{% url 'get_page_image' book_id=book_id page_number=0 %}`.replace('0', pageId);
    
    return fetch(imageUrl, {
      method: 'GET',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        return {
          success: true,
          pageId: pageId,
          imageData: data.image_data,
          index: index
        };
      } else {
        throw new Error(data.message || `ç¬¬${pageId}é¡µå›¾ç‰‡è·å–å¤±è´¥`);
      }
    })
    .catch(error => {
      return {
        success: false,
        pageId: pageId,
        error: error.message,
        index: index
      };
    });
  });
  
  // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ
  Promise.all(imagePromises).then(results => {
    loadingIndicator.style.display = 'none';
    pageImagesContainer.style.display = 'block';
    
    // åˆ›å»ºå›¾ç‰‡ç½‘æ ¼å®¹å™¨
    const gridContainer = document.createElement('div');
    gridContainer.className = pagesToView.length > 1 ? 
      'grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto' : 
      'flex justify-center';
    
    let successCount = 0;
    results.forEach(result => {
      const imageWrapper = document.createElement('div');
      imageWrapper.className = 'flex flex-col items-center';
      
      if (result.success) {
        const img = document.createElement('img');
        img.src = result.imageData;
        img.alt = `ç¬¬${result.pageId}é¡µ`;
        img.className = 'max-w-full max-h-96 object-contain rounded-lg shadow-lg cursor-zoom-in';
        img.onclick = function() {
          // ç‚¹å‡»å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹
          openImageFullscreen(result.imageData, `ç¬¬${result.pageId}é¡µ`);
        };
        
        const caption = document.createElement('p');
        caption.className = 'text-sm text-gray-600 mt-2';
        caption.textContent = `ç¬¬${result.pageId}é¡µ`;
        
        imageWrapper.appendChild(img);
        imageWrapper.appendChild(caption);
        successCount++;
      } else {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-center p-4 border border-error rounded-lg';
        errorDiv.innerHTML = `
          <i class="fas fa-exclamation-triangle text-error text-2xl mb-2"></i>
          <p class="text-error text-sm">ç¬¬${result.pageId}é¡µåŠ è½½å¤±è´¥</p>
          <p class="text-xs text-gray-500">${result.error}</p>
        `;
        imageWrapper.appendChild(errorDiv);
      }
      
      gridContainer.appendChild(imageWrapper);
    });
    
    pageImagesContainer.appendChild(gridContainer);
    
    // æ˜¾ç¤ºåŠ è½½ç»“æœç»Ÿè®¡
    if (successCount < pagesToView.length) {
      const errorCount = pagesToView.length - successCount;
      if (typeof showToast === 'function') {
        showToast(`å·²åŠ è½½${successCount}é¡µå›¾ç‰‡ï¼Œ${errorCount}é¡µåŠ è½½å¤±è´¥`, 'warning', 5000);
      }
    }
  });
}

const ORIGINAL_MODAL_MAX_PDF_PAGES = 3;
let originalModalEscHandlerBound = false;
let currentPdfObjectUrl = null;

function notifyUser(message, type = 'info') {
  if (typeof showToast === 'function') {
    showToast(message, type);
  } else {
    alert(message);
  }
}

function prepareOriginalModal(title) {
  const modalTitle = document.getElementById('original-modal-title');
  const loadingEl = document.getElementById('original-content-loading');
  const errorEl = document.getElementById('original-content-error');
  const bodyEl = document.getElementById('original-content-body');

  if (modalTitle && title) {
    modalTitle.textContent = title;
  }
  if (loadingEl) {
    loadingEl.style.display = 'flex';
  }
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }
  if (bodyEl) {
    bodyEl.style.display = 'none';
    bodyEl.innerHTML = '';
  }
}

function handleOriginalModalEsc(event) {
  if (event.key === 'Escape') {
    closeOriginalModal();
  }
}

function openOriginalModal() {
  const modal = document.getElementById('original-content-modal');
  if (!modal) return;
  modal.classList.add('modal-open');
  if (!originalModalEscHandlerBound) {
    document.addEventListener('keydown', handleOriginalModalEsc);
    originalModalEscHandlerBound = true;
  }
}

function closeOriginalModal() {
  const modal = document.getElementById('original-content-modal');
  const loadingEl = document.getElementById('original-content-loading');
  const errorEl = document.getElementById('original-content-error');
  const bodyEl = document.getElementById('original-content-body');
  if (modal) {
    modal.classList.remove('modal-open');
  }
  if (loadingEl) {
    loadingEl.style.display = 'none';
  }
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }
  if (bodyEl) {
    bodyEl.style.display = 'none';
    bodyEl.innerHTML = '';
    if (currentPdfObjectUrl) {
      URL.revokeObjectURL(currentPdfObjectUrl);
      currentPdfObjectUrl = null;
    }
  }
  if (originalModalEscHandlerBound) {
    document.removeEventListener('keydown', handleOriginalModalEsc);
    originalModalEscHandlerBound = false;
  }
}

function showOriginalError(message) {
  const loadingEl = document.getElementById('original-content-loading');
  const errorEl = document.getElementById('original-content-error');
  const bodyEl = document.getElementById('original-content-body');
  if (loadingEl) {
    loadingEl.style.display = 'none';
  }
  if (bodyEl) {
    bodyEl.style.display = 'none';
    bodyEl.innerHTML = '';
  }
  if (errorEl) {
    errorEl.style.display = 'block';
    errorEl.textContent = message;
  }
}

function showOriginalContent(renderCallback) {
  const loadingEl = document.getElementById('original-content-loading');
  const errorEl = document.getElementById('original-content-error');
  const bodyEl = document.getElementById('original-content-body');
  if (!bodyEl) return;

  if (loadingEl) {
    loadingEl.style.display = 'none';
  }
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }

  bodyEl.style.display = 'block';
  bodyEl.innerHTML = '';
  if (typeof renderCallback === 'function') {
    renderCallback(bodyEl);
  }
}

async function renderPdfOriginalContent(pageIds) {
  const normalizedPages = Array.from(new Set((pageIds || []).map(p => parseInt(p, 10)).filter(num => !isNaN(num) && num >= 0))).sort((a, b) => a - b);

  if (normalizedPages.length === 0) {
    showOriginalError('è¯·å…ˆé€‰æ‹©è¦æŸ¥çœ‹çš„é¡µç ');
    return;
  }

  if (!window.currentBookFileUrl) {
    showOriginalError('æ— æ³•å®šä½åŸå§‹PDFæ–‡ä»¶');
    return;
  }

  try {
    if (currentPdfObjectUrl) {
      URL.revokeObjectURL(currentPdfObjectUrl);
      currentPdfObjectUrl = null;
    }

    const response = await fetch(window.currentBookFileUrl, {
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error(`åŠ è½½PDFå¤±è´¥ï¼š${response.status}`);
    }

    const pdfBlob = await response.blob();
    currentPdfObjectUrl = URL.createObjectURL(pdfBlob);

    showOriginalContent(bodyEl => {
      const previewPages = normalizedPages.slice(0, ORIGINAL_MODAL_MAX_PDF_PAGES);
      const displayPages = previewPages.map(page => page + 1);
      if (normalizedPages.length > ORIGINAL_MODAL_MAX_PDF_PAGES) {
        const hint = document.createElement('div');
        hint.className = 'px-4 pt-4 text-xs text-base-content/60';
        hint.textContent = `æœ¬çª—å£é¢„è§ˆç¬¬ ${displayPages.join('ã€')} é¡µï¼Œå‰©ä½™ ${normalizedPages.length - ORIGINAL_MODAL_MAX_PDF_PAGES} é¡µå¯åœ¨æ–°æ ‡ç­¾æŸ¥çœ‹ã€‚`;
        bodyEl.appendChild(hint);
      }

      previewPages.forEach(pageNumber => {
        const displayPage = pageNumber + 1;
        const wrapper = document.createElement('div');

        const iframe = document.createElement('iframe');
        iframe.className = 'w-full h-[70vh] rounded border border-base-300 bg-base-100';
        iframe.setAttribute('loading', 'lazy');
        iframe.setAttribute('title', `ç¬¬ ${displayPage} é¡µåŸæ–‡`);
        iframe.src = `${currentPdfObjectUrl}#page=${encodeURIComponent(displayPage)}`;
        wrapper.appendChild(iframe);

        const actions = document.createElement('div');
        actions.className = 'flex justify-end';
        const openLink = document.createElement('a');
        openLink.href = `${window.currentBookFileUrl}#page=${encodeURIComponent(displayPage)}`;
        openLink.target = '_blank';
        openLink.rel = 'noopener';
        openLink.className = 'link link-secondary text-sm';
        openLink.textContent = 'æ–°æ ‡ç­¾æ‰“å¼€';
        actions.appendChild(openLink);
        wrapper.appendChild(actions);

        bodyEl.appendChild(wrapper);
      });
    });
  } catch (error) {
    console.error('[OriginalContent] PDF åŠ è½½å¤±è´¥:', error);
    showOriginalError(error.message || 'åŠ è½½åŸå§‹PDFå¤±è´¥');
  }
}

async function fetchEpubOriginalContent(contentIds) {
  const endpoint = `{% url 'get_original_content' book_id=book_id %}`;
  try {
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ content_ids: contentIds })
    });

    const data = await response.json();

    if (!response.ok || data.status !== 'success') {
      throw new Error(data.message || 'è·å–åŸå§‹å†…å®¹å¤±è´¥');
    }

    showOriginalContent(bodyEl => {
      const iframe = document.createElement('iframe');
      iframe.className = 'w-full h-[60vh] bg-base-100';
      iframe.setAttribute('loading', 'lazy');
      iframe.setAttribute('sandbox', 'allow-same-origin');
      iframe.srcdoc = data.html || '<div style="padding:1rem;">æš‚æ— åŸå§‹å†…å®¹</div>';
      bodyEl.appendChild(iframe);
    });
  } catch (error) {
    console.error('[OriginalContent] è·å–å¤±è´¥:', error);
    showOriginalError(error.message || 'è·å–åŸå§‹å†…å®¹å¤±è´¥');
  }
}

function handleViewOriginalContent() {
  const fileType = (window.currentBookFileType || '').toLowerCase();
  let contentIds = Array.isArray(window.currentSelectedContentIds) ? window.currentSelectedContentIds.slice() : [];
  if (!contentIds.length && window.currentPageId) {
    contentIds = [window.currentPageId];
  }

  if (!contentIds.length) {
    notifyUser('è¯·å…ˆé€‰æ‹©ç« èŠ‚æˆ–é¡µé¢', 'warning');
    return;
  }

  if (fileType === '.pdf') {
    prepareOriginalModal('åŸå§‹PDFé¡µé¢');
    openOriginalModal();
    const pages = Array.isArray(window.currentSelectedPages) && window.currentSelectedPages.length
      ? window.currentSelectedPages
      : contentIds;
    renderPdfOriginalContent(pages);
  } else if (fileType === '.epub') {
    prepareOriginalModal('åŸå§‹ç« èŠ‚å†…å®¹');
    openOriginalModal();
    fetchEpubOriginalContent(contentIds);
  } else {
    notifyUser('å½“å‰æ ¼å¼æš‚ä¸æ”¯æŒåŸæ–‡æŸ¥çœ‹', 'warning');
  }
}

// å…¨å±æŸ¥çœ‹å•ä¸ªå›¾ç‰‡
function openImageFullscreen(imageData, title) {
  const fullscreenModal = document.createElement('div');
  fullscreenModal.className = 'modal modal-open';
  fullscreenModal.innerHTML = `
    <div class="modal-box max-w-full max-h-full w-full h-full p-0 bg-black">
      <div class="relative w-full h-full flex items-center justify-center">
        <img src="${imageData}" alt="${title}" class="max-w-full max-h-full object-contain" />
        <button class="btn btn-circle btn-ghost absolute top-4 right-4 text-white bg-black bg-opacity-50"
                onclick="this.closest('.modal').remove()">âœ•</button>
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white bg-black bg-opacity-50 px-4 py-2 rounded">
          ${title}
        </div>
      </div>
    </div>
  `;
  
  // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
  fullscreenModal.addEventListener('click', function(e) {
    if (e.target === fullscreenModal) {
      fullscreenModal.remove();
    }
  });
  
  // ESCé”®å…³é—­
  const escHandler = function(e) {
    if (e.key === 'Escape') {
      fullscreenModal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
  
  document.body.appendChild(fullscreenModal);
}

// è§£æPDFé¡µç èŒƒå›´çš„ç®€å•å‡½æ•°
function parsePdfPageIds(href) {
  const normalizedIds = [];
  if (!href) return normalizedIds;

  const addId = (value) => {
    const num = parseInt(value, 10);
    if (isNaN(num)) return;
    const zeroBased = Math.max(num - 1, 0);
    normalizedIds.push(zeroBased.toString());
  };

  if (href.includes('-')) {
    const [startStr, endStr] = href.split('-', 2);
    const start = parseInt(startStr, 10);
    const end = parseInt(endStr, 10);
    if (!isNaN(start)) {
      const finalEnd = !isNaN(end) ? end : start;
      const rangeStart = Math.max(Math.min(start, finalEnd), 1);
      const rangeEnd = Math.max(start, finalEnd);
      for (let i = rangeStart; i <= rangeEnd; i++) {
        addId(i);
      }
    }
  } else {
    addId(href);
  }

  return normalizedIds;
}

// æ£€æŸ¥é¡µé¢éŸ³é¢‘çŠ¶æ€
function checkPageAudioStatus(pageIds) {
  let ids = Array.isArray(pageIds) ? pageIds.filter(id => id !== undefined && id !== null && id !== '') : [];

  if (!ids.length && Array.isArray(window.currentSelectedPages)) {
    ids = window.currentSelectedPages.filter(id => id !== undefined && id !== null && id !== '');
  }

  if (!ids.length && Array.isArray(window.currentSelectedContentIds)) {
    ids = window.currentSelectedContentIds.filter(id => id !== undefined && id !== null && id !== '');
  }

  if (!ids.length && window.currentPageId) {
    ids = [window.currentPageId];
  }

  if (!ids.length) {
    updateAudioStatusDisplay('è¯·å…ˆé€‰æ‹©é¡µé¢');
    return;
  }

  const statusContainer = document.getElementById('page-audio-status');
  if (!statusContainer) return;
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  statusContainer.innerHTML = `
    <div class="flex items-center justify-center">
      <span class="loading loading-spinner loading-xs"></span>
      <span class="ml-2 text-xs">æ£€æŸ¥éŸ³é¢‘çŠ¶æ€ä¸­...</span>
    </div>
  `;
  
  // æ„å»ºè¯·æ±‚URL
  const requestIds = ids.map(id => {
    const numeric = parseInt(id, 10);
    if (isNaN(numeric)) {
      return id;
    }
    return Math.max(numeric + 1, 1).toString();
  });

  const url = `{% url 'check_page_audio_status' book_id=book_id %}?page_ids=${requestIds.join(',')}`;
  
  fetch(url, {
    method: 'GET',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      displayAudioStatus(data);
    } else {
      updateAudioStatusDisplay('æ£€æŸ¥å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
    }
  })
  .catch(error => {
    console.error('æ£€æŸ¥éŸ³é¢‘çŠ¶æ€å¤±è´¥:', error);
    updateAudioStatusDisplay('æ£€æŸ¥å¤±è´¥: ç½‘ç»œé”™è¯¯');
  });
}

// æ˜¾ç¤ºéŸ³é¢‘çŠ¶æ€
function displayAudioStatus(data) {
  const statusContainer = document.getElementById('page-audio-status');
  if (!statusContainer) return;
  
  const { total_pages, pages_with_audio, coverage_rate, audio_status } = data;
  
  let statusHtml = '';
  
  // æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
  if (total_pages > 1) {
    statusHtml += `
      <div class="flex justify-between items-center text-xs mb-2 p-2 bg-base-200 rounded">
        <span class="font-medium">æ€»è®¡ ${total_pages} é¡µ</span>
        <span class="font-medium">å·²ç”Ÿæˆ ${pages_with_audio} ä¸ª</span>
        <span class="badge badge-xs ${coverage_rate >= 100 ? 'badge-success' : coverage_rate >= 50 ? 'badge-warning' : 'badge-error'}">
          ${coverage_rate}%
        </span>
      </div>
    `;
  }
  
  // æ˜¾ç¤ºè¯¦ç»†çŠ¶æ€ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰5ä¸ªé¡µé¢çš„çŠ¶æ€ï¼‰
  const pageIds = Object.keys(audio_status);
  const maxDisplay = 5;
  
  statusHtml += '<div class="space-y-1">';
  
  for (let i = 0; i < Math.min(pageIds.length, maxDisplay); i++) {
    const pageId = pageIds[i];
    const status = audio_status[pageId];
    
    if (status.has_audio) {
      statusHtml += `
        <div class="cursor-pointer hover:bg-success hover:bg-opacity-20 transition-colors duration-200 p-2 bg-success bg-opacity-10 rounded border border-success border-opacity-20"
             onclick="jumpToAudioDetail(${status.audio_id})" title="ç‚¹å‡»æŸ¥çœ‹éŸ³é¢‘è¯¦æƒ…">
          <div class="flex items-center justify-between">
            <div class="flex items-center min-w-0">
              <i class="fas fa-volume-up text-success mr-2"></i>
              <div class="min-w-0 flex-1">
                <div class="text-xs font-medium text-success truncate">
                  ${status.title || 'ç¬¬' + pageId + 'é¡µéŸ³é¢‘'}
                </div>
                <div class="text-xs text-gray-500">
                  ${status.created_at}
                  ${status.published ? '<span class="ml-1 badge badge-xs badge-info">å·²å‘å¸ƒ</span>' : ''}
                </div>
              </div>
            </div>
            <i class="fas fa-external-link-alt text-gray-400 text-xs ml-2"></i>
          </div>
        </div>
      `;
    } else {
      statusHtml += `
        <div class="flex items-center text-xs p-2 bg-base-200 rounded border border-base-300 w-full overflow-hidden">
          <i class="fas fa-volume-mute text-gray-400 mr-2 flex-shrink-0"></i>
          <span class="text-gray-600 truncate" title="ç¬¬${pageId}é¡µ - æœªç”ŸæˆéŸ³é¢‘">ç¬¬${pageId}é¡µ - æœªç”ŸæˆéŸ³é¢‘</span>
        </div>
      `;
    }
  }
  
  // å¦‚æœé¡µé¢æ•°é‡è¶…è¿‡æ˜¾ç¤ºé™åˆ¶ï¼Œæ˜¾ç¤ºçœç•¥æç¤º
  if (pageIds.length > maxDisplay) {
    statusHtml += `
      <div class="text-xs text-gray-500 text-center mt-2 p-1">
        <i class="fas fa-ellipsis-h mr-1"></i>
        è¿˜æœ‰ ${pageIds.length - maxDisplay} é¡µæœªæ˜¾ç¤º
      </div>
    `;
  }
  
  statusHtml += '</div>';
  
  statusContainer.innerHTML = statusHtml;
}

// è·³è½¬åˆ°éŸ³é¢‘è¯¦æƒ…é¡µ
function jumpToAudioDetail(audioId) {
  if (!audioId) return;
  
  // æ„å»ºè·³è½¬URLåˆ°éŸ³é¢‘åˆ—è¡¨é¡µé¢ï¼Œé€šè¿‡é”šç‚¹è§¦å‘HTMXåŠ è½½å’Œå®šä½
  const audioListUrl = `{% url 'aggregated_audio_segments' %}#audio-${audioId}`;
  
  // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€éŸ³é¢‘åˆ—è¡¨é¡µï¼Œé”šç‚¹ä¼šè§¦å‘è‡ªåŠ¨åŠ è½½å¯¹åº”ä¹¦ç±è¯¦æƒ…å’Œå®šä½
  window.open(audioListUrl, '_blank');
}

// æ›´æ–°éŸ³é¢‘çŠ¶æ€æ˜¾ç¤ºï¼ˆç”¨äºé”™è¯¯æˆ–æç¤ºä¿¡æ¯ï¼‰
function updateAudioStatusDisplay(message) {
  const statusContainer = document.getElementById('page-audio-status');
  if (!statusContainer) return;
  
  statusContainer.innerHTML = `
    <div class="text-sm text-gray-500 text-center">
      ${message}
    </div>
  `;
}

// å…¨å±€å‡½æ•°ï¼Œä¾›å…¶ä»–ç»„ä»¶è°ƒç”¨æ¥æ›´æ–°PDFç±»å‹
window.updateBookPdfType = function(pdfType) {
  window.currentBookPdfType = pdfType;
  showPageImageButton();
};

// å…¨å±€å‡½æ•°ï¼Œä¾›TOCå’Œpagesç»„ä»¶è°ƒç”¨æ¥æ›´æ–°å½“å‰é¡µé¢çŠ¶æ€
window.updateCurrentPageState = function(pageId, pageName, pdfType, selectedPages, contentIds) {
  window.currentPageId = pageId;
  window.currentPageName = pageName;
  if (pdfType) {
    window.currentBookPdfType = pdfType;
  }
  
  // æ›´æ–°é€‰ä¸­çš„é¡µé¢åˆ—è¡¨
  if (selectedPages && Array.isArray(selectedPages)) {
    window.currentSelectedPages = selectedPages;
  } else {
    window.currentSelectedPages = pageId ? [pageId] : [];
  }
  
  if (contentIds && Array.isArray(contentIds)) {
    window.currentSelectedContentIds = contentIds;
  } else if (selectedPages && Array.isArray(selectedPages)) {
    window.currentSelectedContentIds = selectedPages;
  } else {
    window.currentSelectedContentIds = pageId ? [pageId] : [];
  }
  
  showPageImageButton();
  
  // è‡ªåŠ¨æ£€æŸ¥é¡µé¢éŸ³é¢‘çŠ¶æ€
  checkPageAudioStatus(window.currentSelectedPages);
};

// é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®å›¾ç‰‡æŸ¥çœ‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
$(document).ready(function() {
  // è®¾ç½®å›¾ç‰‡æŸ¥çœ‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  const viewImageBtn = document.getElementById('view-page-image-btn');
  if (viewImageBtn) {
    viewImageBtn.addEventListener('click', handleViewPageImage);
  }
  const viewOriginalBtn = document.getElementById('view-original-btn');
  if (viewOriginalBtn) {
    viewOriginalBtn.addEventListener('click', handleViewOriginalContent);
  }

  const closeOriginalModalBtn = document.getElementById('close-original-modal');
  if (closeOriginalModalBtn) {
    closeOriginalModalBtn.addEventListener('click', closeOriginalModal);
  }

  const dismissOriginalModalBtn = document.getElementById('dismiss-original-modal');
  if (dismissOriginalModalBtn) {
    dismissOriginalModalBtn.addEventListener('click', closeOriginalModal);
  }

  const originalBackdrop = document.getElementById('original-modal-backdrop');
  if (originalBackdrop) {
    originalBackdrop.addEventListener('click', closeOriginalModal);
  }
  
  // è®¾ç½®åˆå§‹çš„PDFç±»å‹ï¼ˆä»Djangoæ¨¡æ¿ä¼ é€’ï¼‰
  {% if book %}
    window.currentBookFileType = ('{{ book.file_type|default:"" }}' || '').toLowerCase();
    {% if book.file %}
      window.currentBookFileUrl = '{{ book.file.url|escapejs }}';
    {% endif %}
    window.currentBookPdfType = '{{ book.pdf_type|default:"unknown" }}';
    showPageImageButton();
  {% endif %}
});

// å¾®ä¿¡äºŒç»´ç æ¨¡æ€æ¡†åŠŸèƒ½
function showWeChatQR() {
  const modal = document.getElementById('wechat-qr-modal');
  if (modal) {
    modal.classList.add('modal-open');
  }
}

function closeWeChatQR() {
  const modal = document.getElementById('wechat-qr-modal');
  if (modal) {
    modal.classList.remove('modal-open');
  }
}
</script>

{% endblock %}
