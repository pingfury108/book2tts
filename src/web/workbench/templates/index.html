{% extends "base.html" %}

{% block title %}{{ title }} - åˆ¶ä½œå·¥ä½œå° - Book2TTS{% endblock %}

{% block content %}
<div class="flex p-2 w-full h-screen bg-base-100">
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg flex flex-col">
      <div class="container text-center p-2">
        <h2 class="text-lg font-bold mb-2">ğŸ“š {{ title }}</h2>
        <div role="tablist" class="tabs tabs-bordered">
          <a role="tab" class="tab tab-active" id="tab_toc"
             hx-get="{% url 'toc' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >
            TOC ({{ tocs|length }} ç« )
          </a>
          <a role="tab" class="tab" id="tab_page"
             hx-get="{% url 'pages' book_id=book_id %}"
             hx-target="#toc"
             hx-trigger="click"
             hx-swap="innerHTML"
          >é¡µé¢ ({{ pages|length }} é¡µ)</a>
        </div>
      </div>
        <div class="container pt-2 flex-grow overflow-y-auto" id="toc" hx-get="{% url 'toc' book_id=book_id %}" hx-trigger="load">
        </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-3/5 overflow-hidden rounded-lg bg-base-100 shadow-lg">
        <div class="container text-center pt-2 bg-primary text-primary-content rounded-t-lg">
            <h3 class="text-lg font-sans font-bold py-2">ğŸ“„ å†…å®¹</h3>
        </div>
        <div class="container p-2 flex flex-col h-[calc(100%-3.5rem)]" id="context">
            <div class="mb-2 p-2 bg-base-200 rounded-lg">
                <div class="flex justify-between items-center">
                    <div class="flex gap-2 items-center">
                        <div class="badge badge-primary p-3 text-sm">ç« èŠ‚å†…å®¹</div>
                        <div class="badge badge-outline p-2 text-xs" id="word-count-badge">0 å­—</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-xs btn-outline" id="format-text-btn">è‡ªåŠ¨æ’ç‰ˆ</button>
                        <button class="btn btn-xs btn-outline" id="increase-font-btn">æ”¾å¤§å­—ä½“</button>
                        <button class="btn btn-xs btn-outline" id="decrease-font-btn">ç¼©å°å­—ä½“</button>
                    </div>
                </div>
            </div>
            <textarea class="textarea textarea-bordered flex-grow w-full bg-base-100 font-serif" id="src-text" name="texts" placeholder="é€‰æ‹©å·¦ä¾§ç›®å½•æˆ–é¡µé¢ä»¥åŠ è½½å†…å®¹..." style="font-size: 16px; line-height: 1.6; min-height: 0;"></textarea>
        </div>
    </div>
    <div class="divider divider-horizontal"></div>
    <div class="grow h-full w-1/5 overflow-hidden rounded-lg bg-base-200 shadow-lg">
      <div class="container text-center p-2 bg-secondary text-secondary-content rounded-t-lg">
            <h3 class="font-bold py-2">âš™ï¸ æ§åˆ¶é¢æ¿</h3>
        </div>
        <div class="overflow-y-auto h-[calc(100vh-4rem)] space-y-3 p-2">
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">ğŸ“š ä¹¦ç±ä¿¡æ¯</h3>
                    <div class="flex flex-col gap-1">
                        <div>
                            <label class="font-bold">ä¹¦å:</label>
                            <span class="text-sm">{{ title }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">â±ï¸ é…é¢ä¿¡æ¯</h3>
                    <div class="space-y-2" id="quota-info"
                         hx-get="{% url 'get_user_quota' %}"
                         hx-trigger="load, refresh"
                         hx-target="this"
                         hx-swap="innerHTML">
                        <div class="flex items-center justify-center">
                            <span class="loading loading-spinner loading-sm"></span>
                            <span class="ml-2 text-sm">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg font-bold">ğŸ”Š éŸ³é¢‘å¤„ç†</h3>
                    <div class="space-y-1">
                        <select class="select select-bordered w-full" id="tts-provider">
                            <option disabled selected>TTS ä¾›åº”å•†</option>
                            <option value="azure">azure</option>
                            <option value="edge-tts" selected>edge-tts</option>
                        </select>
                        <select class="select select-bordered w-full" id="voice-model"
                                hx-get="{% url 'voice_list' %}"
                                hx-trigger="load"
                                hx-target="this"
                                hx-swap="innerHTML">
                            <option disabled selected>è¯­éŸ³æ¨¡å‹</option>
                        </select>
                        <input type="text" id="audio-title-input" class="input input-bordered w-full" placeholder="éŸ³é¢‘æ ‡é¢˜ï¼ˆé€‰å¡«ï¼‰" />
                        <button class="btn btn-primary w-full" id="synthesize-btn">åˆæˆéŸ³é¢‘</button>
                        <div id="audio-player-container" class="hidden mt-2 p-3 bg-base-300 rounded-lg">
                            <div class="text-center mb-3">
                                <div class="inline-block bg-primary text-primary-content px-3 py-2 rounded-lg text-sm font-medium leading-relaxed max-w-full break-words" id="audio-title" style="min-height: 2.5rem; line-height: 1.4;"></div>
                            </div>
                            <audio id="audio-player" controls class="w-full"></audio>
                            <div id="audio-status" class="text-sm mt-1 text-center font-medium text-success"></div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-secondary flex-1" id="download-btn" disabled>
                                <i class="fas fa-download h-5 w-5 mr-1"></i>
                                ä¸‹è½½
                            </button>
                            <button class="btn btn-accent flex-1" id="publish-btn" disabled
                                    onclick="handlePublishClick()">
                                <i class="fas fa-upload h-5 w-5 mr-1"></i>
                                å‘å¸ƒ
                            </button>
                        </div>
                        <div id="publish-status" class="text-sm mt-1 text-center font-medium"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
 // ä¸ºæ‰€æœ‰ HTMX è¯·æ±‚æ·»åŠ  CSRF ä»¤ç‰Œ
 document.body.addEventListener('htmx:configRequest', function(evt) {
   evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
 });

 // é‡ç½®éŸ³é¢‘æ˜¾ç¤ºåŠŸèƒ½
 function resetAudioDisplay() {
   // éšè—éŸ³é¢‘æ’­æ”¾å™¨å®¹å™¨
   const playerContainer = document.getElementById('audio-player-container');
   if (playerContainer) {
     playerContainer.classList.add('hidden');
   }
   
   // é‡ç½®éŸ³é¢‘æ’­æ”¾å™¨æºå’Œæ˜¾ç¤º
   const audioPlayer = document.getElementById('audio-player');
   if (audioPlayer) {
     audioPlayer.src = '';
     audioPlayer.pause();
     audioPlayer.style.display = ''; // æ¢å¤æ˜¾ç¤º
   }
   
   // é‡ç½®ç›¸å…³çŠ¶æ€å’ŒæŒ‰é’®
   const audioTitle = document.getElementById('audio-title');
   if (audioTitle) {
     audioTitle.textContent = '';
   }
   
   const audioStatus = document.getElementById('audio-status');
   if (audioStatus) {
     audioStatus.textContent = '';
     audioStatus.innerHTML = ''; // æ¸…é™¤æ‰€æœ‰HTMLå†…å®¹
     audioStatus.className = 'text-sm mt-1 text-center font-medium text-success'; // é‡ç½®ä¸ºé»˜è®¤æ ·å¼
   }
   
   // ç¦ç”¨ä¸‹è½½å’Œå‘å¸ƒæŒ‰é’®
   const downloadBtn = document.getElementById('download-btn');
   if (downloadBtn) {
     downloadBtn.disabled = true;
   }
   
   const publishBtn = document.getElementById('publish-btn');
   if (publishBtn) {
     publishBtn.disabled = true;
   }
   
   // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€
   const synthesizeBtn = document.getElementById('synthesize-btn');
   if (synthesizeBtn) {
     synthesizeBtn.innerHTML = 'åˆæˆéŸ³é¢‘';
     synthesizeBtn.disabled = false;
   }
   
   // é‡ç½®å½“å‰éŸ³é¢‘ID
   window.currentAudioSegmentId = 0;
 }

 // Font size adjustment with HTMX compatibility
 function setupFontSizeButtons() {
   // å»é™¤å¯é€‰é“¾æ“ä½œç¬¦ï¼Œä½¿ç”¨å¸¸è§„nullæ£€æŸ¥
   const increaseFontBtn = document.getElementById('increase-font-btn');
   if (increaseFontBtn) {
     increaseFontBtn.addEventListener('click', function() {
       const textarea = document.getElementById('src-text');
       const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
       textarea.style.fontSize = (currentSize + 2) + 'px';
     });
   }
   
   const decreaseFontBtn = document.getElementById('decrease-font-btn');
   if (decreaseFontBtn) {
     decreaseFontBtn.addEventListener('click', function() {
       const textarea = document.getElementById('src-text');
       const currentSize = parseInt(window.getComputedStyle(textarea).fontSize);
       if (currentSize > 12) {
         textarea.style.fontSize = (currentSize - 2) + 'px';
       }
     });
   }
 }

 // å­—æ•°ç»Ÿè®¡åŠŸèƒ½ï¼ˆå¸¦é˜²é‡å¤æœºåˆ¶ï¼‰
 let lastUpdateTime = 0;
 let lastCountValue = -1;
 let lastTextValue = ''; // æ·»åŠ æ–‡æœ¬å†…å®¹ç¼“å­˜ï¼Œä¾›å®šæœŸæ£€æŸ¥ä½¿ç”¨
 
 function updateWordCount() {
   const textarea = document.getElementById('src-text');
   const wordCountBadge = document.getElementById('word-count-badge');
   
   if (textarea && wordCountBadge) {
     const text = textarea.value;
     // è®¡ç®—å­—ç¬¦æ•°ï¼ˆå»é™¤ç©ºç™½å­—ç¬¦ï¼‰
     const charCount = text.replace(/\s/g, '').length;
     const currentTime = Date.now();
     
     // é˜²é‡å¤æœºåˆ¶ï¼šå¦‚æœå­—æ•°ç›¸åŒä¸”æ—¶é—´é—´éš”å°äº2000msï¼Œåˆ™è·³è¿‡æ›´æ–°
     if (charCount === lastCountValue && (currentTime - lastUpdateTime) < 2000) {
       return;
     }
     
     wordCountBadge.textContent = `${charCount} å­—`;
     lastUpdateTime = currentTime;
     lastCountValue = charCount;
     lastTextValue = text; // åŒæ­¥æ›´æ–°æ–‡æœ¬ç¼“å­˜
     
     // è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
     if (charCount > 0) {
       console.log('[WordCount] å­—æ•°å·²æ›´æ–°:', charCount, 'æ—¶é—´:', new Date().toLocaleTimeString());
     }
   }
 }

 // åˆå§‹åŒ–å­—ä½“è°ƒæ•´æŒ‰é’®å’Œå­—æ•°ç»Ÿè®¡
 $(document).ready(function() {
   setupFontSizeButtons();
   
   // åˆå§‹åŒ–å­—æ•°ç»Ÿè®¡
   updateWordCount();
   
   // æ‹¦æˆªjQueryçš„valæ–¹æ³•æ¥ç›‘å¬å†…å®¹å˜åŒ–
   interceptJQueryVal();
   
   // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
   setupPeriodicCheck();
   
   // ç›‘å¬æ–‡æœ¬åŒºåŸŸå˜åŒ–
   const textarea = document.getElementById('src-text');
   if (textarea) {
     textarea.addEventListener('input', updateWordCount);
     textarea.addEventListener('paste', function() {
       // ç²˜è´´åéœ€è¦å»¶è¿Ÿä¸€ä¸‹å†ç»Ÿè®¡ï¼Œç¡®ä¿å†…å®¹å·²æ›´æ–°
       setTimeout(updateWordCount, 10);
     });
   }
 });

 // æ·»åŠ è°ƒè¯•æ—¥å¿—
 function logState(message) {
   console.log(`[State] ${message}:`, {
     currentPageName: window.currentPageName,
     currentPageId: window.currentPageId,
     activeTab: window.activeTab,
     currentAudioSegmentId: window.currentAudioSegmentId
   });
 }

 // é¡µé¢/ç›®å½•é¡¹ç‚¹å‡»å¤„ç†
 window.currentPageName = window.currentPageName || ''; // Display name
 window.currentPageId = window.currentPageId || ''; // Actual page ID
 window.activeTab = window.activeTab || 'tab_toc'; // Track which tab is currently active
 window.currentAudioSegmentId = window.currentAudioSegmentId || 0;

 // Tab switching
 $(document).ready(function() {
   $('#tab_toc').on('click', function() {
     $(this).addClass('tab-active');
     $('#tab_page').removeClass('tab-active');
     window.activeTab = 'tab_toc';
     resetAudioDisplay(); // åˆ‡æ¢åˆ°ç›®å½•é€‰é¡¹å¡æ—¶é‡ç½®éŸ³é¢‘æ˜¾ç¤º
     logState('Tab switched to TOC');
   });

   $('#tab_page').on('click', function() {
     $(this).addClass('tab-active');
     $('#tab_toc').removeClass('tab-active');
     window.activeTab = 'tab_page';
     resetAudioDisplay(); // åˆ‡æ¢åˆ°é¡µé¢é€‰é¡¹å¡æ—¶é‡ç½®éŸ³é¢‘æ˜¾ç¤º
     logState('Tab switched to Page');
   });
 });

 // éŸ³é¢‘åˆæˆå’Œç®¡ç†
 const synthesizeBtn = document.getElementById('synthesize-btn');
 if (synthesizeBtn) {
   synthesizeBtn.addEventListener('click', async function() {
     const textContent = document.getElementById('src-text').value;
     const voiceModel = document.getElementById('voice-model').value;
     const audioTitle = document.getElementById('audio-title-input').value || window.currentPageName;
     
     if (!textContent || !voiceModel) {
       alert('è¯·å…ˆé€‰æ‹©è¯­éŸ³æ¨¡å‹å¹¶è¾“å…¥æ–‡æœ¬');
       return;
     }
     
     // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     this.innerHTML = '<span class="loading loading-spinner loading-xs"></span> å¯åŠ¨ä»»åŠ¡...';
     this.disabled = true;
     console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šå¯åŠ¨ä»»åŠ¡ä¸­');
     
     try {
       // å¯åŠ¨éŸ³é¢‘åˆæˆä»»åŠ¡
       const response = await fetch(`{% url 'synthesize_audio' %}`, {
         method: 'POST',
         headers: {
           'Content-Type': 'application/x-www-form-urlencoded',
           'X-CSRFToken': '{{ csrf_token }}'
         },
         body: new URLSearchParams({
           text: textContent,
           voice_name: voiceModel,
           book_id: '{{ book_id }}',
           title: audioTitle || 'æœªå‘½åéŸ³é¢‘',
           book_page: window.currentPageId || '',
           page_display_name: window.currentPageName || '',
           audio_title: audioTitle || ''
         })
       });
       
       const data = await response.json();
       console.log('Audio synthesis response:', data);
       
       if (data.status === 'started') {
         // ä»»åŠ¡å·²å¯åŠ¨ï¼Œå¼€å§‹è½®è¯¢çŠ¶æ€
         this.innerHTML = '<span class="loading loading-spinner loading-xs"></span> æ­£åœ¨åˆæˆ...';
         console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šæ­£åœ¨åˆæˆ');
         await pollTaskStatus(data.task_id, audioTitle);
       } else {
         // å¤„ç†å¯åŠ¨å¤±è´¥çš„æƒ…å†µ
         console.log('[Button] ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
         await handleAudioError(data.message || 'å¯åŠ¨éŸ³é¢‘åˆæˆä»»åŠ¡å¤±è´¥');
       }
     } catch (error) {
       console.error('å¯åŠ¨éŸ³é¢‘åˆæˆä»»åŠ¡é”™è¯¯:', error);
       console.log('[Button] å‘ç”Ÿå¼‚å¸¸ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
       await handleAudioError(`ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸: ${error.message}`);
     }
   });
 }

 // è½®è¯¢ä»»åŠ¡çŠ¶æ€çš„å‡½æ•°
 async function pollTaskStatus(taskId, audioTitle) {
   const maxAttempts = 120; // æœ€å¤šè½®è¯¢2åˆ†é’Ÿ
   let attempts = 0;
   
   const poll = async () => {
     attempts++;
     
     try {
       const response = await fetch(`{% url 'check_task_status' 'TASK_ID' %}`.replace('TASK_ID', taskId));
       const statusData = await response.json();
       
       console.log('Task status:', statusData);
       
       const synthesizeBtn = document.getElementById('synthesize-btn');
       
       switch (statusData.status) {
         case 'pending':
           if (synthesizeBtn) {
             synthesizeBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> ç­‰å¾…æ‰§è¡Œ...';
             synthesizeBtn.disabled = true;
             console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šç­‰å¾…æ‰§è¡Œ');
           }
           break;
           
         case 'processing':
           if (synthesizeBtn) {
             synthesizeBtn.innerHTML = `<span class="loading loading-spinner loading-xs"></span> ${statusData.message || 'æ­£åœ¨å¤„ç†...'}`;
             synthesizeBtn.disabled = true;
             console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šæ­£åœ¨å¤„ç† -', statusData.message);
           }
           break;
           
         case 'success':
           // ä»»åŠ¡æˆåŠŸå®Œæˆ
           console.log('[Button] ä»»åŠ¡æˆåŠŸå®Œæˆï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
           await handleAudioSuccess(statusData, audioTitle);
           return; // åœæ­¢è½®è¯¢
           
         case 'failure':
           // ä»»åŠ¡å¤±è´¥
           console.log('[Button] ä»»åŠ¡å¤±è´¥ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
           await handleAudioError(statusData.message || 'éŸ³é¢‘åˆæˆå¤±è´¥');
           return; // åœæ­¢è½®è¯¢
           
         default:
           if (synthesizeBtn) {
             synthesizeBtn.innerHTML = `<span class="loading loading-spinner loading-xs"></span> ${statusData.message || 'å¤„ç†ä¸­...'}`;
             synthesizeBtn.disabled = true;
             console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€ï¼šå¤„ç†ä¸­ -', statusData.message);
           }
           break;
       }
       
       // å¦‚æœè¿˜æ²¡å®Œæˆä¸”æœªè¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œç»§ç»­è½®è¯¢
       if (attempts < maxAttempts) {
         setTimeout(poll, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
       } else {
         console.log('[Button] è½®è¯¢è¶…æ—¶ï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
         await handleAudioError('éŸ³é¢‘åˆæˆè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
       }
       
     } catch (error) {
       console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€é”™è¯¯:', error);
       if (attempts < maxAttempts) {
         setTimeout(poll, 2000); // å‡ºé”™æ—¶2ç§’åé‡è¯•
       } else {
         console.log('[Button] è½®è¯¢é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œå³å°†æ¢å¤æŒ‰é’®çŠ¶æ€');
         await handleAudioError('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥');
       }
     }
   };
   
   // å¼€å§‹è½®è¯¢
   setTimeout(poll, 1000); // 1ç§’åå¼€å§‹ç¬¬ä¸€æ¬¡è½®è¯¢
 }

 // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
 function restoreSynthesizeButton() {
   const synthesizeBtn = document.getElementById('synthesize-btn');
   if (synthesizeBtn) {
     synthesizeBtn.innerHTML = 'åˆæˆéŸ³é¢‘';
     synthesizeBtn.disabled = false;
     console.log('[Button] åˆæˆæŒ‰é’®çŠ¶æ€å·²æ¢å¤ä¸ºå¯ç”¨çŠ¶æ€');
   }
 }

 // æ£€æŸ¥å¹¶ç¡®ä¿æŒ‰é’®çŠ¶æ€ä¸€è‡´æ€§çš„å‡½æ•°
 function ensureButtonStateConsistency() {
   const synthesizeBtn = document.getElementById('synthesize-btn');
   if (synthesizeBtn) {
     // å¦‚æœæŒ‰é’®æ˜¾ç¤ºä¸ºåŠ è½½çŠ¶æ€ä½†æ²¡æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œåˆ™æ¢å¤æŒ‰é’®çŠ¶æ€
     const buttonText = synthesizeBtn.innerHTML;
     const isShowingLoadingState = buttonText.includes('loading-spinner') || 
                                  buttonText.includes('å¯åŠ¨ä»»åŠ¡') || 
                                  buttonText.includes('æ­£åœ¨åˆæˆ') || 
                                  buttonText.includes('ç­‰å¾…æ‰§è¡Œ') || 
                                  buttonText.includes('æ­£åœ¨å¤„ç†') || 
                                  buttonText.includes('å¤„ç†ä¸­');
     
     if (isShowingLoadingState) {
       console.log('[Button] æ£€æµ‹åˆ°æŒ‰é’®å¯èƒ½å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼Œå½“å‰æ–‡æœ¬:', buttonText);
       // å¯ä»¥æ·»åŠ é¢å¤–çš„é€»è¾‘æ¥åˆ¤æ–­æ˜¯å¦çœŸçš„æœ‰ä»»åŠ¡åœ¨è¿›è¡Œ
       // è¿™é‡Œæš‚æ—¶è®°å½•çŠ¶æ€ï¼Œä¸è‡ªåŠ¨æ¢å¤ï¼Œé¿å…å¹²æ‰°æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
     }
   }
 }

 // å®šæœŸæ£€æŸ¥æŒ‰é’®çŠ¶æ€ä¸€è‡´æ€§ï¼ˆå¯é€‰çš„ä¿æŠ¤æªæ–½ï¼‰
 setInterval(ensureButtonStateConsistency, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

 // å¤„ç†éŸ³é¢‘åˆæˆæˆåŠŸçš„å‡½æ•°
 async function handleAudioSuccess(data, audioTitle) {
   // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€
   restoreSynthesizeButton();
   
   // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
   document.getElementById('audio-player-container').classList.remove('hidden');
   const audioPlayer = document.getElementById('audio-player');
   audioPlayer.src = data.audio_url;
   audioPlayer.style.display = 'block'; // ç¡®ä¿æ’­æ”¾å™¨å¯è§
   document.getElementById('audio-title').textContent = audioTitle || 'æœªå‘½åéŸ³é¢‘';
   
   // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€å’Œé…é¢ä¿¡æ¯
   const audioStatus = document.getElementById('audio-status');
   audioStatus.className = 'text-sm mt-1 text-center font-medium text-success';
   audioStatus.innerHTML = '';
   audioStatus.textContent = 'åˆæˆæˆåŠŸï¼';
   
   // å¦‚æœè¿”å›äº†é…é¢ä¿¡æ¯ï¼Œæ˜¾ç¤ºå‰©ä½™é…é¢
   if (data.remaining_quota !== undefined) {
     const quotaInfo = document.createElement('div');
     quotaInfo.className = 'text-xs mt-1 text-center text-info';
     quotaInfo.textContent = `å‰©ä½™é…é¢: ${Math.round(data.remaining_quota)} ç§’`;
     audioStatus.appendChild(quotaInfo);
     
     // åˆ·æ–°é…é¢æ˜¾ç¤ºåŒºåŸŸ
     const quotaInfoElement = document.getElementById('quota-info');
     if (quotaInfoElement && typeof htmx !== 'undefined') {
       htmx.trigger(quotaInfoElement, 'refresh');
     }
   }
   
   // å¯ç”¨ä¸‹è½½å’Œå‘å¸ƒæŒ‰é’®
   const downloadBtn = document.getElementById('download-btn');
   if (downloadBtn) {
     downloadBtn.disabled = false;
     downloadBtn.onclick = function() {
       const a = document.createElement('a');
       a.href = data.audio_url;
       a.download = (audioTitle || 'éŸ³é¢‘') + '.wav';
       document.body.appendChild(a);
       a.click();
       document.body.removeChild(a);
     };
   }
   
   const publishBtn = document.getElementById('publish-btn');
   if (publishBtn) {
     publishBtn.disabled = false;
     window.currentAudioSegmentId = data.audio_id;
     console.log("Setting audio segment ID:", window.currentAudioSegmentId);
     
     // é‡ç½®æŒ‰é’®ä¸ºæœªå‘å¸ƒçŠ¶æ€
     publishBtn.className = 'btn btn-success flex-1';
     publishBtn.innerHTML = `
       <i class="fas fa-check h-5 w-5 mr-1"></i>
       å‘å¸ƒ
     `;
     publishBtn.title = 'å‘å¸ƒ';
   }

   logState('Audio synthesized successfully');
 }

 // å¤„ç†éŸ³é¢‘åˆæˆé”™è¯¯çš„å‡½æ•°
 async function handleAudioError(errorMessage) {
   // æ¢å¤åˆæˆæŒ‰é’®çŠ¶æ€
   restoreSynthesizeButton();
   
   const audioStatus = document.getElementById('audio-status');
   audioStatus.className = 'text-sm mt-1 text-center font-medium text-error';
   audioStatus.innerHTML = '';
   
   // åˆ›å»ºé”™è¯¯æ¶ˆæ¯å®¹å™¨
   const errorContainer = document.createElement('div');
   errorContainer.className = 'alert alert-error shadow-lg mt-2 p-2';
   
   // æ·»åŠ é”™è¯¯å›¾æ ‡å’Œæ¶ˆæ¯
   errorContainer.innerHTML = `
     <div class="flex items-center">
       <i class="fas fa-times-circle h-5 w-5 mr-2"></i>
       <span class="text-sm">${errorMessage}</span>
     </div>
   `;
   
   // å°†é”™è¯¯å®¹å™¨æ·»åŠ åˆ°éŸ³é¢‘çŠ¶æ€åŒºåŸŸ
   audioStatus.appendChild(errorContainer);
   
   // å¦‚æœæ˜¯é…é¢ä¸è¶³é”™è¯¯ï¼Œæ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨å®¹å™¨ä»¥ä¾¿ç”¨æˆ·çœ‹åˆ°é”™è¯¯ä¿¡æ¯
   if (errorMessage && errorMessage.includes('é…é¢ä¸è¶³')) {
     document.getElementById('audio-player-container').classList.remove('hidden');
     // éšè—éŸ³é¢‘æ’­æ”¾å™¨æœ¬èº«ï¼Œåªæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
     const audioPlayer = document.getElementById('audio-player');
     audioPlayer.style.display = 'none';
     document.getElementById('audio-title').textContent = 'é…é¢ä¸è¶³';
   }
   
   logState('Audio synthesis failed: ' + errorMessage);
 }

 // æ·»åŠ  HTMX è¯·æ±‚å’Œå“åº”ç›‘å¬ (ä¿ç•™ä»¥å…¼å®¹å…¶ä»–HTMXåŠŸèƒ½)
 document.body.addEventListener('htmx:beforeRequest', function(evt) {
   console.log('HTMX beforeRequest:', {
     target: evt.detail.target?.id,
     path: evt.detail.path,
     verb: evt.detail.verb
   });
 });

 // ç›‘å¬HTMXå†…å®¹åŠ è½½å®Œæˆäº‹ä»¶ï¼Œæ›´æ–°å­—æ•°ç»Ÿè®¡
 document.body.addEventListener('htmx:afterSwap', function(evt) {
   // å¦‚æœæ˜¯TOCåŒºåŸŸçš„åŠ è½½ï¼ˆTOCå’Œpageséƒ½åŠ è½½åˆ°è¿™é‡Œï¼‰ï¼Œæ›´æ–°å­—æ•°ç»Ÿè®¡
   if (evt.detail.target && evt.detail.target.id === 'toc') {
     // å»¶è¿Ÿè¾ƒé•¿æ—¶é—´ï¼Œç¡®ä¿TOC/pagesç»„ä»¶çš„JavaScriptå·²æ‰§è¡Œå®Œæˆ
     setTimeout(updateWordCount, 200);
   }
 });

 // åˆ›å»ºä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œä¾›TOCå’Œpagesè°ƒç”¨æ¥æ›´æ–°å­—æ•°
 window.triggerWordCountUpdate = function() {
   setTimeout(updateWordCount, 10);
 };

 // å®šæœŸæ£€æŸ¥textareaå€¼å˜åŒ–ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
 function setupPeriodicCheck() {
   const textarea = document.getElementById('src-text');
   if (textarea && !window._periodicCheckSetup) {
     window._periodicCheckSetup = true;
     
     setInterval(function() {
       const currentValue = textarea.value;
       const currentLength = currentValue.replace(/\s/g, '').length;
       
       // ä½¿ç”¨å…±äº«çš„çŠ¶æ€å˜é‡ï¼Œé¿å…é‡å¤è§¦å‘
       if (currentValue !== lastTextValue) {
         console.log('[WordCount] å®šæœŸæ£€æŸ¥å‘ç°å˜åŒ–ï¼Œè§¦å‘æ›´æ–°');
         updateWordCount();
       }
     }, 2000); // æ”¹ä¸ºæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå‡å°‘é¢‘ç‡
   }
 }

 // æ‹¦æˆªjQueryçš„valæ–¹æ³•ï¼Œä¸“é—¨é’ˆå¯¹src-text textarea
 function interceptJQueryVal() {
   if (typeof $ !== 'undefined' && !window._jqueryValIntercepted) {
     window._jqueryValIntercepted = true;
     
     const originalVal = $.fn.val;
     $.fn.val = function(value) {
       const result = originalVal.apply(this, arguments);
       
       // å¦‚æœæ˜¯è®¾ç½®å€¼æ“ä½œï¼ˆæœ‰å‚æ•°ï¼‰
       if (arguments.length > 0) {
         // æ£€æŸ¥å½“å‰jQueryå¯¹è±¡æ˜¯å¦åŒ…å«src-textå…ƒç´ 
         const containsSrcText = this.filter('#src-text').length > 0 || this.is('#src-text');
         if (containsSrcText) {
           // å»¶è¿Ÿæ›´æ–°å­—æ•°ï¼Œç¡®ä¿DOMå·²æ›´æ–°
           setTimeout(updateWordCount, 50);
         }
       }
       
       return result;
     };
   }
 }

 // è‡ªåŠ¨æ’ç‰ˆç›¸å…³çš„å…¨å±€å˜é‡
 let formattedText = '';
 let formatEventSource = null;
 let isFormattingInProgress = false;
 let originalTextContent = '';

 // å®‰å…¨åœ°æ¸…ç†èµ„æºçš„å‡½æ•°
 function cleanupFormatting() {
   // å®‰å…¨åœ°å…³é—­äº‹ä»¶æº
   if (formatEventSource) {
     try {
       formatEventSource.close();
     } catch (e) {
       console.error('å…³é—­äº‹ä»¶æºæ—¶å‡ºé”™:', e);
     }
     formatEventSource = null;
   }
   
   // é‡ç½®çŠ¶æ€
   isFormattingInProgress = false;
   
   // æ¢å¤æŒ‰é’®çŠ¶æ€
   const formatBtn = document.getElementById('format-text-btn');
   if (formatBtn) {
     formatBtn.disabled = false;
     formatBtn.innerHTML = 'è‡ªåŠ¨æ’ç‰ˆ';
   }
   
   // å¦‚æœæ–‡æœ¬æ¡†æ˜¯ç©ºçš„ï¼Œä½†è¿‡ç¨‹ä¸­æ²¡æ”¶åˆ°ä»»ä½•å†…å®¹ï¼Œæ¢å¤åŸæ–‡æœ¬
   const textarea = document.getElementById('src-text');
   if (textarea && !formattedText && textarea.value.startsWith('æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆ')) {
     textarea.value = originalTextContent || '';
   }
   
   // æ›´æ–°å­—æ•°ç»Ÿè®¡
   updateWordCount();
 }
 
 // è‡ªåŠ¨æ’ç‰ˆæŒ‰é’®ç‚¹å‡»å¤„ç†
 const formatTextBtn = document.getElementById('format-text-btn');
 if (formatTextBtn) {
   formatTextBtn.addEventListener('click', function() {
     originalTextContent = document.getElementById('src-text').value;
     const formatBtn = this;
     
     if (!originalTextContent.trim()) {
       alert('è¯·å…ˆè¾“å…¥æˆ–åŠ è½½æ–‡æœ¬å†…å®¹');
       return;
     }
     
     // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     formatBtn.disabled = true;
     formatBtn.innerHTML = 'æ­£åœ¨æ’ç‰ˆ...';
     
     // å…³é—­ä»»ä½•å·²å­˜åœ¨çš„è¿æ¥
     cleanupFormatting();
     
     // é‡ç½®æ–‡æœ¬ç´¯ç§¯å˜é‡å’ŒçŠ¶æ€
     formattedText = '';
     isFormattingInProgress = true;
     
     // æ¸…ç©ºæ–‡æœ¬æ¡†å¹¶æ˜¾ç¤ºåˆå§‹æç¤º
     const textarea = document.getElementById('src-text');
     if (textarea) {
       textarea.value = 'æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆï¼Œè¯·ç¨å€™...';
       console.log('æ–‡æœ¬åŒºåŸŸå·²æ¸…ç©º');
     }

     try {
       // å»ºç«‹SSEè¿æ¥å¹¶å‘é€POSTè¯·æ±‚
       console.log('å‘é€POSTè¯·æ±‚å¹¶å»ºç«‹SSEè¿æ¥');
       
       // æ·»åŠ è¿›åº¦æ˜¾ç¤ºå˜é‡
       let progressCount = 0;
       const progressInterval = setInterval(() => {
         if (isFormattingInProgress) {
           progressCount = (progressCount + 1) % 4;
           const dots = '.'.repeat(progressCount);
           formatBtn.innerHTML = `æ’ç‰ˆä¸­${dots}`;
           
           // å¦‚æœæ²¡æœ‰æ”¶åˆ°ä»»ä½•æ ¼å¼åŒ–æ–‡æœ¬ï¼Œç»§ç»­æ˜¾ç¤ºç­‰å¾…æ¶ˆæ¯
           if (!formattedText && textarea) {
             textarea.value = `æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆï¼Œè¯·ç¨å€™${dots}`;
           }
         } else {
           clearInterval(progressInterval);
         }
       }, 500);
       
       // é¦–å…ˆåˆ›å»ºPOSTè¯·æ±‚å‘é€æ–‡æœ¬å†…å®¹
       fetch('{% url "reformat" %}', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/x-www-form-urlencoded',
           'X-CSRFToken': '{{ csrf_token }}'
         },
         body: new URLSearchParams({
           texts: originalTextContent
         })
       }).then(response => {
         // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
         if (!response.ok) {
           throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
         }
         
         // åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶æºè¯»å–æµå¼å“åº”ç»“æœ
         const reader = response.body.getReader();
         const decoder = new TextDecoder();
         
         // è¯»å–å“åº”æµ
         function readStream() {
           reader.read().then(({ done, value }) => {
             if (done) {
               console.log('æµè¯»å–å®Œæˆ');
               cleanupFormatting();
               return;
             }
             
             // å¤„ç†æ”¶åˆ°çš„æ•°æ®å—
             const chunk = decoder.decode(value, { stream: true });
             // ç®€åŒ–æ—¥å¿—ï¼Œé¿å…è¾“å‡ºå¤§é‡åŸå§‹æ•°æ®
             console.log('æ¥æ”¶åˆ°æ•°æ®å—...');
             
             // åˆ†å‰²SSEæ¶ˆæ¯
             const messages = chunk.split('\n\n');
             for (const message of messages) {
               if (!message.trim()) continue;
               
               // æå–äº‹ä»¶ç±»å‹å’Œæ•°æ®
               const eventMatch = message.match(/^event: (.+)$/m);
               
               // ä¿®æ”¹æ•°æ®æå–æ–¹å¼ï¼Œæ”¯æŒå¤šè¡Œå†…å®¹
               let dataContent = '';
               
               // æ£€æŸ¥äº‹ä»¶ç±»å‹
               if (eventMatch) {
                 const eventType = eventMatch[1];
                 console.log('å¤„ç†äº‹ä»¶ç±»å‹:', eventType);
                 
                 // æå–æ‰€æœ‰dataå¼€å¤´çš„è¡Œ
                 const dataLines = message.split('\n').filter(line => line.startsWith('data: '));
                 
                 // ä»æ¯è¡Œæå–æ•°æ®å†…å®¹ï¼ˆå»æ‰"data: "å‰ç¼€ï¼‰
                 if (dataLines.length > 0) {
                   dataContent = dataLines.map(line => line.substring(6)).join('\n');
                 }
                 
                 if (dataContent) {
                   if (eventType === 'message') {
                     // æ•°æ®å†…å®¹å³ä¸ºæ ¼å¼åŒ–åçš„æ–‡æœ¬ï¼Œæ— éœ€å†è§£æJSON
                     console.log('æ”¶åˆ°æ ¼å¼åŒ–æ–‡æœ¬:', dataContent.substring(0, 50) + '...');
                     
                     // ç´¯ç§¯æ ¼å¼åŒ–åçš„æ–‡æœ¬
                     formattedText += dataContent;
                     if (textarea) {
                       textarea.value = formattedText;
                       textarea.scrollTop = textarea.scrollHeight;
                       // æ›´æ–°å­—æ•°ç»Ÿè®¡
                       updateWordCount();
                     }
                   } else if (eventType === 'complete') {
                     console.log('æ ¼å¼åŒ–å®Œæˆ');
                   } else if (eventType === 'error') {
                     console.error('æ ¼å¼åŒ–é”™è¯¯:', dataContent);
                     alert('è‡ªåŠ¨æ’ç‰ˆå¤±è´¥: ' + dataContent);
                   }
                 }
               }
             }
             
             // ç»§ç»­è¯»å–æµ
             readStream();
           }).catch(error => {
             console.error('è¯»å–æµé”™è¯¯:', error);
             cleanupFormatting();
           });
         }
         
         // å¼€å§‹è¯»å–æµ
         readStream();
       }).catch(error => {
         console.error('å‘é€æ–‡æœ¬é”™è¯¯:', error);
         cleanupFormatting();
         alert('è‡ªåŠ¨æ’ç‰ˆå¤±è´¥: ' + error.message);
       });
     } catch (error) {
       console.error('æ•è·åˆ°çš„é”™è¯¯:', error);
       cleanupFormatting();
     }
   });
 }

 // Toast é€šçŸ¥ç³»ç»Ÿ
 function showToast(message, type = 'info', duration = 3000) {
   // ç§»é™¤å·²å­˜åœ¨çš„toast
   const existingToast = document.getElementById('custom-toast');
   if (existingToast) {
     existingToast.remove();
   }
   
   // åˆ›å»ºtoastå…ƒç´ 
   const toast = document.createElement('div');
   toast.id = 'custom-toast';
   toast.className = `alert shadow-lg fixed top-4 right-4 z-50 max-w-sm transform transition-all duration-300 ease-in-out`;
   
   // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼å’Œå›¾æ ‡
   let alertClass, icon;
   switch (type) {
     case 'success':
       alertClass = 'alert-success';
       icon = `<i class="fas fa-check-circle h-6 w-6"></i>`;
       break;
     case 'error':
       alertClass = 'alert-error';
       icon = `<i class="fas fa-times-circle h-6 w-6"></i>`;
       break;
     case 'warning':
       alertClass = 'alert-warning';
       icon = `<i class="fas fa-exclamation-triangle h-6 w-6"></i>`;
       break;
     default:
       alertClass = 'alert-info';
       icon = `<i class="fas fa-info-circle h-6 w-6"></i>`;
   }
   
   toast.className += ` ${alertClass}`;
   toast.innerHTML = `
     <div>
       ${icon}
       <span>${message}</span>
     </div>
     <button class="btn btn-sm btn-ghost" onclick="this.parentElement.remove()">âœ•</button>
   `;
   
   // æ·»åŠ åˆ°é¡µé¢
   document.body.appendChild(toast);
   
   // æ˜¾ç¤ºåŠ¨ç”»
   setTimeout(() => {
     toast.style.transform = 'translateX(0)';
   }, 10);
   
   // è‡ªåŠ¨ç§»é™¤
   setTimeout(() => {
     if (toast.parentElement) {
       toast.style.transform = 'translateX(100%)';
       setTimeout(() => {
         if (toast.parentElement) {
           toast.remove();
         }
       }, 300);
     }
   }, duration);
 }

 // å‘å¸ƒæŒ‰é’®ç‚¹å‡»å¤„ç†å‡½æ•°
 async function handlePublishClick() {
   const publishBtn = document.getElementById('publish-btn');
   const publishStatus = document.getElementById('publish-status');
   
   if (!window.currentAudioSegmentId) {
     showToast('æ²¡æœ‰å¯å‘å¸ƒçš„éŸ³é¢‘ç‰‡æ®µ', 'warning');
     return;
   }
   
   // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   const originalContent = publishBtn.innerHTML;
   publishBtn.disabled = true;
   publishBtn.innerHTML = `
     <span class="loading loading-spinner loading-xs"></span>
     å¤„ç†ä¸­...
   `;
   
   try {
     const response = await fetch(`/workbench/audio/publish/${window.currentAudioSegmentId}/`, {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'X-CSRFToken': '{{ csrf_token }}'
       }
     });
     
     const data = await response.json();
     
     if (data.status === 'success') {
       // æ›´æ–°æŒ‰é’®çŠ¶æ€
       updatePublishButton(data);
       
       // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
       showToast(data.message, 'success');
       
       // æ›´æ–°å‘å¸ƒçŠ¶æ€æ˜¾ç¤º
       if (publishStatus) {
         publishStatus.className = 'text-sm mt-1 text-center font-medium text-success';
         publishStatus.innerHTML = `
           <div class="flex items-center justify-center">
             <i class="fas fa-check h-4 w-4 mr-1"></i>
             ${data.published ? 'å·²å‘å¸ƒ' : 'å·²å–æ¶ˆå‘å¸ƒ'}
           </div>
         `;
       }
     } else {
       // æ¢å¤æŒ‰é’®çŠ¶æ€
       publishBtn.disabled = false;
       publishBtn.innerHTML = originalContent;
       
       // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
       showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
       
       // æ›´æ–°å‘å¸ƒçŠ¶æ€æ˜¾ç¤º
       if (publishStatus) {
         publishStatus.className = 'text-sm mt-1 text-center font-medium text-error';
         publishStatus.innerHTML = `
           <div class="flex items-center justify-center">
             <i class="fas fa-times h-4 w-4 mr-1"></i>
             æ“ä½œå¤±è´¥
           </div>
         `;
       }
     }
   } catch (error) {
     console.error('å‘å¸ƒæ“ä½œå¤±è´¥:', error);
     
     // æ¢å¤æŒ‰é’®çŠ¶æ€
     publishBtn.disabled = false;
     publishBtn.innerHTML = originalContent;
     
     // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
     showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
     
     // æ›´æ–°å‘å¸ƒçŠ¶æ€æ˜¾ç¤º
     if (publishStatus) {
       publishStatus.className = 'text-sm mt-1 text-center font-medium text-error';
       publishStatus.innerHTML = `
         <div class="flex items-center justify-center">
           <i class="fas fa-times h-4 w-4 mr-1"></i>
           ç½‘ç»œé”™è¯¯
         </div>
       `;
     }
   }
 }

 // æ›´æ–°å‘å¸ƒæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
 function updatePublishButton(data) {
   const publishBtn = document.getElementById('publish-btn');
   if (!publishBtn) return;
   
   publishBtn.disabled = false;
   
   if (data.published) {
     // å·²å‘å¸ƒçŠ¶æ€ - æ˜¾ç¤ºå–æ¶ˆå‘å¸ƒæŒ‰é’®
     publishBtn.className = 'btn btn-warning flex-1';
     publishBtn.innerHTML = `
       <i class="fas fa-times h-5 w-5 mr-1"></i>
       å–æ¶ˆå‘å¸ƒ
     `;
     publishBtn.title = 'å–æ¶ˆå‘å¸ƒ';
   } else {
     // æœªå‘å¸ƒçŠ¶æ€ - æ˜¾ç¤ºå‘å¸ƒæŒ‰é’®
     publishBtn.className = 'btn btn-success flex-1';
     publishBtn.innerHTML = `
       <i class="fas fa-check h-5 w-5 mr-1"></i>
       å‘å¸ƒ
     `;
     publishBtn.title = 'å‘å¸ƒ';
   }
 }
</script>

{% endblock %}
