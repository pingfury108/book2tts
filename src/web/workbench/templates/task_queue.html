{% extends "base.html" %}

{% block title %}ä»»åŠ¡é˜Ÿåˆ— - Book2TTS{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">ä»»åŠ¡é˜Ÿåˆ—</h1>
        <div class="text-sm text-gray-600">
            å…± {{ stats.total }} ä¸ªä»»åŠ¡
        </div>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stat bg-base-200 rounded-lg p-4">
            <div class="stat-title">æ€»ä»»åŠ¡æ•°</div>
            <div class="stat-value text-primary">{{ stats.total }}</div>
        </div>
        <div class="stat bg-base-200 rounded-lg p-4">
            <div class="stat-title">è¿›è¡Œä¸­</div>
            <div class="stat-value text-warning">{{ stats.processing }}</div>
        </div>
        <div class="stat bg-base-200 rounded-lg p-4">
            <div class="stat-title">å·²å®Œæˆ</div>
            <div class="stat-value text-success">{{ stats.success }}</div>
        </div>
        <div class="stat bg-base-200 rounded-lg p-4">
            <div class="stat-title">å¤±è´¥</div>
            <div class="stat-value text-error">{{ stats.failure }}</div>
        </div>
    </div>
    
    <!-- æ ‡ç­¾é¡µ - ä¼˜åŒ–ç§»åŠ¨ç«¯å“åº”å¼ -->
    <div class="mb-6">
        <!-- æ¡Œé¢ç«¯ï¼šæ¨ªå‘æ ‡ç­¾é¡µ -->
        <div class="hidden sm:block">
            <div class="tabs tabs-boxed">
                <a class="tab {% if current_status == 'all' %}tab-active{% endif %}" href="?status=all">
                    å…¨éƒ¨ ({{ stats.total }})
                </a>
                <a class="tab {% if current_status == 'processing' %}tab-active{% endif %}" href="?status=processing">
                    è¿›è¡Œä¸­ ({{ stats.processing }})
                </a>
                <a class="tab {% if current_status == 'success' %}tab-active{% endif %}" href="?status=success">
                    å·²å®Œæˆ ({{ stats.success }})
                </a>
                <a class="tab {% if current_status == 'failure' %}tab-active{% endif %}" href="?status=failure">
                    å¤±è´¥ ({{ stats.failure }})
                </a>
            </div>
        </div>
        
        <!-- ç§»åŠ¨ç«¯ï¼šç½‘æ ¼å¸ƒå±€ -->
        <div class="block sm:hidden">
            <div class="grid grid-cols-2 gap-2">
                <a class="btn btn-sm {% if current_status == 'all' %}btn-primary{% else %}btn-outline{% endif %}" href="?status=all">
                    å…¨éƒ¨ ({{ stats.total }})
                </a>
                <a class="btn btn-sm {% if current_status == 'processing' %}btn-primary{% else %}btn-outline{% endif %}" href="?status=processing">
                    è¿›è¡Œä¸­ ({{ stats.processing }})
                </a>
                <a class="btn btn-sm {% if current_status == 'success' %}btn-primary{% else %}btn-outline{% endif %}" href="?status=success">
                    å·²å®Œæˆ ({{ stats.success }})
                </a>
                <a class="btn btn-sm {% if current_status == 'failure' %}btn-primary{% else %}btn-outline{% endif %}" href="?status=failure">
                    å¤±è´¥ ({{ stats.failure }})
                </a>
            </div>
        </div>
    </div>
    
    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <div class="space-y-4">
        {% for task in tasks %}
        <div class="card bg-base-100 shadow-md border" data-task-id="{{ task.task_id }}">
            <div class="card-body">
                <!-- ç§»åŠ¨ç«¯ï¼šä¸Šä¸‹å¸ƒå±€ï¼Œæ¡Œé¢ç«¯ï¼šå·¦å³å¸ƒå±€ -->
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                    <div class="flex-1">
                        <h3 class="card-title text-lg">
                            {% if task.book %}
                                <span class="text-primary">{{ task.book.name }}</span>
                                {% if task.title %} - {{ task.title }}{% endif %}
                            {% else %}
                                {{ task.title|default:"éŸ³é¢‘åˆæˆä»»åŠ¡" }}
                            {% endif %}
                        </h3>
                        
                        <div class="text-sm text-gray-600 mt-2">
                            <!-- ç§»åŠ¨ç«¯ï¼šå‚ç›´å¸ƒå±€ï¼Œæ¡Œé¢ç«¯ï¼šæ°´å¹³å¸ƒå±€ -->
                            <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4">
                                <span class="break-all sm:break-normal">ä»»åŠ¡ID: {{ task.task_id }}</span>
                                <span>åˆ›å»º: {{ task.created_at|date:"m-d H:i" }}</span>
                                {% if task.completed_at %}
                                    <span>å®Œæˆ: {{ task.completed_at|date:"m-d H:i" }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- ä»»åŠ¡è¯¦æƒ… -->
                        {% if task.metadata %}
                        <div class="mt-3">
                            <details class="collapse collapse-arrow bg-base-200">
                                <summary class="collapse-title text-sm font-medium">ä»»åŠ¡è¯¦æƒ…</summary>
                                <div class="collapse-content text-sm">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                                        {% if task.metadata.voice_name %}
                                            <div><strong>è¯­éŸ³:</strong> {{ task.metadata.voice_name }}</div>
                                        {% endif %}
                                        {% if task.metadata.text_length %}
                                            <div><strong>æ–‡æœ¬é•¿åº¦:</strong> {{ task.metadata.text_length }} å­—ç¬¦</div>
                                        {% endif %}
                                        {% if task.metadata.estimated_duration %}
                                            <div><strong>é¢„ä¼°æ—¶é•¿:</strong> {{ task.metadata.estimated_duration }} ç§’</div>
                                        {% endif %}
                                        {% if task.metadata.book_page %}
                                            <div><strong>é¡µé¢:</strong> {{ task.metadata.book_page }}</div>
                                        {% endif %}
                                    </div>
                                    {% if task.metadata.text %}
                                        <div class="mt-2">
                                            <strong>æ–‡æœ¬å†…å®¹:</strong>
                                            <div class="bg-base-300 p-2 rounded mt-1 max-h-32 overflow-y-auto text-xs">
                                                {{ task.metadata.text|truncatechars:200 }}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </details>
                        </div>
                        {% endif %}
                        
                        <!-- è¿›åº¦ä¿¡æ¯ -->
                        {% if task.progress_message %}
                        <div class="mt-3 p-3 bg-base-200 rounded text-sm">
                            <strong>çŠ¶æ€:</strong> {{ task.progress_message }}
                        </div>
                        {% endif %}
                        
                        <!-- é”™è¯¯ä¿¡æ¯ -->
                        {% if task.error_message %}
                        <div class="mt-3 p-3 bg-error bg-opacity-10 border border-error rounded text-sm">
                            <strong class="text-error">é”™è¯¯:</strong> {{ task.error_message }}
                        </div>
                        {% endif %}
                        
                        <!-- ç»“æœä¿¡æ¯ -->
                        {% if task.result_data and task.status == 'success' %}
                        <div class="mt-3 p-3 bg-success bg-opacity-10 border border-success rounded text-sm">
                            <strong class="text-success">ç»“æœ:</strong>
                            <div class="mt-1">
                                {% if task.result_data.audio_url %}
                                    <a href="{{ task.result_data.audio_url }}" class="link link-primary" target="_blank">
                                        ğŸµ æ’­æ”¾éŸ³é¢‘
                                    </a>
                                {% endif %}
                                {% if task.result_data.audio_duration %}
                                    <span class="ml-4">æ—¶é•¿: {{ task.result_data.audio_duration }} ç§’</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- çŠ¶æ€å’Œæ“ä½œæŒ‰é’® - ä¼˜åŒ–ç§»åŠ¨ç«¯å¸ƒå±€ -->
                    <div class="flex sm:flex-col justify-between sm:justify-start sm:items-end gap-3">
                        <!-- çŠ¶æ€æ ‡ç­¾ -->
                        <div class="badge 
                            {% if task.status == 'pending' %}badge-warning
                            {% elif task.status == 'processing' %}badge-info
                            {% elif task.status == 'success' %}badge-success
                            {% elif task.status == 'failure' %}badge-error
                            {% elif task.status == 'revoked' %}badge-neutral
                            {% else %}badge-ghost{% endif %} text-xs sm:text-sm">
                            {% if task.status == 'pending' %}ç­‰å¾…ä¸­
                            {% elif task.status == 'processing' %}å¤„ç†ä¸­
                            {% elif task.status == 'success' %}å·²å®Œæˆ
                            {% elif task.status == 'failure' %}å¤±è´¥
                            {% elif task.status == 'revoked' %}å·²å–æ¶ˆ
                            {% else %}{{ task.status }}{% endif %}
                        </div>
                        
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex gap-1 sm:gap-2">
                            {% if task.status in 'pending,processing' %}
                                <button class="btn btn-warning btn-xs sm:btn-sm" 
                                        onclick="cancelTask('{{ task.task_id }}')"
                                        title="å–æ¶ˆä»»åŠ¡">
                                    <span class="hidden sm:inline">âœ• å–æ¶ˆ</span>
                                    <span class="sm:hidden">âœ•</span>
                                </button>
                            {% endif %}
                            
                            {% if task.status in 'pending,processing' %}
                                <button class="btn btn-info btn-xs sm:btn-sm" 
                                        onclick="refreshTask('{{ task.task_id }}')"
                                        title="åˆ·æ–°çŠ¶æ€">
                                    <span class="hidden sm:inline">ğŸ”„ åˆ·æ–°</span>
                                    <span class="sm:hidden">ğŸ”„</span>
                                </button>
                            {% endif %}
                            
                            {% if task.is_finished %}
                                <button class="btn btn-error btn-xs sm:btn-sm" 
                                        onclick="deleteTask('{{ task.task_id }}')"
                                        title="åˆ é™¤è®°å½•">
                                    <span class="hidden sm:inline">ğŸ—‘ï¸ åˆ é™¤</span>
                                    <span class="sm:hidden">ğŸ—‘ï¸</span>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">ğŸ“‹</div>
            <h3 class="text-xl font-medium mb-2">æš‚æ— ä»»åŠ¡</h3>
            <p class="text-gray-600">
                {% if current_status == 'all' %}
                    æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä»»åŠ¡
                {% elif current_status == 'processing' %}
                    å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡
                {% elif current_status == 'success' %}
                    æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡
                {% elif current_status == 'failure' %}
                    æ²¡æœ‰å¤±è´¥çš„ä»»åŠ¡
                {% endif %}
            </p>
            <a href="{% url 'index' %}" class="btn btn-primary mt-4">å¼€å§‹åˆ¶ä½œéŸ³é¢‘</a>
        </div>
        {% endfor %}
    </div>
    
    <!-- åˆ†é¡µ -->
    {% if page_obj.has_other_pages %}
    <div class="flex justify-center mt-8">
        <div class="join">
            {% if page_obj.has_previous %}
                <a href="?status={{ current_status }}&page={{ page_obj.previous_page_number }}" 
                   class="join-item btn btn-sm">Â«</a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="join-item btn btn-sm btn-active">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?status={{ current_status }}&page={{ num }}" 
                       class="join-item btn btn-sm">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?status={{ current_status }}&page={{ page_obj.next_page_number }}" 
                   class="join-item btn btn-sm">Â»</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function cancelTask(taskId) {
    if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
    
    fetch(`/workbench/task/cancel/${taskId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('å–æ¶ˆä»»åŠ¡å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('å–æ¶ˆä»»åŠ¡å¤±è´¥');
    });
}

function deleteTask(taskId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡è®°å½•å—ï¼Ÿ')) return;
    
    fetch(`/workbench/task/delete/${taskId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // ç§»é™¤DOMå…ƒç´ 
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.remove();
            }
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('åˆ é™¤å¤±è´¥');
    });
}

function refreshTask(taskId) {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';
    button.disabled = true;
    
    fetch(`/workbench/task-status/${taskId}/`)
    .then(response => response.json())
    .then(data => {
        // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('åˆ·æ–°å¤±è´¥');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 